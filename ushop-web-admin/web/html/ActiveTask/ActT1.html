<!-- 任务片段文件 -->
<!-- 日常任务，常规任务等 -->
<form class="form-horizontal" id="task_from_box" onsubmit="return false;" role="form">
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>任务条件：</label>
		<div class="col-xs-8">
			<select name="conditionType" class="form-control taskConditionList add_form_ipt" data-null="请选择任务条件" onchange="ctypeChangeFn(this)"></select>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>活动名称：</label>
		<div class="col-xs-8">
			<input type="text" name="name" class="form-control add_form_ipt" data-null="请输入活动名称" placeholder="请输入活动名称">
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>开始-结束时间：</label>
		<div class="col-xs-8">
			<div class="input-group">
				<input type="text" data-null="请选择开始时间" class="form-control add_form_ipt text-center form_datetime start" name="startDate" readonly placeholder="开始时间">
				<span class="input-group-addon">至</span>
				<input type="text" data-null="请选择结束时间" class="form-control add_form_ipt text-center form_datetime end" name="endDate" readonly placeholder="结束时间">
			</div>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>可参与次数：</label>
		<div class="col-xs-8">
			<input type="number" name="participateTime" data-null="请输入可参与次数" placeholder="请输入可参与次数" class="form-control add_form_ipt" style="width: 60%;float:left;">
			<select name="participateType" class="form-control participateTypeList add_form_ipt" data-null="请选择参与次数类型" style="width: 40%; border-left: 0;float:left;"></select>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>目标类型：</label>
		<div class="col-xs-8">
			<select name="targetType" data-null="请选择目标类型" class="form-control add_form_ipt taskTargetTypeList"></select>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>目标数量：</label>
		<div class="col-xs-8">
			<input type="number" name="conditionValue" data-null="请输入目标数量" class="form-control add_form_ipt" placeholder="请输入目标数量">
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>目标ID：</label>
		<div class="col-xs-8">
			<input type="text" name="conditionId" data-null="请输入游戏ID" class="form-control add_form_ipt" placeholder="请输入游戏ID">
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>省份：</label>
		<div class="col-xs-8">
			<select name="province" data-null="请选择省份" class="form-control provinceList add_form_ipt"></select>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>用途：</label>
		<div class="col-xs-8">
			<select name="usage" data-null="请选择用途" class="form-control fundUsageList add_form_ipt"></select>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>是否额外奖励：</label>
		<div class="col-xs-8">
			<div class="radio add_form_radio">
				<label>
					<input name="extraReward" checked value="0" type="radio" class="ace">
					<span class="lbl"> 否</span>
				</label>
				<label>
					<input name="extraReward" value="1" type="radio" class="ace">
					<span class="lbl"> 是</span>
				</label>
			</div>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>奖励模式：</label>
		<div class="col-xs-8">
			<div class="radio add_form_radio">
				<label>
					<input name="rewardType" onchange="reTypeChange()" checked value="1" type="radio" class="ace">
					<span class="lbl"> 固定模式</span>
				</label>
				<label>
					<input name="rewardType" onchange="reTypeChange()" value="2" type="radio" class="ace">
					<span class="lbl"> 随机模式</span>
				</label>
			</div>
		</div>
	</div>
	<div class="form-group">
		<label class="control-label col-xs-3"><span class="red">*</span>奖励规则：</label>
		<div class="col-xs-8 rewardValue"></div>
	</div>
	<div class="form-group from_btn_box">
		<div class="col-xs-3"></div>
		<div class="col-xs-4">
			<button class="btn btn-block" onclick="pageSH('.page_box', '#task_list')">返回</button>
		</div>
		<div class="col-xs-4">
			<button class="btn btn-block btn-success" onclick="onAESubmit()">提交</button>
		</div>
	</div>
</form>
<script>
"use strict";
;(function () {
	selectInitFn(globalData.taskConditionList, 'desc', 'value', '.taskConditionList');
	selectInitFn(globalData.participateTypeList, 'desc', 'value', '.participateTypeList');
	selectInitFn(globalData.taskTargetTypeList, 'desc', 'value', '.taskTargetTypeList');
	selectInitFn(globalData.provinceList, 'desc', 'value', '.provinceList');
	selectInitFn(globalData.fundUsageList, 'desc', 'value', '.fundUsageList');
	fixedRvStr(); // 默认呈现固定值奖励模式
	globalData.avlData = []; // 用于记录奖励值
	//日期选择器绑定
	$('.form_datetime').each(function () {
		laydate.render({
		  elem: this,
		  type: 'datetime'
		});
	})
})();


// 获取表单值
function getFromVal () {
	var $form = $('#task_from_box'),
		$me, k, v,
		$avlBox,
		p = {};
	$form.find('.add_form_ipt').each(function() {
		$me = $(this);
		k = $me.attr('name');
		v = $me.val();
		p[k] = v;
	});
	$form.find('.add_form_radio').each(function () {
		$me = $(this).find('input:checked');
		k = $me.attr('name');
		v = $me.val();
		p[k] = v;
		if ( k === 'rewardType' ) {
			$avlBox = $form.find('.rewardValue');
			if ( v === '1' ) { //固定模式
				p['rewardValue'] = (function () {
					var at = $avlBox.find('.awardType').val(),
						av = getFAV ($avlBox.find('.awardValue')).val;
					if ( at && av ) {
						return [{
							awardType: at,
							awardValue: av
						}];
					}
					return '';
				})();
			} else if ( v === '2' ) { //随机模式
				p['rewardValue'] = (function() {
					if ( !globalData.avlData[0] ) {
						return '';
					}
					var arr = [];
					$.each(globalData.avlData, function　( index, obj ){
						arr[index] = {};
						$.each(obj, function ( kk, kv ) {
							arr[index][kk] = kv.val;
						});
					});
					return arr;
				})();
			}
		}
	});
	return p;
}

//编辑或添加的表单验证
function fromValid ( p ) {
	var $form = $('#task_from_box'),
		$me;
	if(!(p || $.isEmptyObject(p))) {
		return false;
	}
	//数据是否为空的验证
	var isTrue = true;
	$.each(p, function(k, v) {
		$me = $form.find('[name="' + k + '"]');
		if ( !v ) {
			if( k === 'rewardValue' ) {
				if ( p.rewardType === '1' ) { // 固定奖励
					Common.jBoxNotice('请完善奖励规则', 'red');
					isTrue = false;
				} else if ( p.rewardType === '2' ) { // 随机奖励
					Common.jBoxNotice('请添加奖励规则', 'red');
					$('#reward_value').modal('show');
					isTrue = false;
				}
			} else if ( $me[0] && $me.is(':visible') ) {
				bootsToast($me, '<span style="color: #ff961a">' + $me.attr('data-null') + '</span>');
				isTrue = false;
			}
		} else if (k === 'endDate' ) {
			if ( parseInt(p.startDate.replace(/\D/g, '')) >= p.endDate.replace(/\D/g, '') ) {
				$me = $form.find('[name="startDate"]');
				bootsToast($me, '<span style="color: #ff961a">起始时间必须小于结束时间</span>');
				isTrue = false;
			}
		}
		if ( !isTrue ) {
			return false;
		}
	});
	return isTrue;
}


// 表单赋值
function fromAssignment ( p ) {
	var $form = $('#task_from_box'),
		$me;
	$.each(p, function( k, v ) {
		$me = $form.find('[name="' + k + '"]');
		if ( k === 'rewardValue' ) {
			// 不做任何处理
		} else {
			$me.val(v);
		}
	});
	var v = p.rewardValue;
	if ( (p.rewardType + '') === '1' ) { // 固定奖励html
		fixedRvStr(JSON.parse(v));
	} else if ( (p.rewardType + '') === '2' ) { // 随机奖励
		globalData.avlData = (function () {
			v = JSON.parse(v);
			var arr = [];
			$.each(v, function ( index, obj ) {
				arr[index] = {};
				$.each(obj, function ( kk, kv ) {
					arr[index][kk] = {
						val: kv,
						txt: kv
					}
				});
			});
			return arr;
		})();
		randomRvStr(globalData.avlData);
	}
	ctypeChangeFn(p.conditionType); // 任务条件切换
}


// 奖励模式改变
function reTypeChange () {
	var $form = $('#task_from_box');
	var val = $form.find('[name="rewardType"]:checked').val();
	if( !globalData.avlData[0] && (val === '2') ) {
		$('#reward_value').modal('show');
	}
	if ( val === '1' ) { // 固定奖励html
		fixedRvStr();
	} else if ( val === '2' ) { // 随机奖励
		randomRvStr();
	}
}

// 固定奖励html
function fixedRvStr ( arr ) {
	var $form = $('#task_from_box'),
		str = '';
	var obj = (arr && arr[0]) || {},
		sv = obj.awardType || '', // 奖励类型
		iv = obj.awardValue || ''; // 奖励值
	str =
		'<div class="form-group">' +
		'<label class="control-label col-xs-4"><span class="red">*</span>奖励类型：</label>' +
		'<div class="col-xs-8">' +
		'<select class="form-control awardType" onchange="awardTypeChange(this)">' +
		selectInitFn(globalData.awardTypeList, 'desc', 'value', '', sv) +
		'</select>' +
		'</div>' +
		'</div>' +
		'<div class="form-group">' +
		'<label class="control-label col-xs-4"><span class="red">*</span>奖励值：</label>' +
		'<div class="col-xs-8"></div>' +
		'</div>';
	$form.find('div.rewardValue').html(str);
	awardTypeChange($form.find('.awardType')[0], iv); // 赋值奖励值
}

// 随机奖励
function randomRvStr ( arr ) {
	var $form = $('#task_from_box'),
		str = '';
	if ( !(arr && arr[0]) ) {
		$form.find('div.rewardValue').html('<button class="btn btn-success" onclick="addAvlObj()">新增</button>');
		return false;
	}
	$.each(arr, function(index, obj) {
		str +=
			'<tr>' +
			'<td title="' + obj.awardType.txt + '">' + obj.awardType.txt + '</td>' +
			'<td title="' + obj.awardValue.txt + '">' + obj.awardValue.txt + '</td>' +
			'<td title="' + obj.probability.txt + '">' + obj.probability.txt + '</td>' +
			'<td title="' + obj.winLimitType.txt + '">' + obj.winLimitType.txt + '</td>' +
			'<td title="' + obj.winLimitValue.txt + '">' + obj.winLimitValue.txt + '</td>' +
			'<td title="' + obj.stockLimitType.txt + '">' + obj.stockLimitType.txt + '</td>' +
			'<td title="' + obj.stockLimitValue.txt + '">' + obj.stockLimitValue.txt + '</td>' +
			'<td>' +
			' <button class="btn btn-sm btn-danger" onclick="deleteAvlObj(' + index + ')">删除</button>' +
			'</td>' +
			'</tr>';
	});
	str =
		'<div class="rv_table_box">'+
		'<table class="table table-striped table-bordered table-hover">' +
		'<thead class="thin-border-bottom">' +
		'<tr><th>奖励类型</th><th>奖励值</th><th>概率</th><th>中奖限制</th><th>最多中奖</th><th>库存限制</th><th>最多产出</th><th width="130">操作</th></tr>' +
		'</thead>' +
		'<tbody>' +
		str +
		'</tbody>' +
		'</table>' +
		'<button class="btn btn-success" onclick="addAvlObj()">新增</button>'+
		'</div>';
	$form.find('div.rewardValue').html(str);
}

//添加奖励规则
function addAvlObj() {
	$('#reward_value').modal('show');
}

//删除奖励规则
function deleteAvlObj(index) {
	globalData.avlData.splice(index, 1);
	randomRvStr(globalData.avlData);
}

//保存奖励内容，随机奖励
function saveAvlObj() {
	var $modal = $('#reward_value'),
		obj = getAvlVal();
	//数据验证
	if( !avlValidFn(obj) ) {
		return false;
	}
	globalData.avlData.push(obj);
	randomRvStr(globalData.avlData);
	$modal.modal('hide');
}

// 过去奖励规则的奖励值数据
function getAvlVal () {
	var $modal = $('#reward_value'),
		$me, v, txt, k, obj = {};
	$modal.find('.add_form_ipt').each(function() {
		$me = $(this);
		v = $me.val();
		k = $me.attr('name');
		txt = (this.tagName.toLowerCase() === 'select') ? $me.find('option:checked').text().trim() : v;
		obj[k] = {
			val: v,
			txt: txt
		};
		if(k === 'awardType') {
			obj['awardValue'] = getFAV ($modal.find('.awardValue'));
		}
	});
	return obj;
}

// 获取对应奖励值类型的奖励值
function getFAV (avele) {
	var a1 = avele.eq(0).val() || '',
		a2 = avele.eq(1).val() || '',
		a3 = '', a4 = '';
	if ( avele.length === 2 ) {
		if ( a1 && a2 ) {
			a3 = ( a1 + '|' + a2 );
			a4 = a1 + ' ' + $.trim(avele.find('option:checked').text())
		} else {
			a3 = '';
			a4 = a1;
		}
	} else {
		a3 = a1;
		a4 = a1;
	}
	return {
		val: a3,
		txt: a4
	};
}

//奖励规则数据验证
function avlValidFn(p) {
	var $modal = $('#reward_value'),
		$me;
	if(!(p || $.isEmptyObject(p))) {
		return false;
	}
	//数据是否为空的验证
	var isTrue = true; //默认值不是空
	$.each(p, function(k, v) {
		$me = $modal.find('[name="' + k + '"]');
		if ( !v.val ) {
			if ( k === 'awardValue' ) { //奖励值不定，所以单独列出
				Common.jBoxNotice('请完善奖励值', 'red');
				isTrue = false;
			} else {
				Common.jBoxNotice($me.attr('data-null'), 'red');
				isTrue = false;
			}
		} else if ( k === 'probability' ) {
			if ( !(parseInt(v.val) >= 0 && parseInt(v.val) <= 100) ) {
				Common.jBoxNotice('概率为0-100之间的数字', 'red');
				isTrue = false;
			}
		}
		if ( !isTrue ) {
			return false;
		}
	});
	return isTrue;
}

</script>
