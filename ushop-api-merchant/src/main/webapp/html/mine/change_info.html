<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>绑定手机号</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.disabledBtn {
	color: #888 !important;
	background: #ccc !important;
	opacity: 1 !important;
}

.xlform-p1 {
	position: relative;
	background: #fff;
	margin-bottom: 1px;
}
.xlform-p1 label {
	position: absolute;
	left: 0;
	top: 0;
	width: 3.8em;
	text-align: right;
	padding-top: .7em;
}
.xlform-p1 label img {
	height: 1.6em;
}
.xlform-p1 input {
	height: 3em;
	padding: .7em .5em;
	width: 100%;
	border: 0;
	background: none;
	padding-left: 4.2em;
}
.xlform-p1 .xlform-code {
	position: absolute;
	right: .8em;
	top: 50%;
	color: #fff;
	border: 0;
	background: #f88c32;
	margin-top: -1em;
	font-size: .8em;
	padding: .5em;
	line-height: 1;
	border-radius: .8em;
}
.xlform-p1 .xlform-code:active {
	opacity: 0.8;
}

.xlci-box1 {
	padding: .8em;
}
.xlci-btn {
	padding: 2em .5em;
}
.xlci-btn .xl-btn {
	font-size: 1.4em;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">绑定手机号</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlci-box1">为了提供更好的服务，建议您绑定你的手机号。</div>
	<form class="xlci-box2">
		<div class="xlform-p1">
			<label><img src="../../image/icon/phone.png"/></label>
			<input type="text" id="phoneNum" placeholder="请输入手机号">
		</div>
		<div class="xlform-p1">
			<label><img src="../../image/icon/hqyzm.png"/></label>
			<input type="number" id="phoneCode" placeholder="请输入验证码">
			<a class="xlform-code" onclick="gainCodeFn(this)">获取验证码</a>
		</div>
		<div class="xlform-p1">
			<label><img src="../../image/icon/pswtip.png"/></label>
			<input type="password" id="phonePwd" placeholder="请输入密码">
		</div>
		<input type="submit" class="hide" />
	</form>
	<div class="xlci-btn">
		<button class="xl-btn xl-btn-block" onclick="telNoSubmin()">绑定</button>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
	globalData.telNo = globalData.pageParam.telNo;
}
//dom事件绑定
function domEventFn(){
	$('form').eq(0).on('submit', function(){
		telNoSubmin();
		return false;
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//刷新数据请求函数
}


//手机号修改提交函数
function telNoSubmin(){
	var phoneNum = document.getElementById('phoneNum'),
		phonePwd = document.getElementById('phonePwd'),
		phoneCode = document.getElementById('phoneCode'),
		valN = phoneNum.value,
		valC = phoneCode.value,
		valP = phonePwd.value;
	if(!valN){
		Common.toast('请输入新的手机号');
		phoneNum.focus();
		return false;
	}
	if(!valC){
		Common.toast('请输入验证码');
		phoneCode.focus();
		return false;
	}
	if(!valP){
		Common.toast('请输入密码');
		phonePwd.focus();
		return false;
	}
	if(valN == globalData.telNo){
		Common.toast('新手机号不能与旧手机号相同');
		phoneNum.focus();
		return false;
	}
	if(!(Common.regExpPhone.test(valN))){
		Common.toast('请输入正确的手机号');
		phoneNum.focus();
		return false;
	}
	if(!(Common.regExpCode.test(valC))){
		Common.toast('验证码为6位纯数字');
		phoneCode.focus();
		return false;
	}
	if(!(Common.regExpPwd.test(valP))){
		Common.toast('密码为6-15位数字和字母混合');
		phonePwd.focus();
		return false;
	}
	var _url = '/ushop-api-merchant/api/user/profile/bindPhonePassword/' + valN + '/' + valC + '/' + hex_md5(valP);
	Common.ajax(_url, 'post', {}, function(data){
    	if(data.userNo){
    		Common.userInfoL({telNo: valN});
    		Common.toast('操作成功！');
    		history.go(-1);
    	}
	});
}


//发送验证码的按键点击事件
//验证功能类型
//me为当前点击的元素
function gainCodeFn(me){
	var $me = $(me),
		phoneNum = $('#phoneNum'),
		valN = phoneNum.val();
	if($me.hasClass('disabledBtn')){
		return false;
	}
	if(!(Common.regExpPhone.test(valN))){
		Common.toast("请输入正确的手机号");
		phoneNum.focus();
		return false;
	}
	if(valN == globalData.telNo){
		Common.toast('新手机号不能与旧手机号相同');
		return false;
	}
	$me.addClass('disabledBtn');
	var typeNo = userCodeNote.bindPhone;
	if(globalData.telNo){typeNo = userCodeNote.changePhone;}
	var _url = Common.domainUrl + '/ushop-api-merchant/api/sns/mobile/verify/sendCode/' + valN + '/' + typeNo;
	Common.ajax(_url, 'post', {}, function(data){
    	if(data.result == '1'){//发送成功后计时，并且按键无法点击
    		countdownFn(me);
    		Common.toast('发送成功');
    	}else{
    		me.classList.remove('disabledBtn');
    		Common.toast('发送失败');
    	}
	});
}

//倒计时按键
//me显示内容的元素对象DOM对象，必填
//timeNum 计时的时间num，可选默认为60
//className 计时期间添加的类名，str，可选默认为disabledBtn
function countdownFn(me, timeNum, className){
	var timeNum = timeNum ? parseInt(timeNum) : 60,
		className = className || 'disabledBtn',
		$me = $(me);
	$me.addClass(className).html(timeNum + 's后可重发');
	clearInterval(globalData.pwdInterval);
	globalData.pwdInterval = setInterval(function(){
		timeNum--;
		if(timeNum < 0){
			clearInterval(globalData.pwdInterval);
			$me.removeClass(className).html('重新发送');
			return false;
		}
		$me.html(timeNum + 's后可重发');
	},1000);
}
</script>
</body>
</html>
