<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>卡包</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 36px;
	text-align: center;
	font-size: 15px;
}
.xl-tab-title .xl-tab-hitem {
	float: left;
	width: 33.3333%;
	color: #626262;
}
.xl-tab-title .xl-tab-hitem span {
	position: relative;
	width: 55px;
	display: inline-block;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-title .xl-tab-hitem.active span:before {
	content: '';
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	height: 3px;
	background: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}

/*列表样式*/
.item-li {
	position: relative;
	margin: 9px 15px 0;
	height: 72px;
	line-height: 1;
}
.item-li-l {
	position: absolute;
	left: 0;
	top: 0;
	height: 100%;
	width: 101px;
	color: #fff;
	text-align: center;
	background: url(../../image/icon/card_icon008.png) no-repeat;
	background-size: 100% 100%;
}
.item-li-p1 {
	padding-top: 14px;
	font-size: 16px;
}
.item-li-p2 {
	padding-top: 9px;
	font-size: 15px;
}
.item-li-p1 span {
	font-size: 24px;
}
.item-li-p1 i {
	font-size: 12px;
}
.item-li-r {
	position: relative;
	z-index: 2;
	height: 100%;
	background: #fff;
	margin-left: 101px;
	padding-left: 6px;
}
.item-li-p3 {
	line-height: 28px;
	color: #313131;
	font-size: 15px;
}
.item-li-p3 span {
	color: #7d7d7d;
	font-size: 10px;
	display: block;
}
.item-li-p3 img {
	width: 28px;
	height: 28px;
	margin-right: 5px;
}
.item-li-p4 {
	position: absolute;
	left: -4px;
	bottom: 0;
	right: 0;
	line-height: 20px;
	color: #959595;
	font-size: 9px;
	padding-left: 10px;
	border-top: dashed 1px #eee;
}
.item-statu-btn {
	padding-top: 5px;
	text-align: center;
	display: none;
}
.item-statu-btn button {
	border: solid 1px #ff7f1a;
	color: #ff7f1a;
	border-radius: 100px;
	font-size: 9px;
	background: #fff;
	padding: 5px 10px;
}
.item-statu-bg {
	position: absolute;
	right: 5px;
	top: 12px;
	width: 58px;
	height: 58px;
	z-index: 10;
	display: none;
}
.item-li.item-statu2 .item-li-l ,
.item-li.item-statu3 .item-li-l {
	background: url(../../image/icon/card_icon009.png) no-repeat;
	background-size: 100% 100%;
}
.item-li.item-statu2 .item-li-p3 img,
.item-li.item-statu3 .item-li-p3 img {
    -webkit-filter: grayscale(100%);
    filter: grayscale(100%);
    filter: gray;
    opacity: .7;
}
.item-li.item-statu1 .item-statu-btn {
	display: block;
}
.item-li.item-statu2 .item-statu-bg {
	display: block;
	background: url(../../image/icon/card_icon006.png) no-repeat;
	background-size: 100% 100%;
}
.item-li.item-statu3 .item-statu-bg {
	display: block;
	background: url(../../image/icon/card_icon007.png) no-repeat;
	background-size: 100% 100%;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">全部订单</h1>
	</div>
</div>
<div class="xlele-box titleshowhide xl-tab-fixed">
	<div class="xlele-content">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" onclick="onTabTitleFn(this)"><span>待兑换</span></a>
			<a class="xl-tab-hitem" datahref="#tabContent2" onclick="onTabTitleFn(this)"><span>已兑换</span></a>
			<a class="xl-tab-hitem" datahref="#tabContent3" onclick="onTabTitleFn(this)"><span>已过期</span></a>
		</div>
	</div>
</div>
<div class="titleshowhide" style="height: 3.6em;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent1">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent2">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent3">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script id="tabListTemplate"  type="text/template">
	{{~ it:data}}
	{{?(data.status_l === '0')}}
	<!--可使用-->
	<div class="item-li item-statu1">
	{{??(data.status_l === '2')}}
	<!--已使用-->
	<div class="item-li item-statu2">
	{{??(data.status_l === '3')}}
	<!--已过期-->
	<div class="item-li item-statu3">
	{{?}}
		<div class="item-li-l">
			<div class="item-li-p1">￥<span>{{=parseInt(data.ruleObj.value)}}</span><i>{{=data.ruleObj.type}}</i></div>
			<div class="item-statu-btn">
				<button onclick="onExchange('{{=encodeURIComponent(JSON.stringify(data))}}')">立即兑换</button>
			</div>
		</div>
		<div class="item-li-r">
			<div style="height: 11px;"></div>
			<div class="item-li-p3">
				<img src="../../image/icon/card_icon010.png"/>
				{{=data.fundTypeName}}
				<!--<span>附近570米</span>-->
			</div>
			<div class="item-li-p4">截止：{{=data.deadline.substr(0, 10)}}</div>
		</div>
		<div class="item-statu-bg"></div>
	</div>
	{{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	globalData.showItem = globalData.pageParam.showItem;
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var datahref = $('#tabTitleBox').find('.active').attr('datahref');
		getOrderDataFn(datahref);
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent1';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	onTabTitleFn($('[datahref="' + datahref + '"]')[0]);
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me),
		datahref = $me.attr('datahref'),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	if($me.hasClass('active')){return false;}//本就是选中状态，不能再次点击
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	if(datahref == '#tabContent100'){
		$('.titleshowhide').hide();
	}
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	getOrderDataFn(datahref);
}

//获取订单数据列表
function getOrderDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('tabListTemplate'),
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来确定请求的地址
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	switch(datahref){
		case '#tabContent1'://待兑换
		typenum = '0';
		break;
		case '#tabContent2'://已兑换
		typenum = '2';
		break;
		case '#tabContent3'://已过期
		typenum = '3';
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url = '/ushop-api-merchant/api/user/coupons/gift/listBy/' + typenum + '/' + currentPage + '/10';
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = parseInt(data.currentPage);
			pagePage = parseInt(data.pagePage);
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('');
				Common.blankPageFn(listContent);//显示空白界面
				return false;
			}else{
				Common.blankPageFn(listContent, 'hide');//隐藏空白界面
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			Common.each(data.recordList, function(index, obj){
				if(obj.object && obj.object.rule){
					obj.ruleObj = JSON.parse(obj.object.rule);
				}else{
					obj.ruleObj = {};
				}
				obj.status_l = typenum + '';
			});
			var dataListTemplate = doT.template(template.innerHTML);
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent[0].innerHTML = dataListTemplate(data.recordList);
			}else{
				listContent[0].innerHTML += dataListTemplate(data.recordList);
			}
		}else{
			refreshPrompt.html(data.error_description || '未知错误');
		}
	});
}

//详情页兑换券
function onExchange(val){
	var obj = JSON.parse(decodeURIComponent(val)),
		pageParam = {
			codeStr: 'exchange_card_xll_' + encodeURIComponent(obj.userNo + '_xl_' + obj.couponsNo),
			deadline: obj.deadline,
			fundTypeName: obj.fundTypeName
		};
	Common.openPage('../card_bag/card_detail.html', pageParam);
}
</script>
</body>
</html>
