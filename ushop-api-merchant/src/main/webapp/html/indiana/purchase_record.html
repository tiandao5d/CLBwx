<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>彩购记录</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<link rel="stylesheet" type="text/css" href="../../css/laydate.css"/>
<style>
.xlwp-li {
	position: relative;
	color: #bbb;
	background: #fff;
	padding: .5em 7em .5em 5em;
	line-height: 1.6;
}
.xlwp-li.xlpr-pr0 {
	padding-right: 2em;
}
.xlwp-li .xlwp-p1 {
	color: #414141;
	font-size: 1.1em;
}
.xlwp-li .xlwp-li-img {
	position: absolute;
	left: .8em;
	top: .5em;
	height: 3.6em;
	width: 3.6em;
}
.xlwp-li .xlwp-btn {
	position: absolute;
	right: .8em;
	top: 50%;
}
.xlwp-li .xlwp-btn .xl-btn {
	margin-top: -1em;
	vertical-align: top;
}
.xl-progressbar {
	margin: 0;
}
.xlpr-p1 {
	color: #ff4680;
	text-align: center;
	margin-top: -1.4em;
}
.xlpr-p2 {
	position: relative;
	padding: .5em .8em;
	background: #fcf2ee;
	border-radius: .5em;
	padding-left: 5em;
}
.xlpr-p2 > .xlwp-li-img {
	border-radius: 50%;
}
.xltab-content {
	padding-top: 3em;
}
.xl-purchase-num {
	text-align: center;
}
.xl-purchase-num span {
	display: inline-block;
	padding: .3em .5em;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">彩购记录</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xltab-box" id="xltabBoxEle">
		<div class="xltab-head">
			<div class="xltab-head-body">
				<a class="xltab-hItme active" typeNum="0" href="#xltabItme0">全部</a>
				<a class="xltab-hItme" typeNum="100" href="#xltabItme100">进行中</a>
				<a class="xltab-hItme" typeNum="102" href="#xltabItme102">已揭晓</a>
			</div>
		</div>
		<div class="xltab-content">
			<div class="xltab-cItme active" id="xltabItme0">
				<ul class="xlwp-ul">
					<!--<li class="xlwp-li">
						<img class="xlwp-li-img" src="../../image/icon/ipad.png"/>
						<div class="xlwp-p1 ellipsis">Apple watch 颜色及表带什么的都是随机的</div>
						<div class="ellipsis">期号：158266685</div>
						<div class="ellipsis">进度：20%</div>
		            	<div class="xl-progressbar">
			        		<span style="width: 20%;"></span>
		    	    	</div>
						<div class="ellipsis">本期参与：<span class="color-ff5534">77</span>人次</div>
						<div class="color-ff5534">查看彩购号码</div>
						<div class="xlwp-btn"><a class="xl-btn">已晒单</a></div>
					</li>
					<li class="xlwp-li">
						<img class="xlwp-li-img" src="../../image/icon/ipad.png"/>
						<div class="xlwp-p1 ellipsis">Apple watch 颜色及表带什么的都是随机的</div>
						<div class="ellipsis">期号：158266685</div>
						<div class="ellipsis">本期参与：<span class="color-ff5534">77</span>人次</div>
						<div class="color-ff5534">查看彩购号码</div>
						<div class="xlwp-btn">
							<div class="xlpr-p1">即将开奖
			                	<div class="xl-countdown-box xlplCountdown clearfix" timeNum="2017-07-03 11:07:00">
			                		<span>00</span>
			                		<span>00</span>
			                		<span>00</span>
			                	</div>
							</div>
						</div>
					</li>
					<li class="xlwp-li xlpr-pr0">
						<img class="xlwp-li-img" src="../../image/icon/ipad.png"/>
						<div class="xlwp-p1 ellipsis">Apple watch 颜色及表带什么的都是随机的</div>
						<div class="ellipsis">期号：158266685</div>
						<div class="ellipsis">本期参与：<span class="color-ff5534">77</span>人次</div>
						<div class="color-ff5534">查看彩购号码</div>
						<div class="xlpr-p2">
							<img class="xlwp-li-img" src="../../image/icon/ipad.png">
							<div class="xlwp-p1 ellipsis">获奖者：中国人</div>
							<div class="ellipsis">幸运号码：158266685</div>
							<div class="ellipsis">本期参与：158266685</div>
							<div class="ellipsis">揭晓时间：158266685</div>
						</div>
					</li>-->
				</ul>
				<div class="xl-refresh-prompt refreshPrompt"></div>
			</div>
			<div class="xltab-cItme" id="xltabItme100">
				<ul class="xlwp-ul"></ul>
				<div class="xl-refresh-prompt refreshPrompt"></div>
			</div>
			<div class="xltab-cItme" id="xltabItme102">
				<ul class="xlwp-ul"></ul>
				<div class="xl-refresh-prompt refreshPrompt"></div>
			</div>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
	var tabBox = $('#xltabBoxEle'),
		tabItemHs = tabBox.find('.xltab-hItme'),
		tabItemCs = tabBox.find('.xltab-cItme');
	tabItemHs.on('click', function(){
		var $me = $(this),
			tabItemC = $($me.attr('href')),
			typeNum = $me.attr('typeNum');
		if(!$me.hasClass('active')){
			tabItemHs.removeClass('active');
			$me.addClass('active');
			tabItemCs.removeClass('active');
			tabItemC.addClass('active');
			delayedSearchFn(typeNum);
		}
		return false;
	});
	//到底部加载
	Common.scrollBottom(function(){
		productShowFn(tabBox.find('.xltab-hItme.active').attr('typeNum'));
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	listParamInt();//列表参数初始化
	//刷新数据请求函数
	delayedSearchFn('0');
}
//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//列表参数初始化
function listParamInt(){
	var tabBox = $('#xltabBoxEle'),
		tabItemHs = tabBox.find('.xltab-hItme'),
		tabItemCs = tabBox.find('.xltab-cItme');
	//页面刷新时，数据初始化
	tabItemHs.each(function(index, item){
		var typeNum = $(item).attr('typeNum');
		globalData['currentPage' + typeNum] = 0;//当前页
		globalData['pagePage' + typeNum] = 1;//总页数
	});
	
	tabItemHs.removeClass('active');
	tabItemCs.removeClass('active');
	tabItemHs.eq(0).addClass('active');
	tabItemCs.eq(0).addClass('active');
}

//延迟搜索
function delayedSearchFn(typeNum){
	if(!typeNum){return false;}
	//用来规定刷新频率
	if(globalData['isReloadPageData' + typeNum] === undefined || globalData['isReloadPageData' + typeNum] === true){
		globalData['currentPage' + typeNum] = 0;
		globalData['pagePage' + typeNum] = 1;
		productShowFn(typeNum);
		globalData['isReloadPageData' + typeNum] = false;
		setTimeout(function(){
			globalData['isReloadPageData' + typeNum] = true;
		},30000);
	}
};

//列表请求显示
//选项卡式产品列表示例
function productShowFn(typeNum){
	typeNum = typeNum || $('#xltabBoxEle').find('.xltab-hItme').attr('typeNum');
	typeNum += '';
	globalData['currentPage' + typeNum]++;
	if(globalData['currentPage' + typeNum] > globalData['pagePage' + typeNum]){//说明已经是最后一页了
		return false;
	}
	var listItem = $('#xltabItme' + typeNum),//列表项目
		listContent = listItem.find('ul'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt');//加载中提示容器
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRecord/'+
				globalData['currentPage' + typeNum] + '/10/' + typeNum + '/' + Common.getUserId();
	Common.ajax(_url, 'get', {}, function(data){
		if(data.totalCount >= 0){//表示数据请求成功
			globalData['currentPage' + typeNum] = data.currentPage;
			globalData['pagePage' + typeNum] = data.pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(globalData['currentPage' + typeNum] < globalData['pagePage' + typeNum]){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var str = '', rate, productImage = '../../image/p200200.png', headImage = '../../image/icon/minePortrait.png';
			$.each(data.recordList, function(index, obj){
				if(obj.object.headImage){
					productImage = Common.getImageUrl(obj.object.headImage);
				}
				if(obj.spellbuyStatus == 100){
					rate = parseInt(100*obj.spellbuyCount/obj.spellbuyPrice);
					str +=
							'<li class="xlwp-li">'+
								'<img class="xlwp-li-img" src="' + productImage + '"/>'+
								'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
								'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
								'<div class="ellipsis">进度：' + rate + '%</div>'+
				            	'<div class="xl-progressbar">'+
					        		'<span style="width: ' + rate + '%;"></span>'+
				    	    	'</div>'+
								'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
								'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
								'<div class="xlwp-btn"><a href="../indiana/product_details.html?fromTo=btn&spellbuyId=' + obj.spellbuyProductId + '" class="xl-btn">追加</a></div>'+
							'</li>';
				}else if(obj.spellbuyStatus == 101){
					str +=
							'<li class="xlwp-li">'+
								'<img class="xlwp-li-img" src="' + productImage + '"/>'+
								'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
								'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
								'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
								'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
								'<div class="xlwp-btn">'+
									'<div class="xlpr-p1">即将开奖'+
					                	'<div class="xl-countdown-box xlplCountdown clearfix" timeNum="' + obj.announceEndDate + '">'+
					                		'<span>00</span>'+
					                		'<span>00</span>'+
					                		'<span>00</span>'+
					                	'</div>'+
									'</div>'+
								'</div>'+
							'</li>';
				}else if(obj.spellbuyStatus == 102){
					if(obj.ownerImage){
						headImage = Common.getImageUrl(obj.ownerImage);
					}
					str +=
							'<li class="xlwp-li xlpr-pr0">'+
								'<img class="xlwp-li-img" src="' + productImage + '"/>'+
								'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
								'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
								'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
								'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
								'<div class="xlpr-p2">'+
									'<img class="xlwp-li-img" src="' + headImage + '">'+
									'<div class="xlwp-p1 ellipsis">获奖者：' + obj.ownerName + '</div>'+
									'<div class="ellipsis">幸运号码：' + obj.luckyNumber + '</div>'+
									'<div class="ellipsis">本期参与：' + obj.ownerCount + '</div>'+
									'<div class="ellipsis">揭晓时间：' + obj.announcedTime + '</div>'+
								'</div>'+
							'</li>';
				}
			});
			if(globalData['currentPage' + typeNum] == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
			countdownFn();//倒计时
		}else{
			refreshPrompt.html('加载失败！');
		}
	});
}

//倒计时函数
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 100;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('span'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			if(timeEle.length != 3){
				return false;
			}
			timeInter[timeInter.length] = setInterval(function(){
				if(timeDif > interTime){
				    var i = parseInt((timeDif%3600000)/(60000)),
				    	s = parseInt((timeDif%60000)/1000),
				    	m = parseInt((timeDif%1000)/interTime);
				    i = i < 10 ? ('0' + i) : i;
				    s = s < 10 ? ('0' + s) : s;
				    m = m < 10 ? ('0' + m) : m;
					timeEle[0].innerHTML = i;
					timeEle[1].innerHTML = s;
					timeEle[2].innerHTML = m;
					timeDif = timeDif - interTime;
				}else if(timeDif < -interTime){
					clearInterval(timeInter[index]);
					$me.parents('li').remove();
				}else if(timeDif <= interTime){
					timeEle[0].innerHTML = '00';
					timeEle[1].innerHTML = '00';
					timeEle[2].innerHTML = '00';
					timeDif = timeDif - interTime;
				}else{
					clearInterval(timeInter[index]);
				}
			}, interTime);
		});
		globalData.interCountdown = timeInter;
	});
}


//查看彩购号码
function showNumberFn(spellbuyId) {
	var _url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRandomNumber/' + Common.getUserId() + '/' + spellbuyId;
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList){
			var str = '';
			$.each(data.recordList, function(index, name){
				str += '<span>' + name + '</span> ';
			});
			str =   '<div class="xl-purchase-num">'+
					str+
					'</div>';
			Common.confirm('提示', str, null, '确定');
		}
	});
}
</script>
</body>
</html>
