<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>个人信息</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlui-box1 {
	font-size: 1.2em;
}
.xlui-menu-right:before {
    content: "\e775";
    font-family: 'iconfont';
    position: absolute;
    right: 0;
    top: 50%;
    color: #999;
    line-height: 1;
    margin-top: -0.5em;
    z-index: 2;
}
.xlui-rm {
	position: absolute;
	right: .8em;
	top: 50%;
	height: 2em;
	margin-top: -1em;
	line-height: 2em;
	color: #888;
}
.xlui-menu-right.xlui-rm {
	padding-right: 1.4em;
}
.xlui-img1 {
	width: 2em;
	height: 2em;
	border-radius: 50%;
}

.modal-ipt {
	display: block;
	width: 100%;
	height: 2.4em;
	line-height: 1;
	font-size: 1.2em;
	padding: .7em .8em;
	border: 0;
	background: #ddd;
}


.xladd-modal .tmodal-html {
	padding: 10px 15px;
}
.xladd-modal ul {
	max-height: 300px;
	overflow-x: hidden;
	overflow-y: auto;
}
.xladd-modal ul li {
    position: relative;
	padding: 11px 0;
}
.xladd-modal ul li:after {
    position: absolute;
    right: 0;
    top: 0;
    left: 0;
    height: 1px;
    content: '';
    -webkit-transform: scaleY(.5);
    transform: scaleY(.5);
    background-color: #ccc;
}
.xladd-modal ul li:first-child:after {
	height: 0;
}

.xl-li > a {
	min-height: 0;
}
.xlui-radio-box label {
	display: inline-block;
	width: 5em;
	font-size: 1.2em;
}
.xlui-radio-box input,
.xlui-radio-box span {
	display: inline-block;
	vertical-align: middle;
}
.xlui-radio-box span {
	padding-left: 5px;
}


.laydate_body .laydate_box {
	position: fixed !important;
	left: 50% !important;
	top: 50% !important;
	-webkit-transform: translate(-50%, -50%) !important;
	transform: translate(-50%, -50%) !important;
}

.modal-r-ipt {
	display: block;
	width: 100%;
	padding: .6em;
	line-height: 1em;
}

.laydate-modal {
	bottom: -100%;
	z-index: 1000;
	transition: all .3s;
}
.laydate-modal.active {
	bottom: 0;
}
.layui-laydate-static,
.layui-laydate-main,
.layui-laydate-content,
.layui-laydate-content table {
	width: 100% !important;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">个人信息</h1>
	</div>
</div>
<div class="xlbody-box">
	<input type="file" id="fileele" class="hide" />
	<div class="xlui-box1">
		<ul class="xl-ul">
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">头像</div>
					<div class="xlui-rm xlui-menu-right" onclick="selectImage(this)">
						<img class="xlui-img1" id="headImage" src="../../image/icon/minePortrait.png">
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">ID</div>
					<div class="xlui-rm" id="userNo">
						<span class="color-ff5534">唯一标识</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">昵称</div>
					<div class="xlui-rm xlui-menu-right" id="nickName" onclick="changeNickNameFn()">
						<span class="color-ff5534">待完善</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">性别</div>
					<div class="xlui-rm xlui-menu-right" id="sex" onclick="changeSexFn()">
						<span class="color-ff5534">待完善</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">出生日期</div>
					<div class="xlui-rm xlui-menu-right" id="age" onclick="changeAgeFn()">
						<span class="color-ff5534">待完善</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">所在地区</div>
					<div class="xlui-rm xlui-menu-right" id="address" onclick="changeAddressFn()">
						<span class="color-ff5534">待完善</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">绑定手机号</div>
					<div class="xlui-rm xlui-menu-right" id="telNo">
						<span class="color-ff5534">绑定</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">真实姓名</div>
					<div class="xlui-rm xlui-menu-right" id="realName" onclick="realNameValid()">
						<span class="color-ff5534">绑定</span>
					</div>
				</a>
			</li>
			<li class="xl-li">
				<a>
					<div class="xl-li-txt">身份证号</div>
					<div class="xlui-rm xlui-menu-right" id="cardNo" onclick="realNameValid()">
						<span class="color-ff5534">绑定</span>
					</div>
				</a>
			</li>
		</ul>
		<div class="xl-refresh-prompt refreshPrompt"></div>
	</div>
</div>
<div class="xlele-box laydate-modal" id="laydate_modal">
	<div class="xlele-content" id="laydate_modal_box"></div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="../../script/laydate/laydate.js"></script>
<script src="../../script/city.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
	if(globalData.pageParam.realNameValid == 'yes'){
		realNameValid();
	}
}
//dom事件绑定
function domEventFn(){
	//日历插件绑定
	laydate.render({
		elem: '#laydate_modal_box', //指定元素
		position: 'static',
		showBottom: false,
		done: function(val, date){
			changeAgeFn(val);
		}
	});
	//微信授权
	if(Common.isWeixin()){
		wxAuthoriseFn();//微信授权jsSDK
	}
	//用于测试
	$('#fileele').on('change', function(){
		var _file = this.files[0],
			ftype;
		if(_file){
			ftype = _file.type.split('/')[1];
		}
		if((ftype === 'jpeg') || (ftype === 'png')){
			var rf = new FileReader();
			rf.readAsDataURL(_file);
			Common.loadingShow('图片解析中……');
			rf.onload = function(){
				resultImgB64(rf.result);
			}
		}else{
			Common.toast('暂时只支持jpg,png两种格式图片');
		}
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//刷新数据请求函数
	getUserInfoFn();
}


//余额数量获取，显示
function getUserInfoFn(){
	Common.userInfoL(function(data){
    	if(data.userNo){
			var nickName     = data.nickName || '<span class="color-ff5534">待完善</span>',//用户名，string
				address      = data.address || '<span class="color-ff5534">待完善</span>',//籍贯，string
				headImage    = data.headImage ? Common.getImageUrl(data.headImage) : '../../image/icon/minePortrait.png',//头像地址，string
				diamond      = data.diamond || 0,//余额数量，number
				sex          = data.sex || '',//性别，string
				loginName    = data.loginName || '',//登录名，string
				userNo       = data.userNo || '',//用户id
				realName     = data.realName || '',//真实姓名，string
				cardNo       = data.cardNo || '',//身份证号，string
				age          = data.age || '<span class="color-ff5534">待完善</span>',//年龄，str
				telNo        = data.telNo || '<span class="color-ff5534">绑定</span>';//电话号码，string
    		globalData.infoParam = {
    			address: (data.address || ''),
    			nickName: (data.nickName || ''),
    			age: (data.age || ''),
    			sex: (data.sex || '')
    		};
    		globalData.infoParamStr = JSON.stringify(globalData.infoParam);
			switch(sex){
				case 'nan': sex = '男';
				break;
				case 'nv' : sex = '女';
				break;
				default   : sex = '<span class="color-ff5534">待完善</span>';
			}
			$('#nickName').html(Common.phoneEncryption(nickName));
			$('#address').html(address);
			$('#headImage').attr('src', headImage);
			$('#userNo').html(userNo);
			$('#sex').html(sex);
			$('#age').html(age);
    		$('#realName').html((realName ? (realName.replace(/\D|\d/g, '*').slice(0, -1) + '' + realName.slice(-1)) : '<span class="color-ff5534">绑定</span>'));
			$('#cardNo').html((cardNo ? (cardNo.slice(0, 4) + '**********' + cardNo.slice(-4)) : '<span class="color-ff5534">绑定</span>'));
			if(data.telNo){
				$('#telNo').html(Common.phoneEncryption(telNo)).removeClass('xlui-menu-right');
			}else{
				$('#telNo').html(Common.phoneEncryption(telNo)).parents('a').attr('href', '../mine/change_info.html?telNo=' + (data.telNo || ''));
			}
    	}
	});
}

//改昵称
function changeNickNameFn(){
	Common.userInfoL(function(data){
		var nickName = (data.nickName || '');
		var str = '<input class="modal-ipt nickNameIpt" value="' + nickName + '" type="text">';
		Common.confirm('昵称修改', str, function(index){
			if(index == 1){
				var val = $('.nickNameIpt').val();
				if(!(/^[\s\S]{1,15}$/.test(val))){
					Common.toast('请输入1-15个字的昵称');
					return false;
				}
				infoUpdate({nickName: val}, function(data){
					if(data.userNo){
						$('#nickName').html(val);
					}
				});
			}
		});
	});
}
//改性别
function changeSexFn(){
	Common.userInfoL(function(data){
		var sex = data.sex;
		var nanIpt = '<input type="radio" name="sex" value="nan">',
			nvIpt = '<input type="radio" name="sex" value="nv">';
		if(sex == 'nan'){
			nanIpt = '<input type="radio" checked name="sex" value="nan">';
		}else if(sex == 'nv'){
			nvIpt = '<input type="radio" checked name="sex" value="nv">';
		}
		var str =   '<div class="xlui-radio-box sexSelectBox">'+
						'<label>' + nanIpt + '<span>男</span></label>'+
						'<label>' + nvIpt + '<span>女</span></label>'+
					'</div>';
		Common.confirm('性别修改', str, function(index){
			if(index == 1){
				var val = $('.sexSelectBox').find('input:checked').val();
				if(!val){
					Common.toast('请选择性别');
					return false;
				}
				infoUpdate({sex: val}, function(data){
					if(data.userNo){
						switch(val){
							case 'nan': $('#sex').html('男');
							break;
							case 'nv': $('#sex').html('女');
							break;
						}
					}
				});
			}
		});
	});
}
//改地址
function changeAddressFn(){
	var htmlStr = '';
	$.each(cityList, function(index, obj) {
		htmlStr += '<li onclick="selectShengAfterFn(this, \'' + obj.name + '\')">' + obj.name + '</li>';
	});
	selectAddressFn('show', htmlStr);
}

//选择省之后
function selectShengAfterFn(me, sheng){
	var htmlStr = '';
	$.each(cityList, function(index, obj){
		if(obj.name == sheng){
			$.each(obj.sub, function(i, o){
				htmlStr += '<li onclick="selectShiAfterFn(this, \'' + sheng + '\', \'' + o.name + '\')">' + o.name + '</li>';
			});
			return false;
		}
	});
	$(me).parents('ul').html(htmlStr);
	$(window).trigger('resize');
}
//选择市之后
function selectShiAfterFn(me, sheng, shi){
	selectAddressFn('hide');
	var val = sheng + ' ' + shi;
	infoUpdate({address: val}, function(data){
		if(data.userNo){
			$('#address').html(val);
		}
	});
}


//模态框，城市选择
function selectAddressFn(type, htmlStr){
	if(type === 'hide'){
		Common.tmodal('hide');
	}else if(type === 'show'){
		Common.tmodal('bottom', ('<ul>' + htmlStr + '</ul>'), 'xladd-modal');
	}
}
//改出生日期
function changeAgeFn(val){
	if(val){
		$('.modal-bg').remove();
		infoUpdate({age: val}, function(data){
			if(data.userNo){
				$('#age').html(val);
			}
		});
		$('#laydate_modal').removeClass('active');
	}else{
		if($('.modal-bg').length == 0){
			$('<div class="modal-bg"></div>').on('click', function(){
				$(this).remove();
				$('#laydate_modal').removeClass('active');
			}).appendTo('body');
		}
		$('#laydate_modal').addClass('active');
	}
}

//实名认证，真实姓名，身份证号
function realNameValid(){
	var str =   '<div style="font-size: .8em;">提示：<span class="xl-color-ff5534">请务必确认您输入信息的真实性和正确性，这关系到您是否能领取奖励！</span></div>'+
				'<div style="height: 10px;"></div>'+
				'<input type="text" placeholder="请输入真实姓名" class="modalRealName modal-r-ipt">'+
				'<div style="height: 10px;"></div>'+
				'<input type="text" placeholder="请输入身份证号" class="modalcardNo modal-r-ipt">';
	Common.confirm('请选择', str, function(index){
		if(index == 1){
			var modalRealName = document.querySelector('.modalRealName').value,
				modalcardNo = document.querySelector('.modalcardNo').value,
				fullYear = (new Date()).getFullYear();
			if(!Common.regExpName.test(modalRealName)){
				Common.toast('抱歉，姓名或身份证有误');
				return false;
			};
			if(!(Common.regExpIDNO.test(modalcardNo) && (parseInt(modalcardNo.substr(6, 4)) - parseInt(fullYear) < 200))){
				Common.toast('抱歉，姓名或身份证有误');
				return false;
			};
			var infoParam = {
				realName: modalRealName,
				cardNo: modalcardNo
			};
			infoUpdate(infoParam, function(data){
				if(data.userNo){
					document.getElementById('realName').innerHTML = (modalRealName ? (modalRealName.replace(/\D|\d/g, '*').slice(0, -1) + '' + modalRealName.slice(-1)) : '未绑定');
					document.getElementById('cardNo').innerHTML = (modalcardNo ? (modalcardNo.slice(0, 4) + '**********' + modalcardNo.slice(-4)) : '未绑定');
				}
				if(globalData.pageParam.realNameValid == 'yes'){
					Common.openPage('../weixinmp/home.html?scanQRCode=yes')
				}
			});
		}
	});
}


//信息编辑
function infoUpdate(infoParam, callback){
	callback = callback || function(){};
	var _url = '/ushop-api-merchant/api/user/profile/update',
		_param = JSON.stringify(infoParam);
	Common.ajax(_url, 'post', _param, function(data){
		callback(data);
		if(data.userNo){
			Common.toast('信息修改成功！');
			Common.userInfoL(infoParam);
		}
	});
}




//本地图片上传，测试用
function resultImgB64(b64){
	//压缩到100K
	convertImgToBase64(b64, 500, 0, 100, function(imgB64){
		var _url = '/ushop-api-merchant/api/sns/file/submit',
			_param = [{
				name: '1.jpg',
				content: (b64.indexOf(',') > 0 ? b64.split(',')[1] : b64),
				thumb: 1
			}];
		Common.loadingShow('图片上传中……');
		Common.ajax(_url, 'post', JSON.stringify(_param), function(data){
			headImgUpdata(data.urls || []);
		}, false);
	});
}

//微信上传图片
function wxImgB64(){
	wx.chooseImage({
		count: 1, // 默认9
		sizeType: ['compressed'], // 可以指定是原图还是压缩图，默认二者都有
		sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
		success: function(res) {
			var localIds = res.localIds, // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
				arr = [],
				_url = '/ushop-api-merchant/api/sns/file/submit',
				_param = [];
			Common.loadingShow('图片解析中……');//遮屏
			$.each(localIds, function(index, localId) {
				wx.getLocalImgData({
					localId: localId, // 图片的localID
					success: function(res) {
						Common.loadingShow('图片上传中……');//遮屏
						// localData是图片的base64数据，可以用img标签显示
						var b64 = res.localData;
						arr[arr.length] = b64;
						_param[_param.length] = {
							name: (index + '.jpg'),
							content: (b64.indexOf(',') > 0 ? b64.split(',')[1] : b64),
							thumb: 1
						}
						if(_param.length === localIds.length){
							Common.ajax(_url, 'post', JSON.stringify(_param), function(data){
								headImgUpdata(data.urls || []);
							}, false);
						}
					}
				});
			});
		}
	});
}

//选择图片
function selectImage(me) {
	if(Common.isWeixin()){//微信选择图片
		if(!globalData.wxIsTrue) {
			Common.toast('页面初始化中，请稍后！');
			return false;
		}
		wxImgB64();
	}else{//本地用于测试的选择图片
		$('#fileele').trigger('click');
	}
}
//头像修改
function headImgUpdata(imgArr){
	if(!(imgArr && (imgArr.length > 0))){
		Common.loadingHide();
		Common.toast('图片上传失败！');
		return false;
	}
	var _url = '/ushop-api-merchant/api/user/profile/setAvatar',
		_param = {file: imgArr[0]};
	Common.ajax(_url, 'post', _param, function(data){
		Common.loadingHide();
		if(data.userNo){
			Common.toast('头像更换成功！');
			$('#headImage').attr('src', imgArr[0]);
			Common.userInfoL({headImage: imgArr[0]});
		}else{
			Common.toast((data.error_description || '未知错误'));
		}
	}, false);
}


//configFn(1495764791, 'Kmifefp2whjxfbst', '7ebdce4d83faadb22e3d0d277bcaefe0cd08514e');
function configFn(timestamp, nonceStr, signature) {
	wx.config({
		debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
		appId: Common.getAppId(), // 必填，公众号的唯一标识
		timestamp: timestamp, // 必填，生成签名的时间戳
		nonceStr: nonceStr, // 必填，生成签名的随机串
		signature: signature, // 必填，签名，见附录1
		jsApiList: [ // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
			'chooseImage', //拍照，从相册选择
			'getLocalImgData' //获取本地图片接口
		]
	});
}
wx.ready(function() {
	globalData.wxIsTrue = true;
});

function wxAuthoriseFn() {
	var _url = Common.domainUrl + '/ushop-api-merchant/api/weixin/client/ticket/get?' +
		'type=jsapi&url=' + document.URL;
	Common.ajax(_url, 'get', {}, function(data) {
		if(data.sign) {
			configFn(data.timestamp, data.noncestr, data.sign);
		}
	});
}
//将指定地址的图片转为base64文件，只会转为jpeg，不支持png，png图片文件太大，无法压缩
//url: 图片地址
//newWidth: 缩放后新图片的宽度，单位px
//newHeight: 缩放后新图片的高度，单位px
//如果只有宽或者高，将按给出的宽或高等比缩放，如果都没有则不缩放
//maxSize：新图片的最大内存大小，单位kb
//callback：回调函数，参数为新图片的base64字符串
//图片传输方法的示例
//convertImgToBase64('images/115.jpg', 100, 100, 10, function(imgB64){
//	var fd = new FormData();
//	fd.append('file', convertBase64UrlToBlob(imgB64), 'img.jpeg');
//	ajax({
//		url: _url,
//		type: 'post',
//		data: fd,
//		processData: false
//	}, function(){
//		console.log(arguments)
//	});
//});
function convertImgToBase64(url, newWidth, newHeight, maxSize, callback) {
	var img = new Image;
	img.crossOrigin = 'Anonymous';
	img.src = url;
	img.onload = function() {
		var cw = parseInt(newWidth),//表示画布宽度，也就是新图片的宽度
			ch = parseInt(newHeight),//表示画布的高度，也就是新图片的高度
			cw_ch,
			iw = this.width,//记录图片的宽度
			ih = this.height,//记录图片的高度
			iw_ih = iw/ih,
			canvas = document.createElement('canvas'),//创建canvas元素
			ctx = canvas.getContext('2d'),
			quality = 0.8,//保存图片质量，如果超出限制，将会循环减小质量直到0
			dataURL,//用来记录base64的字符串
			isTrue = true,//用来判断是否超出最大KB数
			sw = iw, sh = ih,//用来记录最大能够裁剪的宽高
			ix = 0, iy = 0;//规定裁剪的位置
		maxSize = parseInt(maxSize);//最大限制的kb
		if(!cw && !ch){//没有指定新的宽高
			cw = iw;
			ch = ih;
		}else if(cw && !ch){//没有指定新的高度
			ch = cw/iw_ih;
		}else if(!cw && newHeight){//没有指定新的宽度
			cw = ch*iw_ih;
		}
		cw_ch = cw/ch;
		canvas.width = cw;
		canvas.height = ch;
		if(iw_ih > cw_ch){
			sw = ih*cw_ch;
		}else{
			sh = iw/cw_ch;
		}
		ix = (iw - sw)/2;
		iy = (ih - sh)/2;
		ctx.drawImage(img, ix, iy, sw, sh, 0, 0, cw, ch);
		dataURL = canvas.toDataURL('image/jpeg', quality);
		if(maxSize){
			while(isTrue){
				if(imgSizeFn(dataURL)/1024 > maxSize){
					quality -= 0.1;
					dataURL = canvas.toDataURL('image/jpeg', quality);
				}else{
					isTrue = false;
				}
				if(quality <= 0){
					isTrue = false;
				}
			}
		}
		callback.call(this, dataURL);
		canvas = null;
	};
}
//获取base64文件大小，返回值为字节(b)
function imgSizeFn(base64Url){
    var str = base64Url.indexOf(',') > 0 ? base64Url.split(',')[1] : base64Url,
		equalIndex = str.indexOf('=');
	if(equalIndex > 0){
	    str = str.substring(0, equalIndex);
	}
	var strLength = str.length,
		fileLen = parseInt(strLength - (strLength/8)*2);
	return fileLen;
}
</script>
</body>
</html>
