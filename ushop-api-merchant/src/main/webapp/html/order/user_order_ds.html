<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>全部订单</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 3em;
	text-align: center;
	font-size: 1.2em;
	font-weight: 500;
	border-bottom: solid 1px #eee;
	display: table;
	width: 100%;
}
.xl-tab-title .xl-tab-hitem {
	display: table-cell;
	color: #333;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}

/*弹出窗选择原因*/
.xl-li.icon-radio:before {
    font-family: 'iconfont';
    position: absolute;
    right: 15px;
    top: 50%;
    color: #999;
    line-height: 1;
    margin-top: -0.5em;
    z-index: 2;
    font-size: 1.6em;
}
.xl-li.active.icon-radio:before {
    color: #ff5534;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">全部订单</h1>
	</div>
</div>
<div class="xlele-box titleshowhide xl-tab-fixed">
	<div class="xlele-content">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" onclick="onTabTitleFn(this)">待付款</a>
			<a class="xl-tab-hitem" datahref="#tabContent2" onclick="onTabTitleFn(this)">待发货</a>
			<a class="xl-tab-hitem" datahref="#tabContent3" onclick="onTabTitleFn(this)">待收货</a>
			<!--<a class="xl-tab-hitem" datahref="#tabContent4" onclick="onTabTitleFn(this)">待晒单</a>-->
			<a class="xl-tab-hitem" datahref="#tabContent5" onclick="onTabTitleFn(this)">退货</a>
			<a class="xl-tab-hitem hidden" datahref="#tabContent100">全部订单</a>
		</div>
	</div>
</div>
<div class="titleshowhide" style="height: 3.6em;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent1">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent2">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent3">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent4">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent5">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent100">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script id="orderListTemplate"  type="text/template">
	{{~ it:data}}
		<div class="xlap-od-item" order-no="{{=data.orderNo}}">
			{{~ data.merchantArr:mitem}}
			<div class="xlap-od-p1">
				<div class="xlo-p1">
					<span class="xlo-s1"></span>
					<span class="xlo-s2">
						<a>{{=mitem.merchantName}}</a>发货
					</span>
				</div>
			</div>
			<a href="order_detail_ds.html?orderNo={{=data.orderNo}}&orderObj={{=encodeURIComponent(JSON.stringify(data))}}">
			<ul class="xlo-ul">
				{{~mitem.proArr:item}}
				<li class="xlo-li">
					{{?item.headImage}}
					<img src="{{= Common.getImageUrl(item.headImage)}}">
					{{??}}
					<img src="../../../image/p200200.png">
					{{?}}
					<div class="xlo-body">
						<div class="xlo-p1">
							<span class="xlo-s1">{{=item.productName}}</span>
							<span class="xlo-s2">{{=item.checkedRule.payTypeText}}</span>
						</div>
						<div class="xlo-p1">
							<span class="xlo-s1 xlo-c969696">来自{{=mitem.merchantName}}</span>
							<span class="xlo-s2">x{{=item.buyCount}}</span>
						</div>
					</div>
				</li>
				{{~}}
			</ul>
			</a>
			{{?data.merchantArr.length > 1}}
			<div class="xlap-od-p2">
				<div class="xlo-p1">
					<span class="xlo-s1">商品总价：</span>
					<span class="xlo-s2">{{=mitem.totalText}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运费：</span>
					<span class="xlo-s2"><small>￥</small>{{=mitem.totalFreight}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运单总价：</span>
					<span class="xlo-s2">{{=mitem.totalTextFM}}</span>
				</div>
			</div>
			{{?}}
			{{~}}
			<div class="xlap-od-p2">
				<div class="xlo-p1">
					<span class="xlo-s1">商品总价：</span>
					<span class="xlo-s2">{{=data.totalText}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运费：</span>
					<span class="xlo-s2"><small>￥</small>{{=data.totalFreight}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运单总价：</span>
					<span class="xlo-s2">{{=data.totalTextFM}}</span>
				</div>
			</div>
			<div class="xlap-slide"></div>
			<div class="xlap-od-p3 clearfix">
				{{?data.status == 98}}
				<button class="xlbtn" onclick="onBtnCancelFn('{{=data.orderNo}}')">取消订单</button>
				<button class="xlbtn" onclick="onBtnNowPayFn('{{=encodeURIComponent(JSON.stringify(data))}}')">立即付款</button>
				{{??data.status == 101}}
				<button class="xlbtn" onclick="onBtnCancelFn('{{=data.orderNo}}')">取消订单</button>
				<button class="xlbtn" onclick="onBtnHintSendFn()">提醒发货</button>
				{{??data.status == 102}}
				<button class="xlbtn" onclick="onBtnReturnGoodsFn('{{=encodeURIComponent(JSON.stringify(data))}}')">申请退货</button>
				<button class="xlbtn" onclick="onBtnTakeGoodsFn('{{=data.orderNo}}')">确认收货</button>
				{{??data.status == 103}}
				<!--<button class="xlbtn" onclick="goSharePageFn('{{=encodeURIComponent(JSON.stringify(data))}}')">晒单分享</button>-->
				{{??data.status == 104}}
				<i class="xlap-txt">已申请退货，卖家处理中……</i>
				<button class="xlbtn" onclick="onBtnReturnNoFn('{{=data.orderNo}}')">取消退货</button>
				{{??data.status == 105}}
				<i class="xlap-txt">退货已受理，请尽快将商品寄回并等待退款</i>
				{{??data.status == 198}}
				<i class="xlap-txt">已退款，交易关闭</i>
				{{??data.status == 199}}
				<i class="xlap-txt">已取消</i>
				{{??data.status == 200}}
				<i class="xlap-txt">订单完成</i>
				{{?}}
			</div>
		</div>
	{{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	globalData.showItem = globalData.pageParam.showItem;
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var datahref = $('#tabTitleBox').find('.active').attr('datahref');
		getOrderDataFn(datahref);
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent100';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	onTabTitleFn($('[datahref="' + datahref + '"]')[0]);
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me),
		datahref = $me.attr('datahref'),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	if($me.hasClass('active')){return false;}//本就是选中状态，不能再次点击
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	if(datahref == '#tabContent100'){
		$('.titleshowhide').hide();
	}
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	getOrderDataFn(datahref);
}

//获取订单数据列表
function getOrderDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('orderListTemplate'),
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来确定请求的地址
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	switch(datahref){
		case '#tabContent1'://待付款
		typenum = '98';
		break;
		case '#tabContent2'://待发货
		typenum = '101';
		break;
		case '#tabContent3'://待收货
		typenum = '102';
		break;
		case '#tabContent4'://待晒单
		typenum = '103';
		break;
		case '#tabContent5'://退货
		typenum = '104';
		break;
		case '#tabContent100'://全部订单
		typenum = '300';
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url = '/ushop-api-merchant/api/mall/person/order/orderlist/' + currentPage + '/' + typenum;
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('');
				Common.blankPageFn(listContent);//显示空白界面
				return false;
			}
			Common.blankPageFn(listContent, 'hide');//隐藏空白界面
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			data = orderDecodeFn(data);
			var dataListTemplate = doT.template(template.innerHTML);
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent[0].innerHTML = dataListTemplate(data);
			}else{
				listContent[0].innerHTML += dataListTemplate(data);
			}
		}else{
			refreshPrompt.html(data.error_description || '未知错误');
		}
	});
}

//订单数据解析初始化
function orderDecodeFn(data, callback){
	callback = callback || function(){};
	globalData.point = data.point;
	globalData.balance = data.RMB;
	var proArr,
		orderObj,
		orderList = [];
	$.each(data.recordList, function(index, obj){
		proArr = [];
		$.each(JSON.parse(obj.withold + ''), function(i, o){
			proArr.push({
				productId: o.productId,//商品ID
				ruleArr: o.ruleArr || [],//支付方式数据
				checkedRule: OrderData.formatRule(JSON.stringify([{currencys: JSON.parse(o.price)}])).checkedRule,//默认选中的支付方式数据
				index: o.index,
				buyCount: parseInt(o.number) || 0,//购买的数量
				merchantName: o.merchantName,//商家名称
				merchantId: o.merchantId,//商家ID
				productTitle: o.productTitle || '',//商品说明
				productName: o.productName || '',//商品名称
				headImage: o.headImage,//商品缩略图
				stock: parseInt(o.stock) || 0,//商品库存
				usage: o.usage || 0,//商品类型
				freight: parseFloat(o.fee) || 0//运费
			});
		});
		orderObj = OrderData.splitOrderFn(proArr);
		$.extend(orderObj, {
			userMoney: data.RMB,
			userPoint: data.point,
			orderNo: obj.orderNo,
			payNo: obj.payNo,
			addrObj: JSON.parse(obj.address + ''),
			status: obj.status,
			buyDate: obj.buyDate,
			buyIp: obj.buyIp,
			createTime: obj.createTime,
			endDate: obj.endDate,
			id: obj.id,
			userName: obj.userName,
			userNo: obj.userNo,
			payDate: obj.payDate,
			version: obj.version
		});
		orderList.push(orderObj);
	});
	callback(orderList);
	return orderList;
}

//立即付款
function onBtnNowPayFn(data){
	Common.storageL(Common.localPay, JSON.parse(decodeURIComponent(data)));
	Common.openPage('../order/balance_ds.html', {neetPayInt: 'none'});
}

//取消订单
globalData.alertCauseData = [
	{id: '1', str: '我不想买了'},
	{id: '2', str: '信息填写错误，重新拍'},
	{id: '3', str: '其他原因'}
];
function onBtnCancelFn(orderNo){
	if(!orderNo){return false;}
	var str = '';
	$.each(globalData.alertCauseData, function(index, obj){
		str +=
			'<li class="xl-li icon-radio" onclick="selectCauseFn(this)" datastr="' + obj.str + '">'+
				'<a>'+
					'<div class="xl-li-txt">' + obj.str + '</div>'+
				'</a>'+
			'</li>';
	});
	str =
			'<ul class="xl-ul" id="causeListBox">'+
			str+
			'</ul>';
	Common.confirm('请选择取消原因', str, function(index){
		if(index == 1){
			var val = $('#causeListBox').find('.xl-li.active').attr('datastr');
			if(!val){
				Common.toast('请选择原因');
				return false;
			}
			var _url = '/ushop-api-merchant/api/mall/person/order/cancel',
				_param = {
					comment: val,
					orderNo: orderNo
				};
			Common.ajax(_url, 'post', JSON.stringify(_param), function(data) {
				if(data.data == 'SUCCESS'){
					removeOrderItem(orderNo);
					Common.toast('取消成功');
				}else{
					Common.toast('取消失败');
				}
			});
		}
	});
}
//选择原因
function selectCauseFn(me){
	var $me = $(me);
	if(!$me.hasClass('active')){
		$('#causeListBox').find('.xl-li').removeClass('active');
		$me.addClass('active');
	}
}

//删除订单
function removeOrderItem(orderNo){
	if(!orderNo){return false;}
	if($('#tabContent100.active').length > 0){//全部订单
		location.reload();
		return false;
	}
	var item = $('[order-no="' + orderNo + '"]');
	if(item.length > 0){
		item.remove();
		if($('[order-no]').length == 0){
			item.parent().find('.refreshPrompt').html('没有数据');
		}
	}
}

//提醒发货
function onBtnHintSendFn(){
	Common.toast('提醒成功！');
}


//确认收货
function onBtnTakeGoodsFn(orderNo){
	if(!orderNo){return false;}
	Common.confirm('提示', '是否对本订单下这些商品确认收货？', function(index){
		if(index == 1){
			var _url = '/ushop-api-merchant/api/mall/person/order/receive/' + orderNo;
			Common.ajax(_url, 'post', {}, function(data) {
				if(data.data == 'SUCCESS'){
					removeOrderItem(orderNo);
					Common.toast('操作成功');
				}else{
					Common.toast('操作失败');
				}
			});
		}
	});
}


//申请退货
function onBtnReturnGoodsFn(data){
	Common.openPage('select_return_pro.html', {orderObj: decodeURIComponent(data)});
}


//取消退货
function onBtnReturnNoFn(orderNo){
	if(!orderNo){return false;}
	Common.confirm('提示', '是否取消本次退货？', function(index){
		if(index == 1){
			var _url = '/ushop-api-merchant/api/mall/person/order/cancelPostBack/' + orderNo;
			Common.ajax(_url, 'post', {}, function(data) {
				if(data.data == 'SUCCESS'){
					removeOrderItem(orderNo);
					Common.toast('申请成功');
				}else{
					Common.toast('申请失败');
				}
			});
		}
	});
}
//去到晒单分享
function goSharePageFn(data){
	Common.storageL('ls_partly_share_order', JSON.parse(decodeURIComponent(data)));
	Common.openPage('../weixinmp/share_form.html?shareType=mall');
}
</script>
</body>
</html>
