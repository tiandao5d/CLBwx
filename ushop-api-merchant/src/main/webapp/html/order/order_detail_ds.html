<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>全部订单</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlco-box1 {
	position: relative;
	padding: 10px 50px 3px 15px;
	background: #fff url(../../image/icon/cadd_bg.png) left bottom repeat-x;
	background-size: auto 3px;
}
.xlco-box1 .icon {
	position: absolute;
	right: 15px;
	top: 50%;
	transform: translateY(-50%);
	-webkit-transform: translateY(-50%);
}
.xlco-p1 {
	line-height: 1;
	font-size: 1.1em;
	padding-left: 30px;
}
.xlco-p2 {
	color: #6f6f6f;
	line-height: 1.2;
	background: url(../../image/icon/cadd.png) left center no-repeat;
	background-size: 24px;
	text-align:justify;
	padding: 10px 0 10px 30px;
}
.xlco-noaddr {
	padding-bottom: 10px;
	text-align: center;
	font-size: 1.2em;
	color: #888;
}


.xlo-li:after {
	left: 10px;
	right: 10px;
}
.xlo-li {
	position: relative;
	padding: 10px 15px;
}
.xlo-li > img {
	position: absolute;
	left: 15px;
	top: 50%;
	transform: translateY(-50%);
	width: 50px;
	height: 50px;
}
.xlo-body {
	padding-left: 55px;
	line-height: 1.6;
}
.xlo-p1 {
	position: relative;
	color: #535353;
}
.xlo-p1 .xlo-s2 {
	position: absolute;
	right: 0;
	top: 0;
}
.xlo-c969696 {
	color: #969696;
}
.xlap-od-item {
	margin-top: 6px;
	background: #fff;
}
.xlap-od-p1 a {
	color: #009fe9;
}
.xlap-od-p1,
.xlap-od-p2 {
	padding: .3em 15px;
}
.xlap-od-p3 {
	padding: .5em 15px;
	background: #fff;
}
.xlap-slide {
	height: 1px;
	background: #c9c9c9;
	transform: scale(1, .5);
	margin: 0 5px;
}


.xlco-foot {
	bottom: 0;
	border-top: solid 1px #f6f6f6;
}
.xlco-foot-s1 {
	float: left;
	margin-right: 8px;
}
.xlco-foot-i1 {
	font-size: .9em;
	color: #959595;
	font-style: normal;
}
.xlco-foot-i2 {
	color: #ff2424;
	font-style: normal;
}
.xlco-foot-a1 {
	float: left;
	color: #fff;
	background: #ff7200;
	font-size: 1.3em;
	padding: 0 1em;
}

.xlod-box1 {
	position: relative;
	height: 6em;
	background: #ffc14a;
}
.xlod-center {
	position: absolute;
	left: 0;
	top: 50%;
	width: 100%;
	text-align: center;
	line-height: 1.4em;
	color: #fff;
	font-size: 1.2em;
	-webkit-transform: translateY(-50%);
	transform: translateY(-50%);
}
.xlco-lp3 {
	color: #888;
	padding: 0 15px;
}
.xlco-foot-p1 {
	padding: .8em 15px;
}
.xlco-foot-p1 .xlbtn {
	font-size: 1.1em;
	padding: .5em 1em;
	border-radius: .5em;
}
.xlco-foot-p1 .xlbtn:last-child {
	margin-left: 1.5em;
}
.xlco-foot-p1 .xlbtn.xlap-btn1 {
	color: #ff9e19;
	border-color: #ff9e19;
}


/*弹出窗选择原因*/
.xl-li.icon-radio:before {
    font-family: 'iconfont';
    position: absolute;
    right: 15px;
    top: 50%;
    color: #999;
    line-height: 1;
    margin-top: -0.5em;
    z-index: 2;
    font-size: 1.6em;
}
.xl-li.active.icon-radio:before {
    color: #ff5534;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">全部订单</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlod-box1">
		<div class="xlod-center" id="orderStatusBox"></div>
	</div>
	<div class="xlco-box1" id="userAddressBox"></div>
	<div id="orderDataBox"></div>
</div>
<div style="height: 5em;"></div>
<div class="xlco-foot xlele-box">
	<div class="xlele-content clearfix">
		<div class="xlco-foot-p1 pull-right" id="footBtnBox">
		</div>
	</div>
</div>
<script id="orderListTemplate"  type="text/template">
	{{~ it:data }}
		<div class="xlap-od-item" order-no="{{=data.orderNo}}">
			{{~ data.merchantArr:mitem}}
			<div class="xlap-od-p1">
				<div class="xlo-p1">
					<span class="xlo-s1"></span>
					<span class="xlo-s2">
						<a>{{=mitem.merchantName}}</a>发货
					</span>
				</div>
			</div>
			<ul class="xlo-ul">
				{{~mitem.proArr:item}}
				<li class="xlo-li">
					{{?item.headImage}}
					<img src="{{= Common.getImageUrl(item.headImage)}}">
					{{??}}
					<img src="../../../image/p200200.png">
					{{?}}
					<div class="xlo-body">
						<div class="xlo-p1">
							<span class="xlo-s1">{{=item.productName}}</span>
							<span class="xlo-s2">{{=item.checkedRule.payTypeText}}</span>
						</div>
						<div class="xlo-p1">
							<span class="xlo-s1 xlo-c969696">来自{{=mitem.merchantName}}</span>
							<span class="xlo-s2">x{{=item.buyCount}}</span>
						</div>
					</div>
				</li>
				{{~}}
			</ul>
			{{?data.merchantArr.length > 1}}
			<div class="xlap-od-p2">
				<div class="xlo-p1">
					<span class="xlo-s1">商品总价：</span>
					<span class="xlo-s2">{{=mitem.totalText}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运费：</span>
					<span class="xlo-s2"><small>￥</small>{{=mitem.totalFreight}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运单总价：</span>
					<span class="xlo-s2">{{=mitem.totalTextFM}}</span>
				</div>
			</div>
			{{?}}
			{{~}}
			<div class="xlap-od-p2">
				<div class="xlo-p1">
					<span class="xlo-s1">商品总价：</span>
					<span class="xlo-s2">{{=data.totalText}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运费：</span>
					<span class="xlo-s2"><small>￥</small>{{=data.totalFreight}}</span>
				</div>
				<div class="xlo-p1">
					<span class="xlo-s1">运单总价：</span>
					<span class="xlo-s2">{{=data.totalTextFM}}</span>
				</div>
			</div>
			<div class="xlap-slide"></div>
			<div class="xlap-od-p2">
				{{?data.orderNo}}<div class="xlo-c969696">订单号：{{=data.orderNo}}</div>{{?}}
				{{?data.buyDate}}<div class="xlo-c969696">创建时间：{{=data.buyDate}}</div>{{?}}
				{{?data.payDate}}<div class="xlo-c969696">付款时间：{{=data.payDate}}</div>{{?}}
			</div>
		</div>
	{{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	var orderObj = globalData.pageParam.orderObj || '{}',
		addrObj;
	orderObj = JSON.parse(orderObj);
	addrObj = orderObj.addrObj;
	globalData.orderObj = orderObj;
	var dataListTemplate = doT.template(document.getElementById('orderListTemplate').innerHTML);
	document.getElementById('orderDataBox').innerHTML = dataListTemplate([orderObj]);
	statusInitFn(orderObj);
	
	var addrBox = document.getElementById('userAddressBox');
	if(addrObj){
		var str1 =  '<div class="xlco-p1 clearfix">'+
						'<span class="pull-left">收件人：' + addrObj.consignee + '</span>'+
						'<span class="pull-right">' + addrObj.phone + '</span>'+
					'</div>'+
					'<div class="xlco-p2">' + addrObj.province + addrObj.city + addrObj.district + addrObj.address + '</div>';
		addrBox.innerHTML = str1;
	}else{
		addrBox.classList.add('hide');
	}
}
//dom事件绑定
function domEventFn(){
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//待付款倒计时初始化
function dfkInitFn(orderObj){
	Common.getServiceTT(function(curT){
		var endT = (new Date(orderObj.endDate)).getTime();
		dfkTimeoutFn(curT, endT);
		setInterval(function(){
			dfkTimeoutFn((curT += 1000), endT);
		}, 1000);
	}, false);
}

//globalData.orderStatus = [
//	{status: -1,  statusName: '废弃'},
//	{status: 1,   statusName: '不可见'},
//	{status: 98,  statusName: '未支付'},
//	{status: 99,  statusName: '支付超时'},
//	{status: 100, statusName: '已支付'},
//	{status: 101, statusName: '待发货'},
//	{status: 102, statusName: '待收货'},
//	{status: 103, statusName: '待晒单'},
//	{status: 104, statusName: '申请退货'},
//	{status: 105, statusName: '同意回收'},
//	{status: 198, statusName: '订单退款'},
//	{status: 199, statusName: '订单取消'},
//	{status: 200, statusName: '订单完成'},
//]
function statusInitFn(orderObj){
	var btnStr = '',
		orderStatus = orderObj.status,
		orderType = '',
		titleStr = '';
	switch(orderStatus){
		case 98 : orderType = 'dfk';break;//待付款
		case 100: orderType = 'dfh';break;//待发货，已支付
		case 101: orderType = 'dfh';break;//待发货，待发货
		case 102: orderType = 'dsh';break;//待收货
		case 103: orderType = 'dsd';break;//待晒单
		case 104: orderType = 'th'; break;//退货，申请退货
		case 105: orderType = 'th'; break;//退货，同意回收
		case 198: orderType = 'th'; break;//退货，订单退款
		case 199: orderType = 'yqx';break;//已取消
	}
	switch(orderType){
		case 'dfk':
		dfkInitFn(orderObj);
		btnStr = '<button class="xlbtn" onclick="onBtnCancelFn(\'' + orderObj.orderNo + '\')">取消订单</button>'+
				 '<button class="xlbtn xlap-btn1"onclick="onBtnNowPayFn(\'' + encodeURIComponent(JSON.stringify(orderObj)) + '\')">立即付款</button>';
		break;
		case 'dfh':
		titleStr = '<div>等待卖家发货</div>';
		btnStr = '<button class="xlbtn" onclick="onBtnCancelFn(\'' + orderObj.orderNo + '\')">取消订单</button>'+
				 '<button class="xlbtn"onclick="onBtnHintSendFn(\'' + orderObj.orderNo + '\')">提醒发货</button>';
		break;
		case 'dsh':
		titleStr = '<div>等待买家收货</div>';
		btnStr = '<button class="xlbtn" onclick="onBtnReturnGoodsFn(\'' + encodeURIComponent(JSON.stringify(orderObj)) + '\')">申请退货</button>'+
				 '<button class="xlbtn"onclick="onBtnTakeGoodsFn(\'' + orderObj.orderNo + '\')">确认收货</button>';
		break;
		case 'dsd':
		titleStr = '<div>交易完成</div>';
//		btnStr = '<button class="xlbtn"onclick="goSharePageFn(\'' + encodeURIComponent(JSON.stringify(orderObj)) + '\')">晒单分享</button>';
		btnStr = '交易完成';
		break;
		case 'th':
		if(orderStatus == 104){
			titleStr = '<div>已申请退货，卖家处理中……</div>';
			btnStr = '<button class="xlbtn" onclick="onBtnReturnNoFn(\'' + orderObj.orderNo + '\')">取消退货</button>';
		}else if(orderStatus == 105){
			titleStr = '<div>退货已受理，请尽快将商品寄回并等待退款</div>';
			btnStr = '退货已受理，请尽快将商品寄回并等待退款';
		}else if(orderStatus == 198){
			titleStr = '<div>已退款，交易关闭</div>';
			btnStr = '已退款，交易关闭';
		}
		break;
		case 'yqx':
			titleStr = '<div>已取消</div>';
			btnStr = '已取消';
		break;
	}
	if(titleStr){
		document.getElementById('orderStatusBox').innerHTML = titleStr;
	}
	if(btnStr){
		document.getElementById('footBtnBox').innerHTML = btnStr;
	}
}


//倒计时
function dfkTimeoutFn(curT, endT){
	var differ = endT - curT,
		hT = 60*60*1000,
		iT = 60*1000;
	var h = 0, m = 0, s = 0, str = '';
	if(differ > 0){
		h = parseInt(differ/hT),
		m = parseInt((differ%hT)/iT),
		s = parseInt((differ%iT)/1000);
		if(h > 0){str += h + '小时';}
		if(m > 0){str += m + '分钟';}
		if(s > 0){str += s + '秒';}
		if(str){
			str = 	'<div>等待买家付款</div>'+
					'<small>剩 <i class="color-ff5534">' + str + '</i>订单就自动关闭<small>';
			document.getElementById('orderStatusBox').innerHTML = str;
			return false;
		}
	}
	str = 	'<div>等待买家付款</div>'+
			'<small><i class="color-ff5534">订单即将关闭</i></small>';
	document.getElementById('orderStatusBox').innerHTML = str;
}

//立即付款
function onBtnNowPayFn(data){
	Common.openPage('balance_ds.html', {orderObj: decodeURIComponent(data)});
}

//取消订单
globalData.alertCauseData = [
	{id: '1', str: '我不想买了'},
	{id: '2', str: '信息填写错误，重新拍'},
	{id: '3', str: '其他原因'}
];
function onBtnCancelFn(orderNo){
	if(!orderNo){return false;}
	var str = '';
	$.each(globalData.alertCauseData, function(index, obj){
		str +=
			'<li class="xl-li icon-radio" onclick="selectCauseFn(this)" datastr="' + obj.str + '">'+
				'<a>'+
					'<div class="xl-li-txt">' + obj.str + '</div>'+
				'</a>'+
			'</li>';
	});
	str =
			'<ul class="xl-ul" id="causeListBox">'+
			str+
			'</ul>';
	Common.confirm('请选择取消原因', str, function(index){
		if(index == 1){
			var val = $('#causeListBox').find('.xl-li.active').attr('datastr');
			if(!val){
				Common.toast('请选择原因');
				return false;
			}
			var _url = '/ushop-api-merchant/api/mall/person/order/cancel',
				_param = {
					comment: val,
					orderNo: orderNo
				};
			Common.ajax(_url, 'post', JSON.stringify(_param), function(data) {
				if(data.data == 'SUCCESS'){
					history.go(-1);
					Common.toast('取消成功');
				}else{
					Common.toast('取消失败');
				}
			});
		}
	});
}

//选择原因
function selectCauseFn(me){
	var $me = $(me);
	if(!$me.hasClass('active')){
		$('#causeListBox').find('.xl-li').removeClass('active');
		$me.addClass('active');
	}
}


//提醒发货
function onBtnHintSendFn(){
	Common.toast('提醒成功！');
}


//确认收货
function onBtnTakeGoodsFn(orderNo){
	if(!orderNo){return false;}
	Common.confirm('提示', '是否对本订单下这些商品确认收货？', function(index){
		if(index === 1){
			var _url = '/ushop-api-merchant/api/mall/person/order/receive/' + orderNo;
			Common.ajax(_url, 'post', {}, function(data) {
				if(data.data == 'SUCCESS'){
					history.go(-1);
					Common.toast('操作成功');
				}else{
					Common.toast('操作失败');
				}
			});
		}
	});
}


//申请退货
function onBtnReturnGoodsFn(data){
	Common.openPage('select_return_pro.html', {orderObj: decodeURIComponent(data)});
}


//取消退货
function onBtnReturnNoFn(orderNo){
	if(!orderNo){return false;}
	Common.confirm('提示', '是否取消本次退货？', function(index){
		if(index == 2){
			var _url = '/ushop-api-merchant/api/mall/person/order/cancelPostBack/' + orderNo;
			Common.ajax(_url, 'post', {}, function(data) {
				if(data.data == 'SUCCESS'){
					history.go(-1);
					Common.toast('申请成功');
				}else{
					Common.toast('申请失败');
				}
			});
		}
	});
}

</script>
</body>
</html>
