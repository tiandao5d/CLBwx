<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>我的奖券</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 3em;
	text-align: center;
	font-size: 1.2em;
	font-weight: 500;
	border-bottom: solid 1px #eee;
}
.xl-tab-title .xl-tab-hitem {
	float: left;
	width: 33.3333%;
	color: #333;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}


.xl-li .xl-li-img {
    border-radius: 0;
    width: 6em;
    height: 4em;
    margin-top: -2em;
    background: url(../../image/img/lucky_icon1.png) no-repeat;
    background-size: 100% 100%;
    text-align: center;
}
.xl-li .xl-li-img img {
    height: 80%;
    margin-top: 5%;
}
.xl-li .xl-li-txt {
    line-height: 1.4;
    color: #939393;
    padding-left: 6.5em !important;
    padding-right: 5.5em;
}
.xl-li .xl-li-txt h5 {
    color: #333;
    font-size: 1.1em;
}
.xl-li .xlly-btn {
    position: absolute;
    right: 15px;
    top: 50%;
    margin-top: -1em;
    color: #888;
}
.xl-li .xlly-btn button {
    line-height: 2em;
    border: 0;
    background: #ff5534;
    border-radius: .3em;
    color: #fff;
    width: 5em;
    font-size: 1em;
}
.xl-li .xlly-btn button:active {
    opacity: .8;
}
.em05 {
    width: 0.5em;
    height: 1px;
    display: inline-block;
}
.clolor007eff {
    color: #007eff !important;
}

.modal-box1 h4 {
    font-size: 1.2em;
}
.modal-box1 input {
    display: block;
    width: 100%;
    padding: .5em .8em;
    border-radius: .3em;
    margin: .6em 0;
}
.modal-box1 p {
    color: #999;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">我的奖券</h1>
	</div>
</div>
<div class="xlele-box xl-tab-fixed">
	<div class="xlele-content">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" sort="1" onclick="onTabTitleFn(this)">全部</a>
			<a class="xl-tab-hitem" datahref="#tabContent2" sort="1" onclick="onTabTitleFn(this)">已中奖</a>
			<a class="xl-tab-hitem" datahref="#tabContent3" sort="1" onclick="onTabTitleFn(this)">未开奖</a>
		</div>
	</div>
</div>
<div style="height: 44px;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent11">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent12">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent21">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent22">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent31">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent32">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script id="tabListTemplate"  type="text/template">
    {{~ it:data}}
        <div class="xl-li xl-lii {{=('paperid' + data.id)}}">
            <a>
            	<div class="xl-li-img"><img src="{{=Common.getImageUrl(data.levelObj.url)}}"></div>
                <div class="xl-li-txt">
                    <h5 class="ellipsis">{{=data.levelObj.title}}</h5>
                    <div class="ellipsis">开奖时间：{{=timeFormtFn(data.drawTime)}}</div>
                    <div class="ellipsis">奖<i class="em05"></i>券<i class="em05"></i>号：{{=data.featureCode}}</div>
                    <div class="ellipsis">开奖状态：<i class="clolor007eff">{{?data.status == 1}}未开奖{{??data.status == 2}}未中奖{{??data.status == 3}}已中奖{{?}}</i></div>
                    {{?data.status == 3}}
                    <div class="ellipsis">截止日期：{{=timeFormtFn(data.cashTime).substr(0, 10)}}</div>
                    {{?}}
                </div>
                <div class="btn_status xlly-btn">
                    <!-- 已中奖状态 -->
                    {{?data.status == 3}}
                        <!-- 可以请求兑奖 -->
                        {{?data.logistics == 0}}
                            <!-- 实体类奖品 -->
                            {{?data.levelObj.prizeType == 1}}
                            <button onclick="savePhoneNumFn('{{=data.levelObj.prizeType}}', '{{=data.id}}')">填写地址</button>
                            <!-- 充值类奖品 -->
                            {{??data.levelObj.prizeType == 2}}
                            <button onclick="savePhoneNumFn('{{=data.levelObj.prizeType}}', '{{=data.id}}', '{{=encodeURIComponent(JSON.stringify(data.levelObj))}}')">填写手机号</button>
                            <!-- 劵码类奖品 -->
                            {{??data.levelObj.prizeType == 3}}
                            <button onclick="savePhoneNumFn('{{=data.levelObj.prizeType}}', '{{=data.id}}')">兑奖</button>
                            {{?}}
                        <!-- 已兑奖 -->
                        {{??data.logistics == 1}}
                        待发奖
                        <!-- 已发奖 -->
                        {{??data.logistics == 2}}
                            <!-- 实体类奖品 -->
                            {{?data.levelObj.prizeType == 1}}
                            <button onclick="showAddressFn('{{=data.expressNo}}', '{{=data.expressCompany }}', '{{=data.expressRemarks }}', '{{=data.consignee }}')">券码信息</button>
                            <!-- 充值类奖品 -->
                            {{??data.levelObj.prizeType == 2}}
                            <button onclick="showRechargeFn('{{=data.expressNo}}', '{{=data.expressCompany }}', '{{=data.expressRemarks }}', '{{=data.consignee }}')">券码信息</button>
                            <!-- 劵码类奖品 -->
                            {{??data.levelObj.prizeType == 3}}
                            <button onclick="showTicketDataFn('{{=data.expressNo}}', '{{=data.expressCompany }}', '{{=data.expressRemarks }}', '{{=data.consignee }}')">券码信息</button>
                            {{?}}
                        {{?}}
                    {{?}}
                </div>
            </a>
        </div>
    {{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script type="text/javascript">
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
	globalData.gameId = globalData.pageParam.gameId;
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var active = $('#tabTitleBox').find('.active'),
			datahref = active.attr('datahref') + (active.attr('sort') || '');
		getTabDataFn(datahref);
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	if ( !globalData.gameId ) {
		Common.toast('缺少游戏ID');
		return false;
	}
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent1';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	
	// 请求期次奖等数据
	Common.ajaxAll([
		{url: (Common.domainUrl + '/ushop-api-merchant/api/lotto/game/get/' + globalData.gameId)},
		{url: (Common.domainUrl + '/ushop-api-merchant/api/lotto/issue/visible/listBy/1/' + globalData.gameId)}
	], function () {
		var gdata = arguments[0],
			idata = arguments[1];
		if ( !( gdata.prizes && idata.recordList ) ) {
			Common.toast('数据错误！');
			return false;
		}
		try {
			gdata.prizesArr = JSON.parse(gdata.prizes);
		} catch (err) {
			gdata.prizesArr = [];
		}
		globalData.gameData = gdata;
		onTabTitleFn($('[datahref="' + datahref + '"]')[0]); // 请求列表数据
	});
}

//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me);
	if($me.hasClass('active')){//本就是选中状态，做一下操作
		if($me.attr('sort') === undefined){//如果未定义排序，则阻止点击事件
			return false;
		}
		//否则修改排序
		$me.attr('sort', ($me.attr('sort') === '1' ? '2' : '1'));
	}
	var datahref = $me.attr('datahref') + ($me.attr('sort') || ''),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	getTabDataFn(datahref);
}

//获取订单数据列表
function getTabDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('tabListTemplate'),
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来确定请求的地址
	var sort = $('#tabTitleBox').find('.active').attr('sort') || '';
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	switch(datahref){
		case ('#tabContent1' + sort)://全部
		typenum = '100';
		break;
		case ('#tabContent2' + sort)://已中奖
		typenum = '3';
		break;
		case ('#tabContent3' + sort)://未开奖
		typenum = '1';
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url =  '/ushop-api-merchant/api/lotto/ticket/user/listBy',
		_param = {
			'page': currentPage,
			'gameId': globalData.gameId,
			'status': typenum,
			'date': ''
		};
	Common.ajax(_url, 'get', _param, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
            Common.each(data.recordList, function(index, obj){
                obj.levelObj = {};
                Common.each(globalData.gameData.prizesArr, function(pi, po){
                    if(po.index == obj.prizeId){
                        obj.levelObj = po;
                        return false;
                    }
                });
            });
			
			var dataListTemplate = doT.template(template.innerHTML);
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent[0].innerHTML = dataListTemplate(data.recordList);
			}else{
				listContent[0].innerHTML += dataListTemplate(data.recordList);
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	});
}


//时间格式化，20170506101010
//这种时间的格式化为 2017-05-06 10:10:10
function timeFormtFn(a){
	if(!a){return ''};
	var y = a.substr(0, 4),
		m = a.substr(4, 2),
		d = a.substr(6, 2),
		h = a.substr(8, 2),
		i = a.substr(10, 2),
		s = a.substr(12, 2);
	return y + '-' + m + '-' + d + ' ' + h + ':' + i + ':' + s;
}

//输入手机号，地址弹窗
function savePhoneNumFn(status, id, levelObj){
    globalData.ticketId = id;
    if(status == 1){//实体奖品
        Common.openPage('../address/address.html', {lcTicketId: id, gameId: globalData.gameId});
    }else if(status == 2){//充值类
        if(levelObj){
            levelObj = JSON.parse(decodeURIComponent(levelObj))
        }
        var tstr = (levelObj ? (levelObj.name + '<div>' + levelObj.title + '</div>') : '提示'),
            cstr = '<div class="modal-box1"><h4>手机号</h4><input class="phone_ipt" type="text"><p>请填写对应运营商手机号，无法二次修改</p></div>';
        Common.confirm(tstr, cstr, function(index){
            if ( index === 1 ) {
                var phone = document.querySelector('.phone_ipt').value;
                if(!Common.regExpPhone.test(phone)){
                    Common.toast('手机号有误！');
                    return false;
                }
                var _param = {
                    id: globalData.ticketId,
                    phone: phone,
                    address: '',
                    zipCode: '',
                    consignee: ''
                };
                submitCashFn(_param);
            }
        }, ['取消','提交']);
    }else if(status == 3){//券码
        var _param = {
            id: globalData.ticketId,
            phone: '',
            address: '',
            zipCode: '',
            consignee: ''
        };
        submitCashFn(_param);
    }
}

//提交兑奖
function submitCashFn(_param){
    var _url = '/ushop-api-merchant/api/lotto/ticket/user/cash';
    Common.ajax(_url, 'post', JSON.stringify(_param), function (data) {
        if(data.result === 'SUCCESS'){
            $('.paperid' + _param.id).find('.btn_status').html('待发奖');
            Common.toast('提交成功！');
        }else{
            Common.toast(data.error_description || '操作失败！');
        }
    })
}
//弹窗显示券码数据
function showTicketDataFn(expressNo, expressCompany, expressRemarks, consignee){
    var str =
        '<div>券码：' + (expressNo || '没有券码') + '</div>'+
        '<div>' + (expressCompany || '第一步') + '</div>'+
        '<div>' + (expressRemarks || '第二步') + '</div>'+
        '<div>' + (consignee || '第三步') + '</div>';
    Common.confirm('提示', str, function(index){
        if(index === 1){
            copyClipboardFn(expressNo);
        }
    }, ['取消', '复制券码']);
}

//复制到剪贴板
function copyClipboardFn(val){
    try{
    	var ipt = document.createElement('textarea');
    	ipt.value = val || '没有内容';
    	ipt.style.position = 'absolute';
    	ipt.style.left = '999999px';
    	document.body.appendChild(ipt);
    	ipt.select();
    	document.execCommand("Copy"); // 执行浏览器复制命令
    	Common.toast('复制成功');
    	document.body.removeChild(ipt);
    }catch(err){}
}

//显示地址信息数据
function showAddressFn(expressNo, expressCompany, expressRemarks, consignee){
    var str =
        '<div>物流名：' + (expressCompany || '　') + '</div>'+
        '<div>运单号：' + (expressNo || '　') + '</div>'+
        '<div>客　服：' + (expressRemarks || '　') + '</div>'+
        '<div>收件人：' + (consignee || '　') + '</div>';
    Common.confirm('提示', str, null, '确定');
}

//显示充值单号
function showRechargeFn(expressNo){
    var str =
        '<div>充值单号' + (expressNo || '　') + '</div>';
    Common.confirm('提示', str, null, '确定');
}
</script>
</body>
</html>