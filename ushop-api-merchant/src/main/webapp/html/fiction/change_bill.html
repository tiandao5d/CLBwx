<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>兑换账单</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlcb-title {
	top: 0;
	z-index: 20;
}
.xlcb-title .xllr-box {
	line-height: 32px;
	font-size: 15px;
	color: #434343;
}
.xlcb-title .xlele-content {
	padding: 0 15px;
}

.xlcb-li {
	position: relative;
	padding: 8px 15px;
	color: #535353;
	background: #fff;
	line-height: 20px;
}
.xlcb-li:after {
	content: '';
	position: absolute;
	left: 0;
	right: 0;
	bottom: 0;
	height: 1px;
	background: #a0a0a0;
	-webkit-transform: scaleY(.5);
	transform: scaleY(.5);
}
.xlcb-li:last-child:after {
	content: normal;
}
.xlcb-li .xllr-l {
	padding-right: 30%;
}
.xlcb-li .xllr-r {
	font-size: 15px;
	top: 50%;
	margin-top: -10px;
}
.xlcb-p1 {
	color: #959595;
}
.xlcb-head-fixed {
	top: 32px;
	left: 0;
	right: 0;
	z-index: 10;
}
.xlcb-hp1 {
	padding: 0 15px;
	line-height: 34px;
	height: 34px;
	background: #eee;
	font-size: 15px;
}
.xlcb-hp2 {
	position: absolute;
	right: 0;
	top: 0;
	padding: 7px 15px;
}
.xlcb-hp2 img {
	height: 20px;
}

.xlcb-modal {
	left: 100%;
	top: 0;
	width: 100%;
	height: 100%;
	z-index: 100;
	-webkit-transition: all .3s;
	transition: all .3s;
}
.xlcb-modal.active {
	left: 0;
}
.xlcb-modal .xlele-content {
	width: 100%;
	height: 100%;
}
.mds-cut-btn {
	position: absolute;
	left: 10%;
	top: 10px;
	padding: 3px 12px;
	font-size: 13px;
	border-radius: 100px;
	border: solid 1px #ccc;
	background: #eee;
}
.mds-ipt-box {
	position: relative;
	width: 260px;
	margin: 0 auto;
}
.mds-ipt-box:before {
	content: '';
	position: absolute;
	top: 50%;
	height: 2px;
	left: 48%;
	width: 4%;
	background: #ccc;
}
.mds-ipt-box i,
.mds-ipt-mon {
	float: left;
	width: 45%;
	height: 30px;
	line-height: 30px;
	text-align: center;
	border-bottom: solid 1px #ccc;
	color: #333;
	-webkit-transition: all .3s;
	transition: all .3s;
}
.mds-laydate-m {
	display: none;
}
.mds-ipt-mon {
	display: none;
	float: none;
	margin: 0 auto;
}
.mds-ipt-box i:last-child {
	float: right;
}
.mds-ipt-box i.active,
.mds-ipt-mon {
	color: #ff7200;
}
.mds-ipt-box i.d_highlight,
.mds-ipt-mon.d_highlight {
	-webkit-animation: d_highlight .5s;
	animation: d_highlight .5s;
}
@-webkit-keyframes d_highlight{
	from{color: #333;}
	to{color: #ff7200;}
}
@keyframes d_highlight{
	from{color: #333;}
	to{color: #ff7200;}
}
.mds-btn-box {
	width: 260px;
	margin: 0 auto;
	padding-top: 20px;
}
.mds-btn-box button {
	float: left;
	border: 0;
	background: #ff7200;
	padding: 6px 20px;
	border-radius: 5px;
	color: #fff;
	font-size: 14px;
}
.mds-btn-box button:last-child {
	float: right;
}
.mds-btn-box button:active {
	opacity: .8;
}
.mds-laydate {
	position: absolute;
	bottom: 0;
	left: 0;
	right: 0;
}
.layui-laydate-static,
.layui-laydate-main,
.layui-laydate-content,
.layui-laydate-content table {
	width: 100% !important;
}
.month-active .mds-ipt-box,
.month-active .mds-laydate {
	display: none;
}
.month-active .mds-laydate-m,
.month-active .mds-ipt-mon {
	display: block;
}

/*详情*/

.xlbd-box1 {
	text-align: center;
	font-size: 15px;
	line-height: 2em;
	background: #fff;
	margin-bottom: 1px;
	padding-bottom: 10px;
}
.xlbd-p1 {
	color: #707070;
}
.xlbd-p2 {
	color: #434343;
	font-size: 24px;
}
.xlbd-p3 {
	color: #959595;
}
.xlbd-box2 {
	background: #fff;
	padding: 5px 0;
}
.xlbd-li {
	font-size: 15px;
	padding: 5px 15px;
	color: #535353;
	line-height: 22px;
}
.xlbd-cno {
	font-size: 12px;
}
.xlbd-p4 {
	text-align: right;
	font-size: 12px;
	color: #959595;
}

.xlcb-tp1 {
	text-align: right;
	padding-bottom: 10px;
}
.xlcb-tp1 .xl-btn {
	background: #ff841a;
	color: #fff;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">兑换账单</h1>
	</div>
</div>
<div class="xlele-box xlcb-title">
	<div class="xlele-content">
		<div class="xllr-box" id="totalmd_box">
			<div>今日收入：00</div>
			<div class="xllr-r">本月总收入：00</div>
		</div>
		<div class="xlcb-tp1"><a href="../fiction/withdrawal.html" class="xl-btn">对账提现</a></div>
	</div>
</div>
<div class="xlele-box xlcb-head-fixed">
	<div class="xlele-content">
		<div class="xlcb-hp1" id="bill_section">0000-00-00</div>
		<div class="xlcb-hp2" onclick="billModalSH('bill_mds', 'show')"><img src="../../image/icon/fiction_icon001.png"></div>
	</div>
</div>
<div style="height: 66px;"></div>
<div class="xlbody-box">
	<div id="bill_box">
		<ul class="tabBody"></ul>
		<div class="xl-refresh-prompt refreshPrompt"></div>
	</div>
</div>
<div class="xlele-box xlcb-modal" id="bill_mds">
	<div class="xlele-content">
		<div class="mds-cut-btn" onclick="cutDateTypeFn(this)">当前按日选择</div>
		<div style="height: 50px;"></div>
		<div class="mds-ipt-box clearfix">
			<i class="laydate_ipt mds_lipt start"></i>
			<i class="laydate_ipt mds_lipt end"></i>
		</div>
		<div class="mds-ipt-mon mds_lipt laydate_ipt_m"></div>
		<div class="mds-btn-box clearfix">
			<button onclick="billModalSH('bill_mds', 'hide')">取消</button>
			<button onclick="confirmDateFn()">确定</button>
		</div>
		<div class="mds-laydate" id="laydate_box"></div>
		<div class="mds-laydate mds-laydate-m" id="laydate_month"></div>
	</div>
</div>
<div class="xlele-box xlcb-modal" id="bill_bds"></div>
<script id="bill_template" type="text/template">
	{{~it:data}}
		<div class="xlcb-li" onclick="showDetailsFn('{{=encodeURIComponent(JSON.stringify(data))}}')">
			<div class="xllr-box">
				<div class="xllr-l">
					<div class="ellipsis">{{=data.fundTypeName}}</div>
					<div class="ellipsis xlcb-p1">{{=data.ttxt}}</div>
				</div>
				<div class="xllr-r">+{{=data.balance}}</div>
			</div>
		</div>
	{{~}}
</script>
<script id="bill_bds_template" type="text/template">
	<div class="xlele-content">
		<div class="xlbd-box1">
			<div class="xlbd-p1">兑换：{{=it.fundTypeName}}</div>
			<div class="xlbd-p2">+{{=it.balance}}</div>
			<div class="xlbd-p3">交易成功</div>
		</div>
		<div class="xlbd-box2">
			<div class="xlbd-li">
				<div class="xllr-box">
					<div>创建时间</div>
					<div class="xllr-r">{{=it.consumeTime}}</div>
				</div>
			</div>
			<div class="xlbd-li">
				<div class="xllr-box">
					<div>订单号</div>
					<div class="xllr-r xlbd-cno">{{=it.couponsNo}}</div>
				</div>
			</div>
			<div class="xlbd-li">
				<div class="xllr-box">
					<div>兑换站点</div>
					<div class="xllr-r">{{=it.addr}}</div>
				</div>
				<div class="xlbd-p4 ellipsis">{{=it.address}}</div>
			</div>
		</div>
		<div style="width: 260px; margin: 30px auto; 0">
			<button class="xl-btn xl-btn-block" onclick="billModalSH('bill_bds', 'hide')">返回</button>
		</div>
	</div>
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/laydate/laydate.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
	dateChangeFn();//时间选择相关事件绑定
	//到底部加载
	Common.scrollBottom(function(){
		getBillDataFn();
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getDromoter(function(){
		getTotalMD();//获取当月和当日的收入
		
		//兑换流水初始化请求
		var dt = Common.msToTime(new Date()),
			suffixStr = 'bill';
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
		$('#bill_section').text(dt.em);
		getBillDataFn((dt.em + '-01') + '/' + (dt.em + '-' + laydate.getEndDate(dt._m, dt._y)));
	});
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//显示详情
function showDetailsFn(data){
	try{
		data = JSON.parse(decodeURIComponent(data));
	}catch(err){
		data = {};
	}
	var _template = doT.template($('#bill_bds_template').html());
	billModalSH('bill_bds', 'show');
	$('#bill_bds').html(_template(data));
}

//获取推广员数据
function getDromoter(callback){
	callback = callback || function(){};
	Common.generalL(function(data){
		if(data.id){
			var type = data.type;
			if(type === 1){
				globalData.promoterData = data;
				callback();
			}else{
				Common.toast(((type === 2) ? '您不是站主！' : '数据错误'));
			}
		}else{
			Common.toast(data.error_description || '未知错误');
		}
	});
}

//时间改变事件监听
function dateChangeFn(){
	var bill_mds = $('#bill_mds'),
		laydate_ipt = bill_mds.find('.laydate_ipt'),
		$me = laydate_ipt.eq(0),
		$mon = bill_mds.find('.laydate_ipt_m');
	var layd = laydate.render({//初始化日历选择器
		elem: '#laydate_box', //指定元素
		position: 'static',
		showBottom: false,
		max: (Common.msToTime(new Date()).ed),
		ready: function(_date){
			_date.month -= 1;
			$me.addClass('active').text(formatDate(_date).ed);
		},
		done: function(val, date){
			$me.text(val).addClass('d_highlight');
		}
	});
	var laydm = laydate.render({//初始化月份选择器
		elem: '#laydate_month',
		type: 'month',
		position: 'static',
		showBottom: false,
		max: (Common.msToTime(new Date()).em),
		ready: function(_date){
			_date.month -= 1;
			$mon.addClass('active').text(formatDate(_date).em);
		},
		change: function(val, date){
			$mon.text(val).addClass('d_highlight');
		}
	});
	
	
	//绑定日期容器点击事件
	laydate_ipt.on('click', function(){
		$me.removeClass('active');
		$me = $(this);
		$me.addClass('active');
		if(!$me.text()){
			$me.text(formatDate(layd.config.dateTime).ed);
		}
	});
	
	//选中时间后高亮
	$('.mds_lipt').on('webkitAnimationEnd animationend', function(){
		$(this).removeClass('d_highlight');
	});
	
	
	//格式化特殊时间对象
	function formatDate(dObj){
		var y = dObj['year'],
			m = dObj['month'] + 1,
			d = dObj['date'];
		y = (y + '');
		m = m < 10 ? ('0' + m) : ('' + m);
		d = d < 10 ? ('0' + d) : ('' + d);
		return {
			em: (y + '-' + m),
			ed: (y + '-' + m + '-' + d)
		}
	}
}
//时间间隔选择页面显示隐藏
function billModalSH(id, type){
	if(!globalData.promoterData){return false;}
	if(type === 'show'){
		$('#' + id).addClass('active');
	}else if(type === 'hide'){
		$('#' + id).removeClass('active');
	}
}

//日期选择方式切换
function cutDateTypeFn(me){
	var bill_mds = $('#bill_mds'),
		$me = $(me);
	if(bill_mds.hasClass('month-active')){
		bill_mds.removeClass('month-active');
		$me.text('当前按日选择');
	}else{
		bill_mds.addClass('month-active');
		$me.text('当前按月选择');
	}
}

//日期确定提交
function confirmDateFn(){
	var bill_mds = $('#bill_mds'),
		start = bill_mds.find('.start').text(),
		end = bill_mds.find('.end').text(),
		mt = bill_mds.find('.laydate_ipt_m').text();
	if(bill_mds.hasClass('month-active')){
		if(!mt){
			Common.toast('请选择月份！');
			return false;
		}
		start = mt + '-01';
		end = mt + '-' + laydate.getEndDate(parseInt(mt.substr(5, 2)), parseInt(mt.substr(0, 4)));
		$('#bill_section').text(mt);
	}else{
		$('#bill_section').text(start + ' ~ ' + end);
	}
	var sn = parseInt(start.replace(/\-/g, '')),
		en = parseInt(end.replace(/\-/g, ''));
	if(en >= sn){
		billModalSH('bill_mds', 'hide');
		getBillDataFn((start + '/' + end));
	}else if(!sn){
		Common.toast('请选择开始时间！');
	}else if(!en){
		Common.toast('前选择结束时间！');
	}else{
		Common.toast('结束时间必须大于等于开始时间！');
	}
}

//数据请求
function getBillDataFn(typenum){
	var suffixStr = 'bill',
		listItem = $('#bill_box'),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('bill_template'),
		currentPage = typenum ? 0 : globalData['currentPage' + suffixStr],//如果有传输查询过来为重新查询
		pagePage = typenum ? 1 : globalData['pagePage' + suffixStr],
		typenum = typenum || globalData['searchDateSection'];//用来确定请求的地址
	globalData['searchDateSection'] = typenum;//记录查询的时间间隔
	if(!typenum){return false;};
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url = '/ushop-api-merchant/api/user/coupons/gift/use/bills/listBy/'+
			   currentPage + '/10/' + typenum;
	Common.ajax(_url, 'get', {}, function(data){
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var oy, om, 
				addr = globalData.promoterData.stationProvince + globalData.promoterData.stationCity;
			Common.each(data.recordList, function(index, obj){
				oy = parseInt(obj['consumeTime'].substr(0, 4));
				om = parseInt(obj['consumeTime'].substr(5, 2));
				obj.ttxt = obj['consumeTime'];
				obj.htxt = oy + '年' + om + '月';
				obj.address = '';
				obj.addr = addr;
			});
			
			
			var dataListTemplate = doT.template(template.innerHTML);
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent[0].innerHTML = dataListTemplate(data.recordList);
			}else{
				listContent[0].innerHTML += dataListTemplate(data.recordList);
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	})
}

//获取当月和当日的收入
function getTotalMD(){
	var _url = '/ushop-api-merchant/api/user/coupons/gift/use/bills/total/get';
	Common.ajax(_url, 'get', {}, function(data){
		var d = data.daily || 0,
			m = data.monthly || 0;
		$('#totalmd_box').html(
			'<div>今日收入：' + d + '</div>'+
			'<div class="xllr-r">本月总收入：' + m + '</div>'
		);
	});
}
</script>
</body>
</html>
