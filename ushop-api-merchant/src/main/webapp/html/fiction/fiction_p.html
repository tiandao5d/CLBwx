<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>虚拟物品</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlact-box1 {
	position: relative;
}
.xlact-box1 > img {
	vertical-align: top;
	width: 100%;
}
.xlact-btn1 {
	position: absolute;
	top: 72.5%;
	left: 0;
	width: 100%;
	text-align: center;
}
.xlact-btn1 a {
	display: inline-block;
	min-width: 200px;
	height: 40px;
	background: #ffe401;
	box-shadow:  1px 1px 5px #eb0c5f;
	-webkit-box-shadow: 1px 1px 5px #eb0c5f;
	border-radius: 100px;
	line-height: 40px;
	color: #ed0b5d;
	font-family: "黑体";
	font-size: 16px;
}
.xlact-p1 {
	position: absolute;
	top: 45%;
	bottom: 44%;
	left: 21%;
	right: 33.75%;
	display: -webkit-flex;
	display: flex;
	-webkit-align-items: center;
	align-items: center;
	-webkit-justify-content: center;
	justify-content: center;
	font-size: 40px;
	color: #fff;
}
.xlact-p1 small {
	font-size: .6em;
}
.xlact-p2 {
	position: absolute;
	top: 45%;
	bottom: 44%;
	left: 67.5%;
	right: 18%;
	color: #eb0d62;
	display: -webkit-flex;
	display: flex;
	-webkit-align-items: center;
	align-items: center;
	-webkit-justify-content: center;
	justify-content: center;
	color: #eb0d62;
	font-size: 16px;
	font-weight: bold;
}
.xlact-p3 {
	position: absolute;
	top: 60%;
	left: 0;
	width: 100%;
	text-align: center;
	font-size: 16px;
	color: #fff;
	font-family: "黑体";
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">虚拟物品</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlact-box1">
		<img src="../../image/img/fiction_img001.jpg"/>
		<div id="pro_del">
			<div class="xlact-p1"><span><small>￥</small>00</span></div>
			<div class="xlact-p2">彩票</div>
			<div class="xlact-p3">还剩 00 张</div>
			<div class="xlact-btn1"><a>点击兑换</a></div>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	resetLStatu();//重置登录状态，如果是第三方进入此页面时
}
//dom事件绑定
function domEventFn(){
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//刷新数据请求函数
	var productId = globalData.pageParam.activeId;
	if(productId){
		getProductDetail(productId);
	}
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//重置登录状态
function resetLStatu(){
	if(globalData.pageParam.platform === 'android'){
		Common.domainUrl = location.protocol + '//' + location.host;
		Common.storageL(Common.userId, globalData.pageParam.userid);
		Common.storageL(Common.token, globalData.pageParam.token);
	}
}

//商品详情请求
function getProductDetail(productId){
	OrderData.getProductData(productId, function(itemData, status, data){
		if(status != 'success'){return false;};
		var checkedRule = itemData.checkedRule || {},
			intType = checkedRule.intType || [];
		if(intType.length !== 1 && intType[0] !== 999){
			Common.toast('只能有一种货币');
			return false;
		}
		getRealTimeInt(intType[0]);//获取用户拥有的商品所需积分总额，商品只能有一种积分
		globalData.itemData = itemData;
		globalData.nBalance = (checkedRule.ruleIntegral || checkedRule.pIntegral);
		globalData.ruleId = checkedRule.id;//商品的价格ID
		globalData.productId = productId;//商品ID
		globalData.productName = itemData.productName;//卡券名
		globalData.productDelivery = (data.detail.productDelivery ? (data.detail.productDelivery + '') : '');
		var a = itemData.productName.split('元'),//商品名称，解析
			b = parseInt(a[0]) || '00',//商品价格
			c = a[1] || '类型';//商品类型
		var str = 
			'<div class="xlact-p1"><span><small>￥</small>' + b + '</span></div>'+
			'<div class="xlact-p2">' + c + '</div>'+
			'<div class="xlact-p3">还剩 ' + itemData.stock + ' 张</div>'+
			'<div class="xlact-btn1"><a onclick="orderShopFn()">（' + itemData.checkedRule.payTypeText + '）点击兑换</a></div>';
		$('#pro_del').html(str);
	});
}

//获取实时积分
function getRealTimeInt(fundType){
	if(fundType === 1001){
		var _url = Common.domainUrl + '/ushop-api-merchant/api/user/account/point/listBy/' + Common.getUserId();
		Common.ajax(_url, 'get', {}, function(data){
			if(data.recordList){
				$.each(data.recordList, function(index, obj){
					if(obj.fundType === 1001){
						globalData.balance = obj.balance;
						return false;
					}
				});
			}
		});
	}else{
	    var _url = '/ushop-api-merchant/api/caipiao/user/profile/balance/get/' + fundType;
	    Common.ajax(_url, 'get', {}, function(data){
	        globalData.balance = data.balance;//用户拥有的商品所需积分总额
	    });
	}
}


//下单请求先
function orderShopFn(){
	globalData.isProgress = false;
	if(!(globalData.balance >= globalData.nBalance)){
		Common.confirm('提示', '您的相关金额不足！', null, '确定');
		return false;
	}
	Common.loadingShow();
	var _url = '/ushop-api-merchant/api/mall/cart/settlement/order/0',
		_param = [{
			buyPrice: globalData.ruleId,
			productId: globalData.productId,
			buyCount: 1
		}];
	Common.ajax(_url, 'post', JSON.stringify(_param), function(data) {
		if(data.payNo){
			globalData.orderNo = data.orderNo;//订单的订单号
			globalData.payNo = data.payNo;//订单的支付号
			orderYUEpayFn();
			return false;
		}
		Common.loadingHide();
    	Common.toast(data.error_description || '下单失败，未知错误');
	});
}


//余额支付
function orderYUEpayFn(){
	var _url = '/ushop-api-merchant/api/payment/balancepay/' + globalData.payNo;
	Common.ajax(_url, 'post', {}, function(data) {
		if(data.orderNo){
			globalData.payStatusNo = 0;
			paySuccessFn();
		}else{
			Common.loadingHide();
			Common.toast('支付失败！');
		}
	});
}

//用来判断是否支付成功
function paySuccessFn(){
	var orderNo = globalData.orderNo;
	globalData.payStatusNo = globalData.payStatusNo ? (globalData.payStatusNo + 1) : 1;
	if(orderNo && globalData.payStatusNo < 3){
		Common.loadingShow('支付状态查询中……');
		var _url = '/ushop-api-merchant/api/mall/cart/settlement/status/' + orderNo;
		Common.ajax(_url, 'get', {}, function(data){
			if(parseInt(data.status) === 100){
				Common.loadingHide();
				reloadDataFn();//刷新界面数据
				Common.confirm('提示', '恭喜您获得 <i style="color: #ff5534;">' + globalData.productName + '</i> 卡券', function(index){
					if(index === 1){
						if(globalData.pageParam.platform === 'android'){
							clb_android.toUseCard();
						}else{
							Common.openPage('../card_bag/card_list.html');
						}
					}
				}, ['关闭', '立即使用']);
			}else{
				setTimeout(function(){
					paySuccessFn(orderNo);
				}, 3000);
			}
		}, false);
	}else{
		Common.loadingHide();
		globalData.payStatusNo = 0;
		var str =   '<div>支付状态请求失败！</div>'+
					'<div>您可以选择：</div>';
		Common.confirm('提示', str, function(index){
			if(index == 1){
				Common.loadingShow();
				paySuccessFn();
			}
		}, ['取消', '继续刷新']);
	}
}

</script>
</body>
</html>
