<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>积分专场</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 3em;
	text-align: center;
	font-size: 1.2em;
	font-weight: 500;
	border-bottom: solid 1px #eee;
}
.xl-tab-title .xl-tab-hitem {
	float: left;
	width: 33.3333%;
	color: #333;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}


/*首页产品列表*/
.xl-product-list {
	list-style: none;
	margin: 0;
	padding: 0;
}
.xl-product-cell {
	position: relative;
	float: left;
	width: 50%;
	height: 170px;
	padding: 8px 8px 6px;
	border-top: solid 2px #eee;
	background: #fff;
}
.xl-product-cell:before {
	content: '';
	position: absolute;
	left: -1px;
	top: 0;
	width: 2px;
	height: 100%;
	background: #eee;
}
@media (min-width: 500px){
	.xl-product-cell {
		width: 33.33333%;
	}
	.xl-product-cell:nth-child(3n+1):before {
		width: 0;
	}
}
@media (max-width: 500px){
	.xl-product-cell:nth-child(2n+1):before {
		width: 0;
	}
}
.xl-product-pic img {
	display: block;
	width: 100%;
}
.xl-product-pic {
	position: relative;
	width: 86px;
	height: 86px;
	margin: 0 auto;
}
.xl-data-img {
	position: absolute;
	left: 0;
	top: 0;
}
.xl-product-purchase {
	color: #ff412d;
	padding: 15px 31px 0 0;
	font-weight: bold;
	font-size: 15px;
}
.xl-product-p1 {
	color: #4e4e4e;
	line-height: 1;
	height: 24px;
	margin: 8px 0 0;
	text-align: justify;
}
.xl-product-addbtn {
	position: absolute;
	bottom: 0;
	right: 0;
	width: 51px;
	height: 39px;
	padding: 6px 12px;
}
.xl-product-addbtn.disabled,
.xl-product-addbtn:disabled {
    -webkit-filter: grayscale(100%);
    filter: grayscale(100%);
	opacity: .2 !important;
}
.xl-product-addbtn img {
	width: 100%;
	height: 100%;
}


/*抬头*/
.fund-box {
    position: relative;
    padding: 15px 10px;
    font-size: 14px;
    font-weight: bold;
    padding-right: 6em;
}
.fund-box i {
	color: #fe2900;
}
.xlp-timeout {
	text-align: center;
	font-size: 15px;
	color: #888;
	padding: 5px 0;
	background: #eee;
}
.xl-countdown-box {
	display: inline-block;
}
.xl-countdown-box span {
	background: #fe2900;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">积分专场</h1>
	</div>
</div>
<div class="xlele-box xl-tab-fixed hide">
	<div class="xlele-content">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" sort="1" onclick="onTabTitleFn(this)">最新</a>
			<a class="xl-tab-hitem" datahref="#tabContent2" sort="1" onclick="onTabTitleFn(this)">价格</a>
			<a class="xl-tab-hitem" datahref="#tabContent3" sort="1" onclick="onTabTitleFn(this)">销量</a>
		</div>
	</div>
</div>
<div class="xlele-box">
	<div class="xlele-content">
		<div class="fund-box" id="user_integral">
			<div class="ellipsis">积分名称</div>
			<div class="ellipsis">积分额度：<i>00</i></div>
		</div>
	    <div class="xlp-timeout">
	        <div>距离专场结束还剩</div>
	        <div class="xl-countdown-box xlplCountdown clearfix" timenum="2017-09-22 14:30:50">
	            <span>00</span>
	            <span>00</span>
	            <span>00</span>
	        </div>
	    </div>
	</div>
</div>
<div style="height: 130px;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent11">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent12">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent21">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent22">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent31">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent32">
			<div class="tabBody"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script id="orderListTemplate"  type="text/template">
	<div class="clearfix">
	{{~ it:data}}
		<div class="xl-product-cell">
	        <div class="xl-product-body">
                <a class="xl-product-img" href="../indiana/product_details_ds.html?productId={{=data.id}}">
                	<div class="xl-product-pic">
	                	<img src="../../image/p200200.png">
	                	{{?data.headImage}}
	                	<img class="xl-data-img" src="{{=Common.getImageUrl(data.headImage)}}">
	                	{{?}}
                	</div>
                	<div class="xl-product-p1 ellipsis2">{{=data.productName}}</div>
                </a>
	            <div class="xl-product-purchase ellipsis">{{=data.checkedRule.payTypeText}}</div>
	        </div>
        </div>
	{{~}}
	</div>
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	globalData.showItem = globalData.pageParam.showItem;
	globalData.activeId = globalData.pageParam.activeId || '41';
	globalData.fundType = globalData.pageParam.fundType || '1007';
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var active = $('#tabTitleBox').find('.active'),
			datahref = active.attr('datahref') + (active.attr('sort') || '');
		getTabDataFn(datahref);
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getEndTimeFn();//获取专场其他数据，结束时间，货币名等
	
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent1';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	onTabTitleFn($('[datahref="' + datahref + '"]')[0]);
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me);
	if($me.hasClass('active')){//本就是选中状态，做一下操作
		if($me.attr('sort') === undefined){//如果未定义排序，则阻止点击事件
			return false;
		}
		//否则修改排序
		$me.attr('sort', ($me.attr('sort') === '1' ? '2' : '1'));
	}
	var datahref = $me.attr('datahref') + ($me.attr('sort') || ''),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	getTabDataFn(datahref);
}

//获取订单数据列表
function getTabDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('orderListTemplate'),
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来确定请求的地址
	var sort = $('#tabTitleBox').find('.active').attr('sort') || '';
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	switch(datahref){
		case ('#tabContent1' + sort)://待付款
		typenum = '1';
		break;
		case ('#tabContent2' + sort)://待发货
		typenum = '2';
		break;
		case ('#tabContent3' + sort)://待收货
		typenum = '3';
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url =  Common.domainUrl + '/ushop-api-merchant/api/mall/product/search/listByActivityId/'+
                typenum + '/' + sort + '/' + currentPage + '/' + globalData.activeId;
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var ruleObj;
			$.each(data.recordList, function(index, obj){
				ruleObj = OrderData.formatRule(obj.rule);
				obj.ruleArr = ruleObj.ruleArr;
				obj.checkedRule = ruleObj.checkedRule;
			});
			
			var dataListTemplate = doT.template(template.innerHTML);
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent[0].innerHTML = dataListTemplate(data.recordList);
			}else{
				listContent[0].innerHTML += dataListTemplate(data.recordList);
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	});
}


//获取专场其他数据，结束时间，货币名等
function getEndTimeFn(){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/product/activity/get/' + globalData.activeId;
	Common.ajax(_url, 'get', {}, function(data){
        if(data.id){
            var obj = data.object || {};
            globalData.specialIntObj = obj;
            document.querySelector('.xlplCountdown').setAttribute('timenum', data.endTime);
            countdownFn();
            getIntegralList(obj);
        }
	});
}


//获取积分列表
function getIntegralList(integralObj){
    var _url = Common.domainUrl + '/ushop-api-merchant/api/user/account/point/listBy/' + Common.getUserId();
    Common.ajax(_url, 'get', {}, function(data){
        if(data.recordList){
            var isTrue = true;
            Common.each(data.recordList, function(index, obj){
                if(obj.fundType == globalData.fundType){
                    isTrue = false;
                    globalData.specialIntObj = obj;
                    document.getElementById('user_integral').innerHTML =
						'<div class="ellipsis">' + obj.object.fundName + '</div>'+
						'<div class="ellipsis">积分额度：<i>' + parseInt(obj.balance) + '</i></div>';
                    return false;
                }
            });
            if(isTrue){
                globalData.specialIntObj = {balance: 0};
                document.getElementById('user_integral').innerHTML =
					'<div class="ellipsis">' + integralObj.fundName + '</div>'+
					'<div class="ellipsis">积分额度：<i>0</i></div>';
            }
        }
    });
}

//获取实时积分
function getRealTimeInt(platformId, fundType){
    var _url = '';
    if(platformId == 20){//即开积分查询
        _url = '/ushop-api-merchant/api/jikaipiao/user/profile/balance/get/' + fundType;
    }else if(platformId == 21){//彩票积分查询
        _url = '/ushop-api-merchant/api/caipiao/user/profile/balance/get/' + fundType;
    }
    if(_url){
        Common.ajax(_url, 'get', {}, function(data){
            if(data.fundType){
                globalData.specialIntObj = data;
                document.getElementById('user_integral').innerHTML =
					'<div class="ellipsis">' + (data.fundName || '　') + '</div>'+
					'<div class="ellipsis">积分额度：<i>' + (parseInt(data.balance) || 0) + '</i></div>';
                Common.toast('查询成功！');
            }else{
                Common.toast('抱歉，查询失败！');
            }
        });
    }else{
        Common.toast('抱歉，查询失败！');
    }
}


//倒计时函数
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 60000;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('span'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			if(timeEle.length != 3){
				return false;
			}
			interFn();
			timeInter[timeInter.length] = setInterval(interFn, interTime);
			function interFn(){
				if(timeDif > interTime){
				    var d = parseInt((timeDif%8553600000)/(86400000)),
	                    h = parseInt((timeDif%86400000)/(3600000)),
				    	i = parseInt((timeDif%3600000)/(60000)),
				    	s = parseInt((timeDif%60000)/1000),
				    	ms = parseInt((timeDif%1000)/100);
	                d = d < 10 ? ('0' + d) : d;
				    h = h < 10 ? ('0' + h) : h;
				    i = i < 10 ? ('0' + i) : i;
				    s = s < 10 ? ('0' + s) : s;
					timeEle[0].innerHTML = d;
					timeEle[1].innerHTML = h;
					timeEle[2].innerHTML = i;
					timeDif = timeDif - interTime;
				}else if(timeDif < -interTime){
					clearInterval(timeInter[index]);
					$me.parents('li').remove();
				}else if(timeDif <= interTime){
					timeEle[0].innerHTML = '00';
					timeEle[1].innerHTML = '00';
					timeEle[2].innerHTML = '00';
					timeDif = timeDif - interTime;
				}else{
					clearInterval(timeInter[index]);
				}
			}
		});
		globalData.interCountdown = timeInter;
	});
}

</script>
</body>
</html>
