<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>签到</title>
<link rel="stylesheet" type="text/css" href="../../css/animate.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>

.signin-box1 {
	position: relative;
	text-align: center;
	background: #fff url(../../image/icon/signin_007.jpg) no-repeat;
	background-size: 100%;
}
.signin-s1 {
	color: #d30126;
	font-size: 1.3em;
	font-weight: bold;
	padding: .5em 0 .2em;
}
.signin-s2 {
	position: relative;
	margin: 0 auto;
	width: 24%;
	background: url(../../image/icon/signin_005.png) no-repeat;
	background-size: 100%;
}
.signin-s2.disabled {
	background: url(../../image/icon/signin_006.png) no-repeat;
	background-size: 100%;
}
.signin-s2:active:before {
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	border-radius: 50%;
	background: rgba(0,0,0,.1);
}
.signin-s2 > img {
	width: 100%;
	visibility: hidden;
}
.signin-s2 i {
	position: absolute;
	top: 55%;
	left: 15%;
	right: 15%;
	bottom: 16%;
	font-size: 1.2em;
	color: #fff;
}
.signin-s2.disabled i {
	display: none;
}
.signin-s2 i small {
	font-size: .7em;
}
.signin-s3 {
	color: #d30126;
	font-size: 1.15em;
	font-weight: bold;
	padding: .2em 0;
}

.cignin-line-san {
	position: relative;
	border-top: solid 1px #dcdcdc;
}
.cignin-line-san span {
	position: absolute;
	top: 0;
	margin-left: -8px;
}
.cignin-line-san span:before,
.cignin-line-san span:after {
	content: '';
	position: absolute;
	left: 0;
	top: -1px;
	display: inline-block;
	width: 0;
	height: 0;
	border-top: 8px solid #dbdbdb;
	border-left: 8px solid transparent;
	border-right: 8px solid transparent;
}
.cignin-line-san span:after {
	top: -3px;
	border-top: 8px solid #fff;
	border-left: 8px solid transparent;
	border-right: 8px solid transparent;
}
.signin-line {
	padding: 1em 0 .5em;
}
.signin-line span {
	position: relative;
	float: left;
	width: 8%;
	border-radius: 50%;
	background: #dcdcdc;
	color: #fff;
	font-weight: bold;
	white-space: nowrap;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: .8em;
}
.signin-line span:before {
	content: '';
	position: absolute;
	right: 100%;
	top: 50%;
	height: 6%;
	width: 60%;
	transform: translateX(-9.28571%);
	-webkit-transform: translateX(-9.28571%);
	background: #dcdcdc;
	border-radius: 100px;
}
.signin-line span.active:after {
	content: '';
	position: absolute;
	right: 5%;
	top: 70%;
	width: .8em;
	height: .8em;
	background: url(../../image/icon/signin_008.png) no-repeat;
	background-size: 100% 100%;
	border-radius: 50%;
}
.signin-line span.active,
.signin-line span.active:before {
	background: #ff2358;
}
.signin-line span:first-child:before {
	width: 0;
}
.signin-line span i {
	font-size: .6em;
}
.signin-line-txt {
	display: flex;
	justify-content: space-between;
	padding-bottom: 1em;
}
.signin-line-txt span {
	color: #626262;
}
.signin-line-txt span:before {
	font-size: .8em;
}

.xl-li .xl-li-img {
	width: 2.4em;
	height: 2.4em;
	margin-top: -1.2em;
}
.xl-lii .xl-li-txt {
	line-height: 1.5em;
	padding-left: 3em;
}
.xl-lii .xl-li-txt .xlg-li-p1 {
	color: #888;
	font-size: .8em;
}
.xl-li-txt i {
	color: #f00;
	padding-left:8px;
	font-size: .8em;
}
.xl-lii .xldf-btn {
	position: absolute;
	right: 15px;
	top: 50%;
	padding: .5em;
	font-size: 14px;
	margin-top: -1em;
	border: 0;
	border-radius: .6em;
	color: #fff;
	line-height: 1;
	background: #ff8a09;
}
.xl-lii.disabled .xldf-btn,
.xl-lii .xldf-btn:disabled,
.xl-lii .xldf-btn:active {
	background: #959595;
}

/*恭喜弹窗，签到成功*/
.congratulate-toast .congratulate-txt {
	position: absolute;
	left: 0;
	top: 57%;
	bottom: 33%;
	width: 100%;
	color: #fff;
	display: flex;
	font-weight: bold;
	font-size: 24px;
	align-items: center;
	justify-content: center;
}
@media screen and (min-width: 350px) {
	.congratulate-toast .congratulate-txt {
		font-size: 30px;
	}
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">签到</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="signin-box1">
		<div class="signin-s1">我的彩豆：<span id="integralEle">00</span></div>
		<div class="signin-s2 disabled" id="sign_in_btn" onclick="signInFn(this)">
			<img src="../../image/p200200.png">
			<i id="signin_win_box"></i>
		</div>
		<div class="signin-s3" id="consecutively_num">已连续签到0天</div>
		<div style="height: 3em;"></div>
		<div id="signin_line_box"></div>
	</div>
	<div class="xlsi-box1">
		<ul class="xl-ul" id="data_list_box"></ul>
	</div>
</div>
<div class="congratulate-toast xlele-box" id="congratulate_toast" onclick="congratulateToastSH('hide')">
	<div class="congratulate-bg"></div>
	<div class="xlele-content">
		<div class="congratulate-con">
			<div class="congratulate-txt">+10</div>
			<img class="congratulate-img" src="../../image/icon/signin_009.png"/>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/countUp.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.taskConfig = [
	{id: '1001', textName: '中奖晒单', imgUrl: '../../image/icon/signin_001.png',
	fn: function(){
		Common.openPage('http://www.1leyou.cn/downloadclb/downloadclb.html');
	}},
	{id: '1002', textName: '拍彩票', imgUrl: '../../image/icon/signin_002.png',
	fn: function(){
		Common.openPage('../weixinmp/home.html?scanQRCode=yes');
	}},
	{id: '1003', textName: '购物消费', imgUrl: '../../image/icon/signin_003.png',
	fn: function(){
		Common.openPage('../weixinmp/shopping_ds.html');
	}},
	{id: '1004', textName: '邀请好友', imgUrl: '../../image/icon/signin_004.png',
	fn: function(){
		Common.openPage('../weixinmp/mine.html?goGeneral=yes');
	}}
]

$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getSignData();//获取签到数据
	getIntegralFn();//彩豆获取，显示
	getTaskListFn();//请求任务列表
}

//请求任务列表
function getTaskListFn(){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/sns/task/list/' + 2;
	var awardTypeArr = [
		{awardType: '1', awardTxt: '彩豆'}
	];
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList){
			if(data.recordList.length > 0){
				var nameArr, str = '', si = '', idarr = [];
				Common.each(data.recordList, function(index, obj){
					idarr[idarr.length] = obj.id;
					nameArr = obj.name.split('|');
					obj.name = nameArr[0];
					obj.taskid = nameArr[1] || '';
					Common.each(globalData.taskConfig, function(ti, to){
						if(to.id === nameArr[1]){
							obj.imgUrl = to.imgUrl;
							return false;
						}
					});
					obj.rewardArr = JSON.parse(obj.rewardValue);
					si = '';
					Common.each(obj.rewardArr, function(ri, ro){
						Common.each(awardTypeArr, function(ai, ao){
							if(ao.awardType == ro.awardType){
								ro.awardTxt = ao.awardTxt;
								return false;
							}
						});
						si += '<i>' + ro.awardValue + ro.awardTxt + '</i>'
					});
					str += 
						'<li class="xl-li xl-lii">'+
							'<a>'+
								'<img class="xl-li-img" src="' + obj.imgUrl + '">'+
								'<div class="xl-li-txt">'+
									'<div class="ellipsis">' + obj.name + si + '</div>'+
									'<div class="xlg-li-p1 ellipsis">' + obj.remark + '</div>'+
								'</div>'+
							'</a>'+
							'<button class="xldf-btn go_btn' + obj.id + '" onclick="taskClickFn(this, \'' + obj.taskid + '\')">去完成</button>'+
						'</li>';
				});
				document.getElementById('data_list_box').innerHTML = str;
				gettaskComp (idarr, function(){
					$.each(arguments, function(i, o){
						if(!(o.count > 0)){
							$('#data_list_box').find(('.go_btn' + o.id))[0].disabled = true;
						}
					});
				})
			}else{
				document.getElementById('data_list_box').innerHTML = '<li>没有数据！</li>';
			}
		}else if(data.error_description){
			Common.toast(data.error_description);
		}
	});
}

//获取任务是否完成
function gettaskComp (idarr, callback) {
	if(!(idarr.length > 0)) {
		return false;
	}
	callback = callback || function(){};
	var arr = [];
	$.each(idarr, function(i, v){
		arr[arr.length] = {
			url: ('/ushop-api-merchant/api/sns/task/done/get/' + v)
		}
	});
	Common.ajaxAll(arr, callback)
}

//任务点击事件
function taskClickFn(me, id){
	if(me.classList.contains('disabled')){return false;};
	if(!id){
		Common.toast('ID配置错误');
		return false;
	}
	var isTrue = true;
	Common.each(globalData.taskConfig, function(index, obj){
		if(obj.id === id){
			obj.fn();
			isTrue = false;
			return false;
		}
	});
	if(isTrue === true){
		Common.toast('ID配置错误');
	}
}


//彩豆获取，显示
function getIntegralFn(){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/user/account/point/listBy/' + Common.getUserId(),
		integral = 0;
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList){
			Common.each(data.recordList, function(index, obj){
				integral += parseInt(obj.balance);
			});
			var numAnim = new CountUp('integralEle', 0, integral, 0, 1);
			if (!numAnim.error) {
				globalData.intNumAni = numAnim;
			    numAnim.start();
			} else {
				$('#integralEle').text(integral);
			}
		}
	});
}

//获取签到数据
function getSignData(){
	var _url = '/ushop-api-merchant/api/task/sign/getSign';
	Common.ajax(_url, 'get', {}, function(data){
		if(data.rewards){
			Common.getServiceTT(function(curDate){
				var signInBtn = document.getElementById('sign_in_btn');
				var preDate = new Date(data.date),
					curDate = new Date(curDate);
				if((curDate.getTime() > preDate.getTime()) && ((curDate.getFullYear() > preDate.getFullYear()) || (curDate.getMonth() > preDate.getMonth()) || (curDate.getDate() > preDate.getDate()))){
					signInBtn.classList.remove('disabled');
				}else{
					signInBtn.classList.add('disabled');
				}
				data.rewardsArr = JSON.parse(data.rewards);
				var scoreData = [
					{id: '1', val: 0, txt: '第一天', cleft: ((5.5*1 + 8*.5) + '%'), sleft: (5.5*1) + '%'},
					{id: '2', val: 0, txt: '第二天', cleft: ((5.5*2 + 8*1.5) + '%'), sleft: (5.5*2) + '%'},
					{id: '3', val: 0, txt: '第三天', cleft: ((5.5*3 + 8*2.5) + '%'), sleft: (5.5*3) + '%'},
					{id: '4', val: 0, txt: '第四天', cleft: ((5.5*4 + 8*3.5) + '%'), sleft: (5.5*4) + '%'},
					{id: '5', val: 0, txt: '第五天', cleft: ((5.5*5 + 8*4.5) + '%'), sleft: (5.5*5) + '%'},
					{id: '6', val: 0, txt: '第六天', cleft: ((5.5*6 + 8*5.5) + '%'), sleft: (5.5*6) + '%'},
					{id: '7', val: 0, txt: '第七天', cleft: ((5.5*7 + 8*6.5) + '%'), sleft: (5.5*7) + '%'}
				];
				Common.each(scoreData, function(index, obj){
					obj.val = data.rewardsArr[index].awardValue;
				});
				signinLineFn(data.dayNumber, scoreData);
			});
		}
	});
}

//签到数据呈现
function signinLineFn(num, scoreData){
	var str1 = '', str2 = '', cleft = '';
	num = parseInt(num) || 0;
	scoreData = scoreData || globalData.scoreData;
	globalData.consecutivelyNum = num;//连续天数记在本地
	globalData.scoreData = scoreData;//签到数据记在本地
	document.getElementById('consecutively_num').innerHTML = '已连续签到' + num + '天';
	if(num > 5){
		document.getElementById('signin_win_box').innerHTML = '+' + scoreData[6].val + '<small>豆</small>';
	}else{
		document.getElementById('signin_win_box').innerHTML = '+' + scoreData[num].val + '<small>豆</small>';
	}
	cleft = scoreData[6].cleft
	if(num === 0){
		cleft = 0;
	}
	Common.each(scoreData, function(index, obj){
		if(index < num){
			if(index === (num - 1) && num < 7){
				cleft = obj.cleft;//箭头指向的位置
			}
			str1 += '<span class="active" style="left: ' + obj.sleft + '"><div>' + obj.val + '<i>分</i></div></span>';
		}else{
			str1 += '<span style="left: ' + obj.sleft + '"><div>' + obj.val + '<i>分</i></div></span>';
		}
		str2 += '<span>' + obj.txt + '</span>';
	});
	document.getElementById('signin_line_box').innerHTML =
		'<div class="cignin-line-san"><span style="left: ' + cleft + '"></span></div>'+
		'<div class="signin-line clearfix signin_line1">'+
			str1+
		'</div>'+
		'<div class="signin-line-txt signin_line2 clearfix">'+
			str2+
		'</div>';
	Common.each(document.getElementById('signin_line_box').querySelectorAll('.signin_line1 span'), function(){
		this.style.height = this.offsetWidth + 'px';
	});
	window.onresize = function(){
		Common.each(document.getElementById('signin_line_box').querySelectorAll('.signin_line1 span'), function(){
			this.style.height = this.offsetWidth + 'px';
		});
	}
}

//奖励弹窗提示
function congratulateToastSH(type, num){
	var $box = $('#congratulate_toast'),
		$p = $box.find('.congratulate-txt');
	if(type === 'show'){
		$p.text(('+' + num)).data('num', num);
		$box.addClass('active').find('.xlele-content')
		.removeClass('bounceIn animated')
	    .addClass('bounceIn animated').one('webkitAnimationEnd animationend', function(){
	    	$(this).removeClass('bounceIn animated');
	    });
	}else if(type === 'hide'){
		$box.find('.xlele-content').removeClass('bounceOut animated')
	    .addClass('bounceOut animated').one('webkitAnimationEnd animationend', function(){
	    	$(this).removeClass('bounceOut animated');
	    	$box.removeClass('active');
	    	if(globalData.intNumAni){
	    		globalData.intNumAni.update((globalData.intNumAni.endVal + $p.data('num')));
	    	}else{
		    	var $n = $('#integralEle'),
		    		n = parseInt($n.text().replace(/\D/g, ''));
		    	$n.text(n + $p.data('num'));
	    	}
	    });
	}
}
//签到按键点击执行函数
function signInFn(me){
	if(me.classList.contains('disabled')){
		Common.toast('一天只能签到一次！');
		return false;
	}
	var signInBtn = document.getElementById('sign_in_btn');
	signInBtn.classList.add('disabled');
	var _url = '/ushop-api-merchant/api/task/sign/submit';
	Common.ajax(_url, 'get', {}, function(data){
		if(data.succeed == 1){
			var reward = data.reward || 1,
				rval = parseInt(reward);
			try{
				reward = JSON.parse(reward);
				rval = parseInt(reward.awardValue);
			}catch(err){}
			congratulateToastSH('show', rval);//奖励提醒
			signInBtn.classList.add('disabled');
			signinLineFn(globalData.consecutivelyNum + 1);
		}else{
			signInBtn.classList.remove('disabled');
			Common.toast('签到失败！');
		}
	});
}

</script>
</body>
</html>
