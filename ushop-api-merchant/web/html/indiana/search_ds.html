<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>搜索</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*首页产品列表*/
.xl-product-list {
	list-style: none;
	margin: 0;
	padding: 0;
	font-size: .8em;
}
.xl-product-list .xl-product-cell {
	float: left;
	width: 33.33333%;
	padding: 10px 5px;
	border: solid 1px #f6f6f6;
	background: #fff;
	margin: -1px 0 0 0;
	border-left: 0;
}
@media (max-width: 500px){
	.xl-product-list .xl-product-cell {
		width: 50%;
	}
}
.xl-product-list .xl-product-pic img {
	display: block;
	width: 100%;
}
.xl-product-list .xl-product-pic {
	position: relative;
	width: 50%;
	margin: 0 auto;
}
.xl-product-list .xl-data-img {
	position: absolute;
	left: 0;
	top: 0;
}
.xl-product-purchase {
	position: relative;
	padding: 0 5px;
	color: #ff5534;
	font-size: 1.4em;
}
.xl-product-list .xl-product-p1 {
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	color: #333;
	line-height: 1.4;
	padding: 8px 5px;
}


/*界面问题*/
.pageItem {
	display: none;
}
.pageItem.active {
	display: block;
}
.xl-search-box {
	top: 0;
	padding: 10px;
	height: 50px;
	border-bottom: solid 1px #f6f6f6;
}
.xlsearch-form {
	position: relative;
	height: 100%;
}
.xlsearch-form input {
	width: 100%;
	height: 100%;
	border: 0;
	background: #eee;
	padding: 5px;
	text-align: center;
	box-sizing: border-box;
}
.xlsearch-form button {
	position: absolute;
	right: 0;
	top: 0;
	width: 4em;
	height: 100%;
	border: 0;
	background: #ff5534;
	color: #fff;
}

/*分类列表*/
.xlc-title {
	font-size: 1.6em;
	text-align: center;
	line-height: 2.6em;
}
.xl-li {
	float: left;
	width: 50%;
	font-size: 1.2em;
	padding-left: 5%;
}
.xl-li > a {
	position: relative;
	background: none;
	color: #666;
}

/*热门搜索样式*/
.xlr-title {
	padding: 0 .8em;
	padding-top: .5em;
	line-height: 2em;
	font-size: 1.2em;
	border-bottom: solid 1px #f7bb58;
}
.xlr-content {
	padding: .5em .8em;
}
.xlr-content span {
	float: left;
	margin-right: 5px;
	margin-bottom: 8px;
	padding: .4em .6em;
	border: solid 1px #f7bb58;
	border-radius: 3px;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">搜索</h1>
	</div>
</div>
<div class="xlele-box">
	<div class="xlele-content xl-search-box">
		<form id="searchForm" class="xlsearch-form" action="yyy.html">
			<input id="searchIpt" type="search">
			<button>搜索</button>
		</form>
	</div>
</div>
<div style="height: 50px;"></div>
<div class="xlbody-box">
	<div id="classPage" class="pageItem active">
		<div class="xlc-title">热门分类</div>
		<ul class="xl-ul"></ul>
	</div>
	<div id="recordPage" class="pageItem">
		<div class="xlr-title">热门搜索</div>
		<div id="hotSearchBox" class="xlr-content searchBox clearfix">
		</div>
		<div class="xlr-title">搜索记录</div>
		<div id="searchRecordBox" class="xlr-content searchBox clearfix">
		</div>
	</div>
	<div id="listContentPage" class="pageItem">
	    <ul class="clearfix xl-product-list"></ul>
	    <div class="xl-refresh-prompt refreshPrompt"></div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
globalData.hotSearchArr = ['iPhone', '手机', '充值卡', 'apple']
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
//	pageShowFn();//显示界面
	var searchRecord = Common.storageL('ls_partly_iisd_search_record') || [],
		str = '';
	$.each(searchRecord, function(index, val) {
		str += '<span onclick="requestInit(\'' + val + '\', null)">' + val + '</span>';
		$('#searchRecordBox').html(str);
	});
	str = '';
	$.each(globalData.hotSearchArr, function(index, val) {
		str += '<span onclick="requestInit(\'' + val + '\', null)">' + val + '</span>';
		$('#hotSearchBox').html(str);
	});
}
//dom事件绑定
function domEventFn(){
	$('#searchIpt').on('focus', function(){
		pageShowFn('#recordPage');
	});
	$('#searchForm').on('submit', function(event){
		event.preventDefault();
		var val = $('#searchIpt').val();
		if(val){
			$('#searchIpt').blur();
			requestInit(val, null);
		}else {
			Common.toast('请输入搜索内容');
		}
	});
	//到底部加载
	Common.scrollBottom(function(){
		onSearchFn();
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getClassDataFn();//分类数据请求
}
//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}
//写入搜索记录
function writeRecordFn(keyword){
	if(keyword){
		var searchRecord = Common.storageL('ls_partly_iisd_search_record') || [],
			isTrue = true;
		$.each(searchRecord, function(index, val) {
			if(val == keyword){
				searchRecord.splice(index, 1);
				searchRecord.splice(0, 0, keyword);
				isTrue = false;
				return false;
			}
		});
		if(isTrue === true){
			searchRecord.splice(0, 0, keyword);
		};
		Common.storageL('ls_partly_iisd_search_record', searchRecord);
		var str = '';
		$.each(searchRecord, function(index, val) {
			str += '<span onclick="requestInit(\'' + val + '\', null)">' + val + '</span>';
			$('#searchRecordBox').html(str);
		});
	}
}

//页面显示
function pageShowFn(hash){
	var pageItems = $('.pageItem'),
		hash = hash || location.hash || '#classPage';
	pageItems.removeClass('active');
	$(hash).addClass('active');
//	location.hash = hash;
}
//分类数据请求
function getClassDataFn(){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/product/listProductType';
	Common.ajax(_url, 'get', {}, function(data){
		if(data.productType && data.productType.length > 0){
			var str = '', imgSrc;
			$.each(data.productType, function(index, obj){
				imgSrc = obj.pictureAddress ? Common.getImageUrl(obj.pictureAddress) : '../../image/mine/mine001.png';
				str +=  '<li class="xl-li xl-lii" onclick="requestInit(null, \'' + obj.id + '\')">'+
							'<a>'+
								'<img class="xl-li-img" src="' + imgSrc + '">'+
								'<div class="xl-li-txt">' + obj.typeName + '</div>'+
							'</a>'+
						'</li>';
			});
			$('#classPage').find('ul').html(str);
		}
	});
}

//请求数据初始化
function requestInit(keyword, classId){
	globalData.currentPage = 0;
	globalData.pagePage = 1;
	
	pageShowFn('#listContentPage');
	globalData.keyword = keyword;
	globalData.classId = classId;
	onSearchFn(keyword, classId);
}

//执行搜索函数
function onSearchFn(keyword, classId){
	keyword = keyword || globalData.keyword;
	classId = classId || globalData.classId;
	var currentPage = globalData.currentPage,
		pagePage = globalData.pagePage,
		listItem = $('#listContentPage'),//列表项目
		listContent = listItem.find('ul'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt');
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){
		return false;
	}
	if(keyword){
		var _url = Common.domainUrl + '/ushop-api-merchant/api/mall/product/search/listLikeName',
		type = 'post',
		data = JSON.stringify({
			name: keyword,
			page: currentPage
		});
		writeRecordFn(keyword);
	}else if(classId){
		var _url =  Common.domainUrl + '/ushop-api-merchant/api/mall/product/search/listByType/'+
					classId + '/' + currentPage,
		type = 'get',
		data = '';
	}
	refreshPrompt.html(Common.listLoadingHTML());
	Common.ajax(_url, type, data, function(data){
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage'] = currentPage;
			globalData['pagePage'] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var str = '', rate, headImage = '', ruleObj;
			$.each(data.recordList, function(index, obj){
				ruleObj = OrderData.formatRule(obj.rule);
				obj.ruleArr = ruleObj.ruleArr;
				obj.checkedRule = ruleObj.checkedRule;
				
				rate = parseInt(100*obj.spellbuyCount/obj.spellbuyPrice);
				headImage = obj.headImage ? '<img class="xl-data-img" src="' + Common.getImageUrl(obj.headImage) + '">' : '';
				
				str +=
					'<li class="xl-product-cell">'+
				        '<div class="xl-product-body">'+
			                '<a class="xl-product-img" href="../indiana/product_details_ds.html?productId=' + obj.id + '">'+
			                	'<div class="xl-product-pic">'+
				                	'<img src="../../image/p200200.png">'+
				                	headImage+
			                	'</div>'+
			                	'<div class="xl-product-p1">' + obj.productName + '</div>'+
			                '</a>'+
				            '<div class="xl-product-purchase">'+
				            obj.checkedRule.payTypeText+
				            '</div>'+
				        '</div>'+
			        '</li>';
			});
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
		}else{
			refreshPrompt.html('请求失败！');
		}
	});
}

</script>
</body>
</html>
