<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>退货</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*弹出窗选择原因*/
.xl-li.icon-radio:before {
    font-family: 'iconfont';
    position: absolute;
    right: 15px;
    top: 50%;
    color: #999;
    line-height: 1;
    margin-top: -0.5em;
    z-index: 2;
    font-size: 1.6em;
}
.xl-li.active.icon-radio:before {
    color: #ff5534;
}

/*底部按键*/
.xlpd-fotter {
	bottom: 0;
}
.xlpd-fotter .xl-btn {
	border-radius: 5px 5px 0 0;
}

/*此页面中对列表样式的修改*/
.xlo-li {
	background: none;
	padding-left: 40px;
}
.xlo-li > img {
	left: 40px;
}
.xlo-li:before {
	background: #f6f6f6;
}
.xlo-checked {
	position: absolute;
	left: 15px;
	top: 50%;
	margin-top: -12px;
}
.xlo-checked:before {
	font-size: 24px;
	content: "\e664";
	line-height: 1;
}
.xlo-li.active .xlo-checked:before {
	content: "\e609";
	color: #ff9f18;
}

.xlap-od-item:first-child {
	margin-top: 0;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">全部订单</h1>
	</div>
</div>
<div class="xlbody-box">
	<div id="returnProBox"></div>
</div>
<div style="height: 3.12em;"></div>
<div class="xlele-box xlpd-fotter footBtnEle">
	<div class="xlele-content">
		<div class="xl-btn xl-btn-block" onclick="onSubmitFn()">确定退货</div>
	</div>
</div>
<script id="orderListTemplate"  type="text/template">
	{{~ it:data}}
		<div class="xlap-od-item" order-no="{{=data.orderNo}}">
			{{~ data.merchantArr:mitem}}
			<div class="xlap-od-p1">
				<div class="xlo-p1">
					<span class="xlo-s1"></span>
					<span class="xlo-s2">
						<a>{{=mitem.merchantName}}</a>发货
					</span>
				</div>
			</div>
			<ul class="xlo-ul">
				{{~mitem.proArr:item}}
				<li class="xlo-li itempro" item='{{=encodeURIComponent(JSON.stringify(item))}}' onclick="onSelectProFn(this)">
					{{?item.headImage}}
					<img src="{{= Common.getImageUrl(item.headImage)}}">
					{{??}}
					<img src="../../../image/p200200.png">
					{{?}}
					<div class="xlo-body">
						<div class="xlo-p1">
							<span class="xlo-s1">{{=item.productName}}</span>
							<span class="xlo-s2">{{=item.checkedRule.payTypeText}}</span>
						</div>
						<div class="xlo-p1">
							<span class="xlo-s1 xlo-c969696">来自{{=mitem.merchantName}}</span>
							<span class="xlo-s2">x{{=item.buyCount}}</span>
						</div>
					</div>
					<div class="xlo-checked icon"></div>
				</li>
				{{~}}
			</ul>
			{{~}}
		</div>
	{{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	var orderObj = JSON.parse(globalData.pageParam.orderObj || '{}');
	globalData.orderNo = orderObj.orderNo;
	var dataListTemplate = doT.template($('#orderListTemplate').html());
	$('#returnProBox').html(dataListTemplate([orderObj]));
}
//dom事件绑定
function domEventFn(){
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//退货原因
globalData.refundReason = [
	{id: '1', str: '商品与卖家描述不符'},
	{id: '2', str: '认为是假货'},
	{id: '3', str: '商品破损问题'},
	{id: '4', str: '发货问题'},
	{id: '5', str: '卖家承诺条款没有兑现'},
	{id: '6', str: '不喜欢，不想要了'},
	{id: '7', str: '认为是三无产品'},
	{id: '8', str: '其他'}
];
function onSubmitFn(){
	var lis = $('.itempro.active')
	if(lis.length == 0){
		Common.toast('请选择商品！');
		return false;
	}
	var str = '';
	$.each(globalData.refundReason, function(index, obj){
		str +=
			'<li class="xl-li icon-radio" onclick="selectCauseFn(this)" datastr="' + obj.str + '">'+
				'<a>'+
					'<div class="xl-li-txt">' + obj.str + '</div>'+
				'</a>'+
			'</li>';
	});
	str =
			'<ul class="xl-ul" id="alertSelectBox">'+
			str+
			'</ul>';
	Common.confirm('请选择退货原因', str, function(index){
		if(index == 1){
			var pstr = $('#alertSelectBox').find('li.active').attr('datastr');
			if(!pstr){
				Common.toast('请选择退货原因！');
				return false;
			}
			var items = [], obj;
			$.each(lis, function(){
				obj = JSON.parse(decodeURIComponent(this.getAttribute('item')));
				items[items.length] = {
					productId: obj.productId,
					count: obj.buyCount,
					index: obj.index,
					comment: pstr
				}
			});
			submitSalesFn(items);
		}
	});
}
//选择原因
function selectCauseFn(me){
	var $me = $(me);
	if(!$me.hasClass('active')){
		$('#alertSelectBox').find('.xl-li').removeClass('active');
		$me.addClass('active');
	}
}

//选择退货商品
function onSelectProFn(me){
	var $me = $(me);
	if($me.hasClass('active')){
		$me.removeClass('active');
	}else{
		$me.addClass('active');
	}
}

//提交退货
function submitSalesFn(items){
	var _url = '/ushop-api-merchant/api/mall/person/order/postBack/' + globalData.orderNo;
	Common.ajax(_url, 'post', JSON.stringify(items), function(data) {
		if(data.data == 'SUCCESS'){
			Common.openPage('../order/user_order_ds.html?showItem=tabContent3');
			Common.toast('申请成功');
		}else{
			Common.toast('申请失败');
		}
	});
}

</script>
</body>
</html>
