<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>正在开奖</title>
<link rel="stylesheet" type="text/css" href="../../css/animate.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlbody-box {
    position: relative;
    padding: 0 !important;
}
.xllt-title {
    position: absolute;
    left: 20%;
    right: 20%;
    top: 6%;
    bottom: 89.3%;
    font-size: 1.2em;
    color: #fff;
}
.xl-table {
    display: table;
    width: 100%;
    height: 100%;
    text-align: center;
}
.xl-table .xl-table-cell {
    display: table-cell;
    vertical-align: middle;
}
.xllt-timeout {
    position: absolute;
    left: 20%;
    right: 20%;
    top: 19.469%;
    bottom: 73.894%;
}
.xllt-box1 {
    position: absolute;
    left: 6.8%;
    right: 9%;
    top: 46.9%;
    bottom: 27%;
    overflow-x: hidden;
    overflow-y: auto;
}
.xllt-box2 {
    position: absolute;
    top: 78.23%;
    left: 6.25%;
    right: 6%;
    bottom: 3.27%;
    padding: .5em;
}



.xl-countdown-box {
    height: 100%;
    text-align: center;
}
.xl-countdown-box .xlcb-time {
    position: relative;
    height: 100%;
    display: inline-block;
    background: #ff8500;
    border-radius: .3em;
    width: 13%;
    vertical-align: top;
    float: none;
    margin-left: 0;
}
.xl-countdown-box span:first-child:before {
	content: '';
}

.xl-countdown-box .xlcb-time:before,
.xl-countdown-box .xlcb-time:after {
    content: '';
    position: absolute;
    width: .3em;
    height: .3em;
    background: #9c00a9;
    top: 50%;
    left: 0;
    margin-top: -.15em;
}
.xl-countdown-box .xlcb-time:after {
    left: auto;
    right: 0;
}
.xl-countdown-box .xlcb-time i {
    height: 100%;
    width: 100%;
    color: #fff;
    font-size: 2.4em;
    display: flex;
    align-items: center;
    justify-content: center;
}
.xl-countdown-box .xlcb-divide {
    position: relative;
    display: inline-block;
    width: 4%;
    height: 100%;
    vertical-align: top;
    margin-left: 0;
    float: none;
	background: none;
}
.xl-countdown-box .xlcb-divide:before,
.xl-countdown-box .xlcb-divide:after {
    content: '';
    position: absolute;
    left: 50%;
    top: 20%;
    margin-left: -.15em;
    width: .3em;
    height: .3em;
    background: #ff8500;
}
.xl-countdown-box .xlcb-divide:after {
    top: auto;
    bottom: 20%;
}
.xl-countdown-box .xlcb-time6-null {
    font-size: 1.8em;
    color: #fff;
    width: 100%;
    height: 100%;
    display: table;
    text-align: center;
}
.xl-countdown-box .xlcb-time6-null i {
    display: table-cell;
    vertical-align: middle;
}



.xl-ul {
    position: absolute;
    left: 0;
    width: 100%;
}
.xl-li .xl-li-img {
	width: 36px;
	height: 36px;
	left: 5px;
	margin-top: -18px;
}
.xl-lii .xl-li-txt {
	padding-left: 45px;
}
.xl-ul li:nth-child(2n+1){
    background: -webkit-linear-gradient(left, rgba(255, 239, 154, 1) , rgba(255, 239, 154, 0));
    background: linear-gradient(to right, rgba(255, 239, 154, 1) , rgba(255, 239, 154, 0));
}
.xl-li:active {
    background: -webkit-linear-gradient(left, rgba(255, 239, 154, 1) , rgba(255, 239, 154, 0));
    background: linear-gradient(to right, rgba(255, 239, 154, 1) , rgba(255, 239, 154, 0));
}


.xllt-img1 {
    display: inline-block;
    width: 40%;
    height: 100%;
    padding-top: 5%;
    text-align: center;
    background: url(../../image/img/lucky_icon1.png) no-repeat;
    background-size: 100% 100%;
    vertical-align: top;
}
.xllt-img1 img {
    height: 80%;
}
.xllt-text1 {
    position: absolute;
    width: 58%;
    left: 40%;
    top: 50%;
    padding-left: .6em;
    -webkit-transform: translateY(-50%);
    transform: translateY(-50%);
}
.xllt-text1 h5 {
    font-size: 1.4em;
    color: #ff2021;
    line-height: 1;
    padding-bottom: .25em;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">正在开奖</h1>
	</div>
</div>
<div class="xlbody-box">
    <img src="../../image/img/lucky_bg3.png" width="100%">
    <div class="xllt-title"><div class="xl-table"><div class="xl-table-cell" id="game_name_ele">这里是开奖时间</div></div></div>
    <div class="xllt-timeout">
        <div class="xl-countdown-box xlplCountdown" timeNum="2017-08-05 14:30:50">
            <span class="xlcb-time1 xlcb-time timeEle"><i>0</i></span>
            <span class="xlcb-time2 xlcb-time timeEle"><i>0</i></span>
            <span class="xlcb-divide"></span>
            <span class="xlcb-time3 xlcb-time timeEle"><i>0</i></span>
            <span class="xlcb-time4 xlcb-time timeEle"><i>0</i></span>
            <span class="xlcb-divide"></span>
            <span class="xlcb-time5 xlcb-time timeEle"><i>0</i></span>
            <span class="xlcb-time6 xlcb-time timeEle"><i>0</i></span>
        </div>
    </div>
    <div class="xllt-box1">
        <ul class="xl-ul" id="winprize_box"></ul>
    </div>
    <div class="xllt-box2" id="winprize_data"></div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script type="text/javascript">
"use strict";
globalData.setInterBox = {};//记录倒计时的计时器，以便于关闭
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	globalData.gameId = globalData.pageParam.gameId;
	getGameDataFn(globalData.gameId);//请求游戏数据
	getIssueListFn(globalData.gameId);//请求期次数据
}
//刷新之后执行函数
function refreshAfterFn(){
	//说明页面所有请求都已经完成
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数，记录归零
		globalData.requestNum = 0;//用来记录有多少次用户请求，记录归零
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//获取游戏数据，奖等数据包括在内
function getGameDataFn(gameId){
    if(!gameId){
        Common.toast('没有ID');
        return false;
    }
    var _url = Common.domainUrl + '/ushop-api-merchant/api/lotto/game/get/' + gameId;
    Common.ajax(_url, 'get', {}, function(data){
        if(data.prizes){
            data.prizesArr = JSON.parse(data.prizes + '');
            if(data.prizesArr.length > 0){
                globalData.gameData = data;
                if(globalData.issueArr){
                    gameDatafinish(globalData.gameData, globalData.issueArr);
                }
            }
        }
    });
}

//期数列表请求
function getIssueListFn(gameId){
    if(!gameId){
        Common.toast('没有ID');
        return false;
    }
    var _url = Common.domainUrl + '/ushop-api-merchant/api/lotto/issue/visible/listBy/1/' + gameId;
    Common.ajax(_url, 'get', {}, function(data){
        if(data.recordList && data.recordList.length > 0){
            globalData.issueArr = data.recordList;
            if(globalData.gameData){
                gameDatafinish(globalData.gameData, globalData.issueArr);
            }
        }
    });
}

//游戏数据请求完成后执行
function gameDatafinish(gameData, issueArr){
    Common.each(issueArr, function(ii, io){
        Common.each(gameData.prizesArr, function(pi, po){
            if(po.index == io.prizeId){
                if(po.issueArr){
                    po.issueArr.push(io);
                }else{
                    po.issueArr = [io];
                }
                return false;
            }
        });
    });
    globalData.gameData = gameData;
    var levelIndex = globalData.pageParam.levelIndex,
        issueId = globalData.pageParam.issueId,
        issueObj, levelObj;
    globalData.issueId = issueId;
    Common.each(issueArr, function(index, obj){
        if(obj.id == issueId){
            issueObj = obj;
            return false;
        }
    });
    Common.each(gameData.prizesArr, function(index, obj){
        if(obj.index == levelIndex){
            levelObj = obj;
        }
    });
    if(!issueObj || !levelObj){
        Common.toast('数据错误！');
        return false;
    }
    document.getElementById('game_name_ele').innerHTML = gameData.name + ' 开奖时间';
    Common.getServiceTT(function(timestamp){
	    if(Common.msToTime(timeFormtFn(issueObj.drawTime)).ms < timestamp){
    		Common.toast('已过期！');
    		return false;
    	}
	    document.querySelector('.xlplCountdown').setAttribute('timeNum', timeFormtFn(issueObj.drawTime));
	    countdownFn();
    });
    document.getElementById('winprize_data').innerHTML =
        '<div class="xllt-img1">'+
            '<img src="' + Common.getImageUrl(levelObj.url) + '">'+
        '</div>'+
        '<div class="xllt-text1">'+
            '<h5 class="text-ellipsis">正在开奖</h5>'+
            '<div class="text-ellipsis">奖　　品：' + levelObj.name + '</div>'+
            '<div class="text-ellipsis">奖品个数：' + levelObj.prizeCount + '个</div>'+
            '<div class="text-ellipsis">参与票数：' + issueObj.totalSaleTick + '张</div>'+
        '</div>';
}


//倒计时完成后请求开奖数据
function winprizeAfter(){
	globalData.isProgress = false;
    Common.loadingShow('正在计算开奖……');
    var _url = Common.domainUrl + '/ushop-api-merchant/api/lotto/issue/get/' + globalData.issueId;
    Common.ajax(_url, 'get', {}, function(data){
        if((data.status == 4) || (data.status == 5)){
            getWinprizeFn(globalData.gameId, globalData.issueId);
        }else if(data.id){
            setTimeout(function(){
                winprizeAfter();
            }, 3000);
        }else{
            Common.toast(data.error_description || '未知错误');
            Common.loadingHide();
        }
    });
};

//获取用户票，中奖的，即中奖数据
function getWinprizeFn(gameId, issueId){
    var _url =  Common.domainUrl + '/ushop-api-merchant/api/lotto/ticket/topn/listBy/'+
                '1/' + gameId + '/' + issueId + '/1';
    Common.ajax(_url, 'get', {}, function(data){
        Common.loadingHide();
        if(data.recordList){
        	if(data.recordList.length === 0){
        		Common.toast('无人中奖');
        		return false;
        	}
            $('#winprize_box').html('');
            if(!(data.recordList.length > 0)){return false;};
			var dataList = getListStrFn(data.recordList),
                i = 0;
            showAmimateFn('bounceIn', '');
            //动画函数
            function showAmimateFn(x, y) {
                var ele = dataList[i++];
                if(ele){
                    ele = $(ele);
                }else{
                    applayNoticeList();
                    return false;
                }
            	ele.prependTo('#winprize_box')
            		.removeClass()
            		.addClass(x + ' animated')
            		.one('webkitAnimationEnd animationend', function() {
                        ele.removeClass();
                        showAmimateFn('bounceIn', '');
            		});
            };
        }
    });
}

//生成元素数据字符串数组
function getListStrFn(dataList){
    if(!(dataList.length > 0)){return false;};
    var arr = [], a, i = 0;
    while(a = dataList[i++]){
        arr[arr.length] =
        '<li>'+
            '<div class="xl-li xl-lii">'+
                '<img class="xl-li-img" src="' + (a.userImage ? Common.getImageUrl(a.userImage) : '../../image/icon/minePortrait.png') + '">'+
                '<div class="xl-li-txt">'+
                    '<div class="ellipsis">用户名：' + a.userName + '</div>'+
                    '<div class="ellipsis">奖券码：' + a.featureCode + '</div>'+
                '</div>'+
            '</div>'+
        '</li>';
    }
    return arr;
}



//倒计时函数
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 1000;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('.timeEle'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			if(timeEle.length != 6){
				return false;
			}
			interFn();
			timeInter[timeInter.length] = setInterval(interFn, interTime);
			function interFn(){
				if(timeDif > interTime){
				    var d = parseInt((timeDif%8553600000)/(86400000)),
	                    h = parseInt((timeDif%86400000)/(3600000)),
				    	i = parseInt((timeDif%3600000)/(60000)),
				    	s = parseInt((timeDif%60000)/1000),
				    	ms = parseInt((timeDif%1000)/100);
	                d = d < 10 ? ('0' + d) : (d + '');
				    h = h < 10 ? ('0' + h) : (h + '');
				    i = i < 10 ? ('0' + i) : (i + '');
				    s = s < 10 ? ('0' + s) : (s + '');
					timeEle[0].innerHTML = '<i>' + h[0] + '</i>';
					timeEle[1].innerHTML = '<i>' + h[1] + '</i>';
					timeEle[2].innerHTML = '<i>' + i[0] + '</i>';
					timeEle[3].innerHTML = '<i>' + i[1] + '</i>';
					timeEle[4].innerHTML = '<i>' + s[0] + '</i>';
					timeEle[5].innerHTML = '<i>' + s[1] + '</i>';
					timeDif = timeDif - interTime;
				}else if(timeDif < -interTime){
					clearInterval(timeInter[index]);
					winprizeAfter();
				}else if(timeDif <= interTime){
					timeEle[0].innerHTML = '<i>0</i>';
					timeEle[1].innerHTML = '<i>0</i>';
					timeEle[2].innerHTML = '<i>0</i>';
					timeEle[3].innerHTML = '<i>0</i>';
					timeEle[4].innerHTML = '<i>0</i>';
					timeEle[5].innerHTML = '<i>0</i>';
					timeDif = timeDif - interTime;
				}else{
					clearInterval(timeInter[index]);
				}
			}
		});
		globalData.interCountdown = timeInter;
	});
}


//时间格式化，20170506101010
//这种时间的格式化为 2017-05-06 10:10:10
function timeFormtFn(a){
	if(!a){return ''};
	var y = a.substr(0, 4),
		m = a.substr(4, 2),
		d = a.substr(6, 2),
		h = a.substr(8, 2),
		i = a.substr(10, 2),
		s = a.substr(12, 2);
	return y + '-' + m + '-' + d + ' ' + h + ':' + i + ':' + s;
}

//轮播，上下
//这里用jQuery
function applayNoticeList() {
	var ul = $('#winprize_box');
	var li = ul.find('li');
	var lih = li.eq(0).height();
	var lgn = li.length;
	if(lgn > 3){
		clearInterval(globalData.setinter);
		globalData.setinter = setInterval(function() {
			ul.animate({top: ('-' + lih + 'px')}, 500, 'linear', function(){
				ul.find('li').eq(0).appendTo(ul);
				ul.animate({top: 0}, 0, 'linear');
			});
		}, 4000);
	}
}
</script>
</body>
</html>