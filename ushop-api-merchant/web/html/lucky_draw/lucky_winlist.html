<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>中奖榜</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xllu-box1 {
    background: #fe9601 url(../../image/img/lucky_bg22.jpg) no-repeat;
    background-size: 100%;
}

.em05 {
    width: 0.5em;
    height: 1px;
    display: inline-block;
}


.xl-li .xl-li-img {
	width: 36px;
	height: 36px;
	margin-top: -18px;
}
.xl-lii .xl-li-txt {
	padding-left: 45px;
}
.xl-li > a {
	background: none;
}


.xllu-title {
    position: relative;
    background: url(../../image/img/lucky_icon2.png) no-repeat;
    background-size: 100% 100%;
    margin: 0 15px;
    color: #fff;
    padding: 5px 0 5px 5px;
    font-size: .8em;
}
.xllu-title h5 {
    font-size: 1.2em;
    font-weight: normal;
}
.xllu-title-img {
    position: absolute;
    right: 0;
    top: 1px;
    width: 9em;
    height: 6em;
    text-align: center;
    background: url(../../image/img/lucky_icon1.png) no-repeat;
    background-size: 100% 100%;
}
.xllu-title-img img {
    height: 80%;
    margin-top: 5%;
}

.xllw-bg-p img {
    width: 100%;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">中奖榜</h1>
	</div>
</div>
<div class="xlbody-box">
    <img src="../../image/img/lucky_bg21.jpg" width="100%">
    <div class="xllu-box1">
        <div id="winprize_template_box"></div>
       <div class="xl-refresh-prompt refreshPrompt"></div>
    </div>
    <div id="isNoData" class="xllw-bg-p hidden">
        <img src="../../image/img/lucky_bg22.jpg">
    </div>
</div>
<script id="winprize_template"  type="text/template">
    {{~ it:data}}
    {{?data.newLevel === true}}
    <div class="xllu-title">
        <h5>{{=data.levelObj.name}}中奖名单</h5>
        <div>{{=data.levelObj.title}}</div>
        <div class="xllu-title-img">
            <img src="{{=Common.getImageUrl(data.levelObj.url)}}">
        </div>
    </div>
    {{?}}
    <div class="xl-li xl-lii">
        <a>
            <img class="xl-li-img" src="{{=(data.userImage ? Common.getImageUrl(data.userImage) : '../../image/icon/minePortrait.png')}}">
            <div class="xl-li-txt">
                <div class="ellipsis">用<i class="em05"></i>户<i class="em05"></i>名：{{=data.userName}}</div>
                <div class="ellipsis">奖<i class="em05"></i>券<i class="em05"></i>码：{{=data.featureCode}}</div>
                <div class="ellipsis">开奖时间：{{=timeFormtFn(data.drawTime)}}</div>
            </div>
        </a>
    </div>
    {{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script type="text/javascript">
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		getWinprizeFn(globalData.gameId);
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
    globalData['currentPage'] = 0;
    
    
	var gameId = globalData.pageParam.gameId,
		issueId = globalData.pageParam.issueId;
	globalData.gameId = gameId;
	globalData.issueId = issueId;
    getGameDataFn(gameId);
}
//刷新之后执行函数
function refreshAfterFn(){
	//说明页面所有请求都已经完成
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数，记录归零
		globalData.requestNum = 0;//用来记录有多少次用户请求，记录归零
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}



//获取游戏数据，奖等数据包括在内
function getGameDataFn(gameId){
    if(!gameId){
        Common.toast('没有ID');
        return false;
    }
    var _url = Common.domainUrl + '/ushop-api-merchant/api/lotto/game/get/' + gameId;
    Common.ajax(_url, 'get', {}, function(data){
        if(data.prizes){
            data.prizesArr = JSON.parse(data.prizes + '');
            if(data.prizesArr.length > 0){
                globalData.gameData = data;
                getWinprizeFn(gameId);
            }
        }
    });
}
//获取用户票，中奖的，即中奖数据
function getWinprizeFn(gameId){
	var isNoData = document.getElementById('isNoData'),//没有数据时显示
		listContent = document.getElementById('winprize_template_box'),//列表数据容器
		refreshPrompt = document.querySelector('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('winprize_template'),//模板容器
		currentPage = globalData['currentPage'],//当前页
		pagePage = globalData['pagePage'];//总页数
	if(globalData.winData && globalData.winData.length >= 100){
		refreshPrompt.innerHTML = '最多显示100条记录';
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	refreshPrompt.innerHTML = Common.listLoadingHTML();
    var _url =  Common.domainUrl + '/ushop-api-merchant/api/lotto/ticket/topn/listBy/'+
                currentPage + '/' + gameId + '/0/2';
    Common.ajax(_url, 'get', {}, function(data){
    	if(data.totalCount >= 0){
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage'] = currentPage;
			globalData['pagePage'] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
                listContent.innerHTML = '';
    			refreshPrompt.innerHTML = '这是什么也没有！';
    			isNoData.classList.remove('hidden');
				return false;
			}
			if(currentPage === pagePage){
				refreshPrompt.innerHTML = '没有更多了';
			}else{
				refreshPrompt.innerHTML = '上拉加载';
			}

            globalData.winData = globalData.winData ? globalData.winData.concat(data.recordList) : (data.recordList || []);
            globalData.winData = globalData.winData.sort(function(a, b){
            	return parseInt(a.prizeId) - parseInt(b.prizeId);
            });
            var aid, bid;
            Common.each(globalData.winData, function(index, obj){
                obj.levelObj = {};
                if((globalData.winData[index - 1] || {}).prizeId === obj.prizeId){
                    obj.newLevel = false;
                }else{
                    obj.newLevel = true;
                }
                Common.each(globalData.gameData.prizesArr, function(pi, po){
                    if(po.index == obj.prizeId){
                        obj.levelObj = po;
                        return false;
                    }
                });
           });
			var dataListTemplate = doT.template(template.innerHTML);
			listContent.innerHTML = dataListTemplate(globalData.winData);
    	}else{
            refreshPrompt.innerHTML = '数据错误';
    	}
    });
}


//时间格式化，20170506101010
//这种时间的格式化为 2017-05-06 10:10:10
function timeFormtFn(a){
	if(!a){return ''};
	var y = a.substr(0, 4),
		m = a.substr(4, 2),
		d = a.substr(6, 2),
		h = a.substr(8, 2),
		i = a.substr(10, 2),
		s = a.substr(12, 2);
	return y + '-' + m + '-' + d + ' ' + h + ':' + i + ':' + s;
}
</script>
</body>
</html>