<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>抽奖首页</title>
<link rel="stylesheet" type="text/css" href="../../css/owl.carousel.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.hboverhidden {
    height: 100%;
    overflow: hidden;
}
.xllh-content {
    position: relative;
    background: #ff6d00 url(../../image/img/lucky_bg12.jpg) no-repeat;
    background-size: 100%;
}
.xllh-box1 {
    width: 90%;
    margin: 0 auto;
    background: #af38ba;
    border: solid 2px #fffc9f;
    border-radius: 1em;
    padding: .5em;
}
.xllh-li {
    background: #fff6cb;
    border: solid 2px #ffc500;
    border-radius: 1.5em 0 1.5em 0;
    padding: .5em;
    font-size: .8em;
}
.xllh-d1 {
    position: relative;
}
.xllh-d1 .xllh-img1 {
    position: absolute;
    top: 5%;
    left: 50%;
    -webkit-transform: translateX(-50%);
    transform: translateX(-50%);
    height: 80%;
    width: auto !important;
}
.xllh-d2 {
    color: #ff8302;
    font-weight: bold;
    font-size: 1.2em;
    text-align: center;
}
.xllh-d3 {
    color: #ff8302;
    text-align: center;
}
.xllh-d4 {
    position: relative;
    height: 1.4em;
    margin: 0 -.5em;
}
.xllh-d5 {
    color: #9a4e00;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    margin: 0 -.5em;
    padding: 0 .5em;
}
.xllh-d5:nth-child(2n) {
    background: #ffe3b1;
}
.xllh-li .xllh-btn1 {
    background: #ff4a01;
    color: #fff;
    border: 0;
    border-radius: .3em;
    display: block;
    width: 100%;
    padding: .5em 0;
    font-size: 1.2em;
}
.xllh-li .xllh-btn1:active {
    background: #bbb;
}
.xllh-li .xllh-btn1.disabled,
.xllh-li .xllh-btn1:disabled {
    background: #bfbfbf;
}


.xl-countdown-box {
    height: 100%;
    text-align: center;
    letter-spacing: -1px;
    color: #ff8302;
}
.xlcb-time {
    position: relative;
    height: 100%;
    display: inline-block;
    background: #ff8500;
    border-radius: .3em;
    width: 12%;
    vertical-align: top;
    letter-spacing: 0;
    line-height: 1;
}
.xlcb-time:before,
.xlcb-time:after {
    content: '';
    position: absolute;
    width: .2em;
    height: .2em;
    background: #9c00a9;
    top: 50%;
    left: 0;
    margin-top: -.1em;
}
.xlcb-time:after {
    left: auto;
    right: 0;
}
.xlcb-time i {
    height: 100%;
    width: 100%;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
}
.xlcb-divide {
    position: relative;
    display: inline-block;
    width: 3%;
    height: 100%;
    vertical-align: top;
}
.xlcb-divide:before,
.xlcb-divide:after {
    content: '';
    position: absolute;
    left: 50%;
    top: 20%;
    margin-left: -.1em;
    width: .2em;
    height: .2em;
    background: #ff8500;
}
.xlcb-divide:after {
    top: auto;
    bottom: 20%;
}


.xllh-box3 {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    letter-spacing: .5em;
    padding: 1em;
    text-align: center;
    z-index: 9;
}
.xllh-box3 .xlbtn {
    position: relative;
    color: #fff;
    background: #ffa200;
    border: solid 2px #fff79a;
    padding: .8em;
    font-size: 1.2em;
    border-radius: .6em;
}
.xllh-box3 .xlbtn:active {
    background: #ccc;
}


.xllh-box2 {
    background: #ffdc8b;
    border: solid 2px #feb800;
    width: 90%;
    margin: 0 auto;
    border-radius: .6em;
    padding: .5em 0;
}
.xllh-title1 {
    background: -webkit-linear-gradient(left, rgba(251, 191, 118, 1) , rgba(251, 191, 118, 0));
    background: linear-gradient(to right, rgba(251, 191, 118, 1) , rgba(251, 191, 118, 0));
    font-size: .8em;
    padding: 0 .5em;
}
.xllh-table1 {
    position: relative;
    line-height: 1.8em;
    font-size: .8em;
    height: 5.4em;
    overflow: hidden;
}
.xllh-table1-box {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
}
.xllh-td {
    float: left;
    padding: 0 .5em;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}
.xllh-td1 {
    width: 28%;
}
.xllh-td2 {
    width: 40%;
}
.xllh-td3 {
    width: 32%;
}


.xllh-alert-box {
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
}
.xllh-alert-body {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    transform: translateY(-50%);
}
.xllh-alert-body > img {
    width: 100%;
}
.xlele-box.xllh-alert-box .xlele-content {
    background: rgba(0, 0, 0, 0.8);
    height: 100%;
}
.xllh-help-con {
    position: absolute;
    left: 15%;
    right: 15%;
    top: 21%;
    bottom: 18%;
    overflow-y: auto;
    color: #fff;
}
.xllh-help-close {
    position: absolute;
    top: 5%;
    bottom: 85%;
    left: 80%;
    right: 6%;
}
.xllh-card-con {
    position: absolute;
    top: 18%;
    bottom: 22%;
    left: 23%;
    right: 23%;
    overflow-y: auto;
}
.xllh-card-btn1 {
    position: absolute;
    top: 87%;
    bottom: 5%;
    left: 20%;
    right: 55%;
}
.xllh-card-btn2 {
    position: absolute;
    top: 87%;
    bottom: 5%;
    left: 53%;
    right: 22%;
}


.xllh-card-li {
    position: relative;
}
.xllh-card-li > img {
    width: 100%;
}
.xllh-card-item {
    position: absolute;
    top: 0;
    left: 4%;
    right: 24%;
    bottom: 6%;
    display: flex;
    align-items: center;
    color: #fff;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
    font-size: .8em;
}
.xllh-card-p1 {
    font-size: 1.2em;
    color: #faff02;
}

.owl-theme .owl-dots {
	position: initial;
	text-align: center;
	margin-top: 8px;
}
.owl-carousel .owl-nav .owl-prev,
.owl-carousel .owl-nav .owl-next {
    position: absolute;
    left: -24px;
    top: 50%;
    height: 8em;
    margin-top: -4em;
    padding: 0;
    background: none !important;
}
.owl-carousel .owl-nav .owl-prev.disabled,
.owl-carousel .owl-nav .owl-next.disabled {
	opacity: .5;
}
.owl-carousel .owl-nav .owl-next {
    left: auto;
    right: -24px;
    transform: rotate(180deg);
}
.owl-carousel .owl-nav .owl-prev img,
.owl-carousel .owl-nav .owl-next img {
    height: 100%;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">抽奖首页</h1>
	</div>
</div>
<div class="xlbody-box">
    <img src="../../image/img/lucky_bg11.jpg" width="100%">
    <div class="xllh-content">
        <div class="xllh-box1" id="prize_template_box"></div>
        <div style="height: 1em;"></div>
        <div class="xllh-box2">
            <div class="xllh-title1">中奖信息</div>
            <div class="xllh-table1">
                <div class="xllh-table1-box" id="winprize_template_box"></div>
            </div>
        </div>
        <div style="height: 5.4em;"></div>
    </div>
</div>
<div class="xllh-box3">
    <button class="xlbtn" onclick="showHideEle('foot_help_box', 'show')">帮助</button>
    <button class="xlbtn" onclick="goWinlistFn()">中奖票</button>
    <button class="xlbtn" onclick="goMylistFn()">我的奖券</button>
</div>
<div class="xlele-box xllh-alert-box hidden" id="foot_help_box">
	<div class="xlele-content">
        <div class="xllh-alert-body">
            <img src="../../image/img/lucky_bg4.png">
            <div class="xllh-help-con" id="foot_help_txt"></div>
            <div class="xllh-help-close" onclick="showHideEle('foot_help_box', 'hide')"></div>
        </div>
	</div>
</div>
<div class="xlele-box xllh-alert-box hidden" id="foot_card_box">
	<div class="xlele-content">
        <div class="xllh-alert-body">
            <img src="../../image/img/lucky_bg5.png">
            <div class="xllh-card-con">
                <div class="xllh-card-ul" id="card_ul_box"></div>
            </div>
            <div class="xllh-card-btn1" onclick="showHideEle('foot_card_box', 'hide')"></div>
            <div class="xllh-card-btn2" onclick="showHideEle('foot_card_box', 'hide')"></div>
        </div>
	</div>
</div>
<script id="prize_template"  type="text/template">
	<div class="xllh-ul owl-carousel owl-theme">
	    {{~ it:level}}
	    {{~level.issueArr:issue}}
	    <div class="xllh-li">
	        <div class="xllh-d2 text-ellipsis">{{=level.name || '　'}}</div>
	        <div class="xllh-d1">
	            <img src="../../image/img/lucky_icon1.png" width="100%">
	            <img src="{{=Common.getImageUrl(level.url)}}" class="xllh-img1">
	        </div>
	        <div class="xllh-d2 text-ellipsis">{{=level.title || '　'}}</div>
	        <div class="xllh-d3">开奖倒计时</div>
	        <div style="height: 3px;"></div>
	        <div class="xllh-d4">
	            <div class="xl-countdown-box xlplCountdown" end-time="{{=issue.endSaleTime}}" timeNum="{{=timeFormtFn(issue.drawTime)}}"></div>
	        </div>
	        <div class="xllh-d5">开奖日期：</div>
	        <div class="xllh-d5">{{=timeFormtFn(issue.drawTime).substr(2, 14)}}</div>
	        <div class="xllh-d5">参与票数：</div>
	        <div class="xllh-d5">{{=(issue.totalSaleTick || 0)}}</div>
	        <div class="xllh-d5">奖品个数：</div>
	        <div class="xllh-d5">{{=level.prizeCount || 0}}个</div>
	        <div class="xllh-d5">参与条件：</div>
	        <div class="xllh-d5">注册赠送</div>
	        <div style="height: 5px;"></div>
	        <button class="xllh-btn1 look_btn" disabled onclick="goLuckyTimeout('{{=level.index}}', '{{=issue.id}}')">观看开奖</button>
	    </div>
	    {{~}}
	    {{~}}
    </div>
</script>
<script id="winprize_template"  type="text/template">
    {{~ it:data}}
    <div class="xllh-tr clearfix">
        <div class="xllh-td xllh-td1">{{=data.userName}}</div>
        <div class="xllh-td xllh-td2">{{=(data.levelObj.name + ' ' + data.levelObj.title)}}</div>
        <div class="xllh-td xllh-td3">{{=timeFormtFn(data.drawTime).substr(0, 10)}}</div>
    </div>
    {{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/owl.carousel.min.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script type="text/javascript">
"use strict";
//期次和游戏的共用状态
globalData.gameStatusArr = [
	{val: -2, key: '废弃'},
	{val: -1, key: '暂停'},
	{val: 1, key: '准备中'},//不可见
	{val: 2, key: '运行中'},
	{val: 3, key: '揭晓中'},
	{val: 4, key: '已揭晓'},
	{val: 5, key: '无人中奖'}
];

//奖品类型
globalData.gameTypeArr = [
	{val: '1', key: '实体类'},
	{val: '2', key: '充值类'},
	{val: '3', key: '劵码类'}
];

//票面状态
globalData.gameTicketSArr = [
	{val: '-1', key: '废弃'},
	{val: '1', key: '未开奖'},
	{val: '2', key: '未中奖'},
	{val: '3', key: '已中奖'},
	{val: '6', key: '已弃奖'}
];
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
	globalData.gameId = globalData.pageParam.activeId;
}
//dom事件绑定
function domEventFn(){
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	if ( !globalData.gameId ) {
		Common.toast('游戏ID不存在！');
		return false;
	}
	// 请求期次奖等数据
	Common.ajaxAll([
		{url: (Common.domainUrl + '/ushop-api-merchant/api/lotto/game/get/' + globalData.gameId)},
		{url: (Common.domainUrl + '/ushop-api-merchant/api/lotto/issue/visible/listBy/1/' + globalData.gameId)}
	], function () {
		var gdata = arguments[0],
			idata = arguments[1];
		if ( !( gdata.prizes && idata.recordList ) ) {
			Common.toast('数据错误！');
			return false;
		}
		try {
			gdata.prizesArr = JSON.parse(gdata.prizes);
		} catch (err) {
			gdata.prizesArr = [];
		}
		gameDatafinish(gdata, idata.recordList); // 数据整理
		globalData.gameData = gdata;
		getWinprizeFn(globalData.gameId); // 中奖用户请求
	});
}



//获取用户票，中奖的，也就是中奖数据，用于底部轮播
function getWinprizeFn(gameId){
    var _url =  Common.domainUrl + '/ushop-api-merchant/api/lotto/ticket/topn/listBy/'+
                '1/' + gameId + '/0/2';
    Common.ajax(_url, 'get', {}, function(data){
        if(data.recordList && data.recordList.length > 0){
            var prevObj = {};
            Common.each(data.recordList, function(index, obj){
                obj.levelObj = {};
                if(prevObj.prizeId === obj.prizeId){
                    obj.newLevel = false;
                }else{
                    obj.newLevel = true;
                }
                Common.each(globalData.gameData.prizesArr, function(pi, po){
                    if(po.index == obj.prizeId){
                        obj.levelObj = po;
                        return false;
                    }
                });
                prevObj = obj;
            });
			var dataListTemplate = doT.template(document.getElementById('winprize_template').innerHTML);
			document.getElementById('winprize_template_box').innerHTML = dataListTemplate(data.recordList);
            if(data.recordList.length > 3){
                applayNoticeList();
            }
        }
    });
}

//游戏数据整理
function gameDatafinish(gameData, issueData){
    Common.each(issueData, function(ii, io){
        Common.each(gameData.prizesArr, function(pi, po){
            if(po.index == io.prizeId){
                if(po.issueArr){
                    po.issueArr.push(io);
                }else{
                    po.issueArr = [io];
                }
                return false;
            }
        });
    });
    globalData.gameData = gameData;
    Common.getServiceTT(function(timestamp){
    	//先清除已经过期了的期次
	    Common.each(gameData.prizesArr, function(index, obj){
	    	Common.each(obj.issueArr, function(i, o){
	    		if ( o ) {
		    		var oms = Common.msToTime(timeFormtFn(o.drawTime)).ms;
		    		if(oms < timestamp){
		    			obj.issueArr.splice(i, 1);
		    		}
	    		}
	    	});
	    });
	    document.getElementById('foot_help_txt').innerHTML = gameData.remark;
	    var dataListTemplate = doT.template(document.getElementById('prize_template').innerHTML);
	    $('#prize_template_box')
	    .html(dataListTemplate(gameData.prizesArr))
	    .find('.owl-carousel').owlCarousel({
	        autoplay: false,
	        autoplayTimeout: false,
	        items: 3,
	        loop: false,
	        touchDrag: true,
	        mouseDrag: true,
	        margin: 5,
	        dots: true,
	        dotsEach: 3,
	        nav: true,
	        navText: ['<img src="../../image/img/lucky_icon4.png">', '<img src="../../image/img/lucky_icon4.png">']
	    });
	    countdownFn();//倒计时处理
    });
}

//奖券请求
function getLotteryList(){
    if(isToastFn() === 'yes'){return false;};
	var _url = '/ushop-api-merchant/api/lotto/ticket/user/listBy',
		_param = {
			'page': 1,
			'gameId': globalData.gameId,
			'status': '100',
			'date': ''
		};
	Common.ajax(_url, 'get', _param, function(data){
        if(data.totalCount > 0){
            var str = '';
            Common.each(data.recordList, function(index, obj){
                str +=
                '<div class="xllh-card-li">'+
                    '<img src="../../image/img/lucky_icon3.png">'+
                    '<div class="xllh-card-item">'+
                        '<div>'+
                            '<div class="xllh-card-p1">抽奖抬头</div>'+
                            '<div>开奖时间</div>'+
                            '<div>' + timeFormtFn(obj.drawTime) + '</div>'+
                            '<div>奖券号</div>'+
                            '<div>' + obj.featureCode + '</div>'+
                        '</div>'+
                    '</div>'+
                '</div>';
            });
            document.getElementById('card_ul_box').innerHTML = str;
            showHideEle('foot_card_box', 'show');
            isToastFn('yes');//记录已经提示过了
		}
	});
}

//是否已经提示奖券
function isToastFn(val){
    if(val === 'yes'){
        Common.storageL('ls_partly_ldlm_game_card' + Common.userIdStr(), val);
    }else{
        return Common.storageL('ls_partly_ldlm_game_card' + Common.userIdStr());
    }
}


//时间格式化，20170506101010
//这种时间的格式化为 2017-05-06 10:10:10
function timeFormtFn(a){
	if(!a){return ''};
	var y = a.substr(0, 4),
		m = a.substr(4, 2),
		d = a.substr(6, 2),
		h = a.substr(8, 2),
		i = a.substr(10, 2),
		s = a.substr(12, 2);
	return y + '-' + m + '-' + d + ' ' + h + ':' + i + ':' + s;
}



//倒计时函数
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 5000;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('span'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			interFn();
			timeInter[timeInter.length] = setInterval(interFn, interTime);
			function interFn(){
	            if(timeDif <= 300000){
	                $me.parents('.xllh-li').find('.look_btn')[0].disabled = false;
	            }
				if(timeDif > interTime){
				    var d = parseInt((timeDif%8553600000)/(86400000)),
	                    h = parseInt((timeDif%86400000)/(3600000)),
				    	i = parseInt((timeDif%3600000)/(60000)),
				    	s = parseInt((timeDif%60000)/1000),
				    	ms = parseInt((timeDif%1000)/100);
	                d = d < 10 ? ('0' + d) : d;
				    h = h < 10 ? ('0' + h) : h;
				    i = i < 10 ? ('0' + i) : i;
				    s = s < 10 ? ('0' + s) : s;
	                me.innerHTML = d + '天' + h + '小时' + i + '分';
					timeDif = timeDif - interTime;
				}else if(timeDif < -interTime){
					clearInterval(timeInter[index]);
					reloadDataFn();
				}else if(timeDif <= interTime){
					timeDif = timeDif - interTime;
				}else{
					clearInterval(timeInter[index]);
				}
			}
		});
		globalData.interCountdown = timeInter;
	});
}


//轮播，上下
//这里用jQuery
function applayNoticeList() {
	var ul = $('#winprize_template_box');
	var li = ul.find('.xllh-tr');
	var lih = li.eq(0).height();
	var lgn = li.length;
	if(lgn > 1){
		clearInterval(globalData.setinter);
		globalData.setinter = setInterval(function() {
			ul.animate({top: ('-' + lih + 'px')}, 500, 'linear', function(){
				ul.find('.xllh-tr').eq(0).appendTo(ul);
				ul.animate({top: 0}, 0, 'linear');
			});
		}, 4000);
	}
}

//去到中奖列表排行
function goWinlistFn(){
	Common.openPage('../lucky_draw/lucky_winlist.html', {gameId: globalData.gameId});
}

//去到我的票据列表
function goMylistFn(){
	Common.openPage('../lucky_draw/lucky_mylist.html', {gameId: globalData.gameId});
}

//观看开奖
function goLuckyTimeout(levelIndex, issueId){
    Common.openPage('../lucky_draw/lucky_timeout.html', {levelIndex: levelIndex, issueId: issueId, gameId: globalData.gameId});
}


//显示隐藏相应的元素
function showHideEle(eleId, type){
    if((typeof eleId) === 'string'){
        eleId = document.getElementById(eleId);
    }
    if(type === 'show'){
        eleId.classList.remove('hidden');
    }else if(type === 'hide'){
        eleId.classList.add('hidden');
    }
}
</script>
</body>
</html>