<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>积分抽奖</title>
<link rel="stylesheet" type="text/css" href="../../css/owl.carousel.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xllist-box {
	position: relative;
}
.xllist-menu {
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	z-index: 2;
}
.xllist-menu.fixed {
	position: fixed;
	top: 0;
}
.xllist-menu .xllist-menu-content {
	background: #f6f6f6;
	padding-top: 5px;
	max-width: 720px;
	margin: 0 auto;
}
.xllist-menu-placeholder.xllist-menu {
	position: relative;
	top: 0;
	opacity: 0;
	filter: alpha(opacity=0);
}
.xllist-menu .xllist-menu-item {
	position: relative;
	float: left;
	width: 25%;
	text-align: center;
	padding: .5em 0;
	cursor: pointer;
	font-size: 1.2em;
	background: url(../../image/icon/biaoqian.png) no-repeat;
	background-size: 100% 100%;
}
.xllist-menu .xllist-menu-item.active {
	color: #ff5534;
	background: url(../../image/icon/biaoqian01.png) no-repeat;
	background-size: 100% 100%;
}
.xllist-menu .xllist-menu-item span {
	position: relative;
	z-index: 2;
}
.xllist-menu .xli-sort-bg {
	padding-right: .8em;
	display: inline-block;
	background: url(../../image/icon/shop_icon21.png) right center no-repeat;
	background-size: .5em;
}
.xllist-menu-item.active[sort="1"] .xli-sort-bg {
	background: url(../../image/ecommerce/shop_icon22.png) right center no-repeat;
	background-size: 8px;
}
.xllist-menu-item.active[sort="2"] .xli-sort-bg {
	background: url(../../image/ecommerce/shop_icon23.png) right center no-repeat;
	background-size: 8px;
}


/*首页产品列表*/
.xl-product-list {
	list-style: none;
	margin: 0;
	padding: 0;
	font-size: .8em;
}
.xl-product-list .xl-product-cell {
	float: left;
	width: 33.33333%;
	padding: 10px 5px;
	border: solid 1px #f6f6f6;
	background: #fff;
	margin: -1px 0 0 0;
	border-left: 0;
}
@media (max-width: 500px){
	.xl-product-list .xl-product-cell {
		width: 50%;
	}
}
.xl-product-list .xl-product-pic img {
	display: block;
	width: 100%;
}
.xl-product-list .xl-product-pic {
	position: relative;
	width: 50%;
	margin: 0 auto;
}
.xl-product-list .xl-data-img {
	position: absolute;
	left: 0;
	top: 0;
}
.xl-product-purchase {
	position: relative;
	padding: 5px 6em 5px 5px;
	background: #f6f6f6;
	border-radius: 6px;
}
.xl-product-purchase .xl-btn {
	position: absolute;
	right: 0;
	top: 50%;
	margin-top: -1.2em;
	line-height: 2em;
	padding: 0 .5em;
	border-radius: 2em;
	color: #fff;
	background: #fd8934;
}
.xl-product-list .xl-product-p1 {
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	color: #333;
	line-height: 1.4;
	padding: 8px 0 5px 5px;
}
.xl-product-list .xl-product-p2 {
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	line-height: 1.4;
	color: #888;
}
.xl-product-list .xl-product-p2 span {
	color: #ff5534;
}



.xllist-box .xlmenu-box {
	position: absolute;
	top: 100%;
	left: 0;
	width: 100%;
	background: #eee;
	z-index: 10;
}
.xllist-box .xlmenu-box .xl9g-img {
	width: 2em;
	height: 2em;
}

.xlh-box1 {
	padding: 10px 0;
}
.xlh-box1 .xlmenu-item {
	width: 50%;
	position: relative;
}
.xlh-box1 .xlmenu-item:after {
	content: '';
	position: absolute;
	width: 2px;
	background: #a0a0a0;
	left: 0;
	top: 5px;
	bottom: 5px;
}
.xlh-box1 .xlmenu-item:first-child:after {
	width: 0;
}
.xlh-box1.xlmenu-box .xl9g-img {
	width: 3.5em;
	margin-bottom: .5em;
}

.xllist-menu-class {
	background: #ff9c37 !important;
	color: #fff !important;
	border-radius: 8px 8px 0 0;
}
.xllist-menu-class span {
	padding-left: 1.5em;
	display: inline-block;
	background: url(../../image/icon/shop_icon1.png) left center no-repeat;
	background-size: 1.2em;
}


/*最新揭晓*/
.xls-bargain-box {
	background: #fff;
}
.xls-bargain-title {
	font-size: 16px;
	font-weight: bold;
	color: #ff7f1c;
	padding: 10px 15px;
}
.xls-bargain-title a {
	float: right;
	color: #959595;
	font-size: 14px;
	font-weight: 400;
}
.xls-bargain-item {
	position: relative;
	width: 100%;
	min-height: 4em;
}
.xls-bargain-null {
	line-height: 4em;
	text-align: center;
}
.xls-bargain-li {
	position: relative;
	text-align: center;
	font-size: 14px;
	line-height: 1.2;
	margin: 0 auto;
}
.xls-bargain-img {
	position: relative;
	width: 60%;
	padding-bottom: 5px;
	margin: 0 auto;
}
.xls-bargain-li img {
	width: 100%;
}
.xls-bargain-li .xls-image {
	position: absolute;
	left: 0;
	top: 0;
	z-index: 1;
}
.xls-bargain-li .xls-bargain-p1 {
	color: #ff2e2f;
}
.xls-bargain-li .xls-bargain-p2 {
	font-size: .9em;
	color: #959595;
	position: relative;
	display: inline-block;
}
.xls-bargain-li .xls-bargain-p2:after {
	content: '';
	position: absolute;
	left: 0;
	top: 45%;
	width: 100%;
	height: 1px;
	background: #959595;
}
.hiddenGist {
	display: none !important;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">彩豆彩购</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlbanner-box">
		<img class="xlbanner-pla-img" src="../../image/p300100.png">
		<div id="bannerBox" class="owl-carousel owl-theme xlbanner-body"></div>
	</div>
	<div class="xls-bargain-box">
		<div class="xls-bargain-title">
			最新揭晓
			<a href="../indiana/announce.html">更多</a>
		</div>
		<div id="scollGoodsBox" class="xls-bargain-item">
			<div class="xls-bargain-null">加载中……</div>
		</div>
	</div>
	<div class="xllist-box" id="productListBox">
		<div class="xllist-menu xllist-menu-placeholder">
			<div class="xllist-menu-content clearfix">
				<div class="xllist-menu-item">
					<span>人气</span>
				</div>
			</div>
		</div>
		<div class="xllist-menu listTitle">
			<div class="xllist-menu-content clearfix">
				<a class="xllist-menu-item xllist-menu-class" href="../indiana/search.html">
					<span>分类</span>
				</a>
				<div class="xllist-menu-item titleItem active" typenum="1">
					<span>最新</span>
				</div>
				<div class="xllist-menu-item titleItem" typenum="2">
					<span>价格</span>
				</div>
				<div class="xllist-menu-item titleItem" typenum="3">
					<span>销量</span>
				</div>
			</div>
		</div>
		<div id="listContent1" class="xllist-item xllistItem">
		    <ul class="clearfix xl-product-list"></ul>
		    <div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div id="listContent2" class="xllist-item xllistItem">
		    <ul class="clearfix xl-product-list"></ul>
		    <div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div id="listContent3" class="xllist-item xllistItem active">
		    <ul class="clearfix xl-product-list"></ul>
		    <div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/owl.carousel.min.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});


//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
	var $win = $(window),
		listBox = $('#productListBox'),
		listTitle = listBox.find('.listTitle'),
		titleItems = listTitle.find('.titleItem'),
		listItems = listBox.find('.xllistItem'),
		returnTop = $('#returnTop');
	//绑定分类菜单点击事件
	titleItems.on('click', function(){
		var $me = $(this);
		if(!$me.hasClass('active')){
			//显示界面
			var typenum = $me.attr('typenum');
			titleItems.removeClass('active');
			$me.addClass('active');
			
			//如果已经是悬浮状态，切换时回到悬浮顶端
			if(listTitle.hasClass('fixed')){
				$('body, html').scrollTop(listBox.offset().top);
			}
			listItems.removeClass('active');
			$('#listContent' + typenum).addClass('active');
			//用来规定刷新频率
			delayedSearchFn(typenum);
		}
	});
	//滚动条滚动事件绑定
	$win.on('scroll', function(){
		if(listBox.offset().top - $win.scrollTop() < 0){
			listTitle.addClass('fixed');
			returnTop.removeClass('hide');
		}else if(!returnTop.hasClass('hide')){
			listTitle.removeClass('fixed');
			returnTop.addClass('hide');
		}
	});
	
	//到底部加载
	Common.scrollBottom(function(){
		productShowFn(listTitle.find('.active').attr('typenum'));
	});
	//返回顶部
	returnTop.on('click', function(){
		$('body, html').animate({'scrollTop': '0'}, 100);
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	listParamInt();//列表参数初始化
	
	//刷新数据请求函数
	productShowFn(1);//产品列表请求显示
	bannerShowFn();//banner图显示
	getAnnounceFn();//最新揭晓
}
//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//列表参数初始化
function listParamInt(){
	var listBox = $('#productListBox'),
		titleItems = listBox.find('.titleItem'),
		listItems = listBox.find('.xllistItem');
	//页面刷新时，数据初始化
	titleItems.each(function(index, item){
		var typenum = $(item).attr('typenum');
		globalData['currentPage' + typenum] = 0;//当前页
		globalData['pagePage' + typenum] = 1;//总页数
	});
	
	titleItems.removeClass('active');
	listItems.removeClass('active');
	titleItems.eq(0).addClass('active');
	listItems.eq(0).addClass('active');
}

//延迟搜索
function delayedSearchFn(typenum){
	if(!typenum){return false;}
	//用来规定刷新频率
	if(globalData['isReloadPageData' + typenum] === undefined || globalData['isReloadPageData' + typenum] === true){
		globalData['currentPage' + typenum] = 0;
		globalData['pagePage' + typenum] = 1;
		productShowFn(typenum);
		globalData['isReloadPageData' + typenum] = false;
		setTimeout(function(){
			globalData['isReloadPageData' + typenum] = true;
		},30000);
	}
};
//产品列表请求显示
//选项卡式产品列表示例
function productShowFn(typenum){
	var listItem = $('#listContent' + typenum),//列表项目
		listContent = listItem.find('ul'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		currentPage = globalData['currentPage' + typenum],
		pagePage = globalData['pagePage' + typenum],
		activeEle = $('#productListBox').find('.titleItem.active');
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	typenum = typenum || activeEle.attr('typenum');
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/product/search/listByStyle/' + typenum + '/' + currentPage + '.json'
	Common.ajax(_url, 'get', {}, function(data){
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + typenum] = currentPage;
			globalData['pagePage' + typenum] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var str = '', rate, headImage = '';
			$.each(data.recordList, function(index, obj){
				rate = parseInt(100*obj.spellbuyCount/obj.spellbuyPrice);
				headImage = obj.object.headImage ? Common.getImageUrl(obj.object.headImage) : '../../image/p200200.png';
				
				str +=
					'<li class="xl-product-cell">'+
				        '<div class="xl-product-body">'+
			                '<a class="xl-product-img" href="../indiana/product_details.html?productId=' + obj.productId + '&spellbuyId=' + obj.id + '">'+
			                	'<div class="xl-product-pic">'+
				                	'<img src="../../image/p200200.png">'+
				                	'<img class="xl-data-img" src="' + headImage + '">'+
			                	'</div>'+
			                	'<div class="xl-product-p1">' + obj.object.productName + '</div>'+
			                '</a>'+
				            '<div class="xl-product-purchase">'+
				            	'<div class="xl-product-p2">开奖进度：<span>' + rate + '%</span></div>'+
				            	'<div class="xl-progressbar">'+
			    	        		'<span style="width: ' + rate + '%;"></span>'+
			        	    	'</div>'+
			               		'<a href="../indiana/product_details.html?fromTo=btn&productId=' + obj.productId + '&spellbuyId=' + obj.id + '" class="xl-btn">立即参与</a>'+
			            	'</div>'+
				        '</div>'+
			        '</li>';
			});
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	});
}


//banner图显示
function bannerShowFn(){
    var pId = Common.localProL().id || 62,
		_url =  Common.domainUrl + '/ushop-api-merchant/api/sns/notify/banner/list/7/' + pId + '.json?timestamp=' + (+new Date());
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList && data.recordList.length > 0){
			var str = '',
				img = new Image(),
				bannerBox = $("#bannerBox"),
				hr = 'javascript:;', activityId;
			img.src = Common.getImageUrl(data.recordList[0].pictureAddress);
			$.each(data.recordList, function(index, obj){
				activityId = obj.relationWebId;
				$.each(globalActivity, function(i, o){
					if(activityId == o.id){
						hr = o.url;
						return false;
					}
				});
				str += '<div class="item"><a href="' + hr + '"><img src="' + Common.getImageUrl(obj.pictureAddress) + '"></a></div>';
			});
			img.onload = function(){
				bannerBox.html(str);
				bannerBox.owlCarousel({
					autoplay: true,
					autoplayTimeout: 5000,
					items: 1,
					loop: true
				});
			}
		}
	});
}



//最新揭晓
function getAnnounceFn(type){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/product/lottery/listByAnnouncing/1/10',
		listContent = document.getElementById('scollGoodsBox');
	if(type == true){
		_url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/product/lottery/listByAnnounced/1/10';
	}
	Common.ajax(_url, 'get', {}, function(data){
		if(data.totalCount >= 0){
			if(type == true){
				globalData.announceList = globalData.announceList.concat(data.recordList || []);
				if(globalData.announceList.length == 0){
					listContent.innerHTML = '<div class="xls-bargain-null">没有数据</div>';
					return false;
				}else if(globalData.announceList.length > 4){
					globalData.announceList.length = 4;
				}
				announceListShow(globalData.announceList);
			}else{
				if(data.totalCount >= 4){
					data.recordList.length = 4;
					announceListShow(data.recordList);
				}else{
					globalData.announceList = data.recordList || [];
					getAnnounceFn(true);
				}
			}
		}else{
			listContent.innerHTML = '<div class="xls-bargain-null">数据错误</div>';
		}
	});
}

function announceListShow(announceList){
	var listContent = document.getElementById('scollGoodsBox'),
		str = '',
		imgStr = '';
	$.each(announceList, function(index, obj){
		imgStr = obj.productImage || (obj.object && obj.object.headImage) || '';
		imgStr = imgStr ? ('<img class="xls-image" src="' + Common.getImageUrl(imgStr) + '">') : '';
		str +=
				'<div class="xls-bargain-li">'+
					'<div class="xls-bargain-img">'+
						'<a>'+
						imgStr+
						'<img src="../../image/p200200.png">'+
						'</a>'+
					'</div>'+
					'<div class="xl-countdown-box xlplCountdown hiddenGist" timeNum="' + (obj.announceEndDate || obj.announcedTime) + '">'+
						'<span class="xlcb-time1 xlcb-time timeEle">00</span>'+
						'<span class="xlcb-time2 xlcb-time timeEle">00</span>'+
						'<span class="xlcb-time3 xlcb-time timeEle">00</span>'+
					'</div>'+
				'</div>';
	});
	listContent.innerHTML = 
							'<div class="xls-bargain-ul clearfix owl-carousel owl-theme">'+
							str+
							'</div>';
	goodsMoveFn();//商品滚动事件
	countdownFn();//倒计时
}

//限时特惠商品滑动
function goodsMoveFn(){
	var box = $('#scollGoodsBox'),
		ul = box.find('ul'),
		li = ul.find('li'),
		autoplay = true,
		loop = true,
		touchDrag = true,
		mouseDrag = true;
	if(li.length < 5){
		autoplay =  false;
		loop =  false;
		touchDrag = false;
		mouseDrag = false;
	}
	ul.owlCarousel({
		autoplay: autoplay,
		autoplayTimeout: 5000,
		items: 4,
		loop: loop,
		dots: false,
		touchDrag: touchDrag,
		mouseDrag: mouseDrag
	});
}

//倒计时显示
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 100;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('span'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			if(timeEle.length != 3){
				return false;
			}
			if(timeDif > 0){
				timeInter[timeInter.length] = setInterval(function(){
					if(timeDif > interTime){
					    var i = parseInt((timeDif%3600000)/(60000)),
					    	s = parseInt((timeDif%60000)/1000),
					    	m = parseInt((timeDif%1000)/interTime);
					    i = i < 10 ? ('0' + i) : i;
					    s = s < 10 ? ('0' + s) : s;
					    m = m < 10 ? ('0' + m) : m;
						timeEle[0].innerHTML = i;
						timeEle[1].innerHTML = s;
						timeEle[2].innerHTML = m;
						timeDif = timeDif - interTime;
					}else if(timeDif < -interTime){
						clearInterval(timeInter[index]);
						$me.html('<i style="color: #ff4681;">已揭晓</i>');
					}else if(timeDif <= interTime){
						timeEle[0].innerHTML = '00';
						timeEle[1].innerHTML = '00';
						timeEle[2].innerHTML = '00';
						timeDif = timeDif - interTime;
					}else{
						clearInterval(timeInter[index]);
					}
				}, interTime);
			}else{
				$me.html('<i style="color: #ff4681;">已揭晓</i>');
			}
			$me.removeClass('hiddenGist');
		});
		globalData.interCountdown = timeInter;
	});
}


//限时特惠商品滑动
function goodsMoveFn(){
	var box = $('#scollGoodsBox'),
		ul = box.find('.xls-bargain-ul'),
		li = ul.find('.xls-bargain-li'),
		autoplay = true,
		loop = true,
		touchDrag = true,
		mouseDrag = true;
	if(li.length < 5){
		autoplay =  false;
		loop =  false;
		touchDrag = false;
		mouseDrag = false;
	}
	ul.owlCarousel({
		autoplay: autoplay,
		autoplayTimeout: 5000,
		items: 4,
		loop: loop,
		dots: false,
		touchDrag: touchDrag,
		mouseDrag: mouseDrag
	});
}
</script>
</body>
</html>
