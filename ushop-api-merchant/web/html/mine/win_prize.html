<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>我的中奖</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlwp-li {
	position: relative;
	color: #bbb;
	line-height: 1.4;
	background: #fff;
	padding: .5em 6em;
}
.xlwp-li .xlwp-p1 {
	color: #414141;
	font-size: 1.2em;
}
.xlwp-li .xlwp-li-img {
	position: absolute;
	left: .8em;
	top: 50%;
	margin-top: -2.5em;
	height: 5em;
	width: 5em;
}
.xlwp-li .xlwp-s1 {
	color: #ff5534;
}
.xlwp-li .xlwp-btn {
	position: absolute;
	right: .8em;
	top: 50%;
	margin-top: -2em;
	height: 4em;
	width: 4em;
	text-align: center;
	line-height: 4em;
}
.xlwp-li .xlwp-btn img {
	width: 100%;
	height: 100%;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">我的中奖</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlwp-box1" id="winPrizeBox">
		<ul class="xlwp-ul"></ul>
		<div class="xl-refresh-prompt refreshPrompt"></div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		winPrizeDataFn();//我的中奖请求
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//页面刷新时，数据初始化
	globalData.currentPage = 0;//当前页
	globalData.pagePage = 1;//总页数
	//刷新数据请求函数
	winPrizeDataFn();//我的中奖请求
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}

//提醒发货
function remindDeliveryFn(){
	Common.toast('提醒成功！')
}

//确认收货
function confirmReceiptFn(me, spellBuyId){
	var _url = '/ushop-api-merchant/api/spellbuy/person/express/confirm/' + spellBuyId;
	Common.ajax(_url, 'post', {}, function(data){
		if(data.status == 4){
			Common.toast('操作成功！');
			$(me).after('<a class="xlwp-btn" href="../indiana/share_form.html?spellBuyId=' + spellBuyId + '"><img src="../../image/icon/sdfx.png"/></a>');
			$(me).remove();
		}
	});
}

//我的中奖请求
function winPrizeDataFn(){
	globalData.currentPage++;
	if(globalData.currentPage > globalData.pagePage){//说明已经是最后一页了
		return false;
	}
	var listItem = $('#winPrizeBox'),//列表项目
		listContent = listItem.find('.xlwp-ul'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt');//加载中提示容器
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserLatestLottery/' + globalData.currentPage + '/10/' + Common.getUserId();
	Common.ajax(_url, 'get', {}, function(data){
		if(data.totalCount >= 0){
			globalData.currentPage = data.currentPage;
			globalData.pagePage = data.pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('');
				Common.blankPageFn(listContent);//显示空白界面
				return false;
			}
			Common.blankPageFn(listContent, 'hide');//隐藏空白界面
			if(globalData.currentPage == globalData.pagePage){
				refreshPrompt.html('没有更多了');
			}else{
				refreshPrompt.html('上拉加载');
			}
			
			var str = '', btnStr = '', imgSrc = '';
			$.each(data.recordList, function(index, obj){
				switch(obj.status){
					//填写收货地址
					case 1: btnStr = '<a class="xlwp-btn" href="../address/address.html?comeFrom=wpSelectAddr&spellBuyId=' + obj.spellbuyProductId + '"><img src="../../image/icon/txshdz.png"/></a>';
					break;
					//提醒发货
					case 2: btnStr = '<a class="xlwp-btn" onclick="remindDeliveryFn()"><img src="../../image/icon/txfh.png"/></a>';
					break;
					//确认收货
					case 3: btnStr = '<a class="xlwp-btn" onclick="confirmReceiptFn(this, \'' + obj.spellbuyProductId + '\')"><img src="../../image/icon/qrsh.png"/></a>';
					break;
					//晒单
//					case 4: btnStr = '<a class="xlwp-btn" href="../indiana/share_form.html?spellBuyId=' + obj.spellbuyProductId + '"><img src="../../image/icon/sdfx.png"/></a>';
					case 4: btnStr = '<a class="xlwp-btn" href="http://www.1leyou.cn/downloadclb/downloadclb.html"><img src="../../image/icon/sdfx.png"/></a>';
					break;
					case 5: btnStr = '<a class="xlwp-btn">已晒单</a>';
					break;
					case 6: btnStr = '<a class="xlwp-btn">弃奖</a>';
					break;
					case 7: btnStr = '<a class="xlwp-btn">审核中</a>';
					break;
					case 8: btnStr = '<a class="xlwp-btn">换货中</a>';
					break;
					default: btnStr = '<a class="xlwp-btn">已完成</a>';
				}
				imgSrc = obj.productImage ? Common.getImageUrl(obj.productImage) : '../../image/p200200.png';
				str +=  '<div class="xlwp-li" spellBuyId="obj.spellbuyProductId">'+
							'<img class="xlwp-li-img" src="' + imgSrc + '"/>'+
							'<div class="xlwp-p1 ellipsis">' + obj.productName + '</div>'+
							'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
							'<div class="ellipsis">总需：' + obj.buyNumberCount + '</div>'+
							'<div class="ellipsis">幸运号码：<span class="xlwp-s1">' + obj.randomNumber + '</span></div>'+
							'<div class="ellipsis">本期参与：<span class="xlwp-s1">' + obj.buyNumberCount + '</span>人次</div>'+
							'<div class="ellipsis">揭晓时间：' + ((obj.announcedTime + '').substr(0, 10)) + '</div>'+
							btnStr+
						'</div>';
			});
			if(globalData.currentPage == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
		}else{
			refreshPrompt.html(data.error_description || '未知错误');
		}
	});
}

</script>
</body>
</html>
