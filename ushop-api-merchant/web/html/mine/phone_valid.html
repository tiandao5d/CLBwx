<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>补全账户</title>
<link rel="stylesheet" type="text/css" href="../../css/owl.carousel.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlpv-box1 {
	text-align: center;
	font-size: 1.2em;
	color: #7d7d7d;
	line-height: 2em;
	padding: .5em .8em;
}
.xlpv-box1 img {
	width: 2em;
	height: 2em;
}
.xlpv-box1 span {
	display: inline-block;
	border-left: solid 1px #ccc;
	padding-left: .3em;
}

.xlpv-box2 {
	padding: .5em .8em;
	color: #7d7d7d;
	background: #fff;
}

.xlpv-box3 {
	padding: 1.5em .8em;
}
.xlpv-s1 {
	width: 50%;
	float: left;
	text-align: center;
	color: #b5b5b5;
}
.xlpv-i1 {
	position: relative;
	margin-bottom: .3em;
	font-size: 1.2em;
}
.xlpv-i1 i {
	position: relative;
	width: 1.6em;
	height: 1.6em;
	color: #fff;
	background: #b5b5b5;
	border-radius: 50%;
	line-height: 1.6em;
	display: inline-block;
	z-index: 1;
}
.xlpv-i1:before {
	content: '';
	position: absolute;
	right: 50%;
	top: .8em;
	margin-top: -1px;
	width: 100%;
	height: 3px;
	background: #b5b5b5;
}
.xlpv-s1:first-child .xlpv-i1:before {
	width: 0;
}
.xlpv-s1.active {
	color: #ff5534;
}
.xlpv-s1.active .xlpv-i1 i,
.xlpv-s1.active .xlpv-i1:before {
	background: #ff5534;
}

.xlpv-p1 {
	position: relative;
	margin-top: .3em;
	background: #fff;
	padding: 0 1.5em;
}
.xlpv-p2 {
	padding-right: 8em;
}
.xlpv-p1 input {
	display: block;
	width: 100%;
	border: 0;
	padding: 1.2em 0;
	line-height: 1;
}
.xlpv-a1 {
	position: absolute;
	top: 50%;
	right: 1.5em;
	color: #2581fc;
	padding: 1em 0;
	line-height: 1em;
	margin-top: -1.5em;
}
.xlpv-a1.disabled {
	color: #999;
}

.xl-btn.xlpv-btn1 {
	width: 90%;
	margin: 1em auto;
	opacity: .9;
}
.xl-btn.xlpv-btn1:active {
	opacity: 1;
}
.xl-btn.xlpv-btn1:disabled,
.xl-btn.xlpv-btn1.disabled {
	background: #555 !important;
	opacity: .9 !important;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">补全账户</h1>
	</div>
</div>
<div class="xlbody-box">
	<div class="xlpv-box1">
		<img src="../../image/icon/logoicon.png">
		<span>填写手机号码</span>
	</div>
	<div class="xlpv-box2">
		<p>1.您正在使用彩乐宝，请先补充账号信息或登录彩乐宝账号；</p>
		<p>2.登录后，您的彩乐宝账号将关联至您的微信账号。您可通过微信登录彩乐宝APP；</p>
		<p>3.彩乐宝承诺保障您的手机号及账号隐私安全；</p>
	</div>
	<div class="xlpv-box3 clearfix" id="progress_box">
		<div class="xlpv-s1 active progress_s1">
			<div class="xlpv-i1"><i>1</i></div>
			<div>填写手机号码</div>
		</div>
		<div class="xlpv-s1 progress_s1">
			<div class="xlpv-i1"><i>2</i></div>
			<div>完成登录</div>
		</div>
	</div>
	<form id="phone_valid" action="yyy.html" class="xlpv-box4">
		<div class="xlpv-p1">
			<input type="number" id="phone" placeholder="请填写手机号">
		</div>
		<div class="xlpv-p1 xlpv-p2">
			<input type="number" id="phone_code" placeholder="验证码">
			<div class="xlpv-a1" onclick="gainCodeFn(this)">发送验证码</div>
		</div>
		<input type="submit" disabled class="submit_btn xlpv-btn1 xl-btn xl-btn-block" value="确定">
		<!--<button disabled class="xlpv-btn1 xl-btn xl-btn-block">确定</button>-->
	</form>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	formValidFn(false);//表单验证
}
//dom事件绑定
function domEventFn(){
	//阻止提交
	$('#phone_valid').submit(function(){
		validSubmitFn();
		return false;
	});
	$('#phone').on('change input', function(e){
		if(!(Common.regExpPhone.test(this.value)) && (e.type != 'input')){
			Common.toast('手机号有误');
		}
		formValidFn(false);
	});
	$('#phone_code').on('change input', function(e){
		if(!(Common.regExpCode.test(this.value)) && (e.type != 'input')){
			Common.toast('验证码为6为数字');
		}
		formValidFn(false);
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
}
//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}
//表单提交
function validSubmitFn(){
	if(!formValidFn()){return false;}
	var phone = $('#phone').val(),
		code = $('#phone_code').val();
	var _url = '/ushop-api-merchant/api/weixin/user/login/bind/' + phone + '/' + code;
	Common.ajax(_url, 'post', {}, function(data){
    	if(data.userId){
    		
    		var oldData = [];
    		if(Common.storageL(Common.userId) != data.userId){//说明不是同一个账号
    			//执行购物车数据转移
    			OrderData.getOrderData(function(data){
    				if(data.length > 0){
    					oldData = data;
    				}
    			});
    		}
    		Common.storageL(Common.bindPhone, phone);
			Common.storageL(Common.userId, data.userId);
			Common.storageL(Common.token, data.token);
    		if(oldData.length > 0){
    			//执行购物车数据转移
    			OrderData.getOrderData(function(data){
    				OrderData.resetOrder(data.concat(oldData));
    			});
    		}
			$('#progress_box').find('progress_s2').addClass('active');
			history.go(-1);
    	}
	});
}

//表单验证函数
function formValidFn(isToast){
	var phone = $('#phone').val(),
		code = $('#phone_code').val(),
		re = true;
	if(!(Common.regExpPhone.test(phone))){
		if(isToast != false){
			Common.toast('手机号有误');
		}
		re = false;
	}
	if(!(Common.regExpCode.test(code))){
		if(isToast != false){
			Common.toast('验证码为6为数字');
		}
		re = false;
	}
	if(re){
		$('#phone_valid').find('.submit_btn').removeAttr('disabled');
		return true;
	}else{
		$('#phone_valid').find('.submit_btn').attr('disabled', 'disabled');
		return false;
	}
}

//发送验证码的按键点击事件
//验证功能类型
//发送短信的功能类型 在common文件中的userNote对象中 这里是注册账号
//me为当前点击的元素
function gainCodeFn(me){
	if(me.classList.contains('disabled')){return false;}
	var phone = document.getElementById('phone').value;
	if(!(Common.regExpPhone.test(phone))){
		Common.toast('手机号有误');
		return false;
	}
	me.classList.add('disabled');
	var _url = Common.domainUrl + '/ushop-api-merchant/api/sns/mobile/verify/sendCode/' + phone + '/' + userCodeNote.bindPhone;
	Common.ajax(_url, 'post', {}, function(data){
    	if(data.result == 1){//发送成功后计时，并且按键无法点击
    		countdownFn(me);
    		Common.toast('发送成功');
    	}else{
    		me.classList.remove('disabled');
    		Common.toast('发送失败');
    	}
	});
}

//倒计时按键
//me显示内容的元素对象DOM对象，必填
//timeNum 计时的时间num，可选默认为60
//className 计时期间添加的类名，str，可选默认为disabled
function countdownFn(me, timeNum, className){
	if(me.classList.contains(className)){return false;}
	var timeNum = timeNum ? parseInt(timeNum) : 60,
		className = className || 'disabled';
	me.innerHTML = timeNum + 's后可重发';
	me.classList.add(className);
	globalData.pwdInterval = setInterval(function(){
		timeNum--;
		if(timeNum <= 0){
			clearInterval(globalData.pwdInterval);
			me.classList.remove(className);
			me.innerHTML = '重新发送';
			return false;
		}
		me.innerHTML = timeNum + 's后可重发';
	},1000);
}
</script>
</body>
</html>
