<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>全部订单</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 3em;
	text-align: center;
	font-size: 1.2em;
	font-weight: 500;
	border-bottom: solid 1px #eee;
}
.xl-tab-title .xl-tab-hitem {
	float: left;
	width: 25%;
	color: #333;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}

/*抽奖我的中奖样式*/
.xlwp-ul1 .xlwp-li {
	position: relative;
	color: #bbb;
	line-height: 1.4;
	background: #fff;
	padding: .5em 6em;
	margin-bottom: 1px;
}
.xlwp-ul1 .xlwp-li .xlwp-p1 {
	color: #414141;
	font-size: 1.2em;
}
.xlwp-ul1 .xlwp-li .xlwp-li-img {
	position: absolute;
	left: .8em;
	top: 50%;
	margin-top: -2.5em;
	height: 5em;
	width: 5em;
}
.xlwp-ul1 .xlwp-li .xlwp-s1 {
	color: #ff5534;
}
.xlwp-ul1 .xlwp-li .xlwp-btn {
	position: absolute;
	right: .8em;
	top: 50%;
	margin-top: -2em;
	height: 4em;
	width: 4em;
	text-align: center;
	line-height: 4em;
}
.xlwp-ul1 .xlwp-li .xlwp-btn img {
	width: 100%;
	height: 100%;
}

/*抽奖全部订单样式*/
.xlwp-ul2 .xlwp-li {
	position: relative;
	color: #bbb;
	background: #fff;
	padding: .5em 7em .5em 5em;
	line-height: 1.6;
	margin-bottom: 1px;
}
.xlwp-ul2 .xlwp-li.xlpr-pr0 {
	padding-right: 2em;
}
.xlwp-ul2 .xlwp-li .xlwp-p1 {
	color: #414141;
	font-size: 1.1em;
}
.xlwp-ul2 .xlwp-li .xlwp-li-img {
	position: absolute;
	left: .8em;
	top: .5em;
	height: 3.6em;
	width: 3.6em;
}
.xlwp-ul2 .xlwp-li .xlwp-btn {
	position: absolute;
	right: .8em;
	top: 50%;
}
.xlwp-ul2 .xlwp-li .xlwp-btn .xl-btn {
	margin-top: -1em;
	vertical-align: top;
}
.xlwp-ul2 .xl-progressbar {
	margin: 0;
}
.xlwp-ul2 .xlpr-p1 {
	color: #ff4680;
	text-align: center;
	margin-top: -1.4em;
}
.xlwp-ul2 .xlpr-p2 {
	position: relative;
	padding: .5em .8em;
	background: #fcf2ee;
	border-radius: .5em;
	padding-left: 5em;
}
.xlwp-ul2 .xlpr-p2 > .xlwp-li-img {
	border-radius: 50%;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">全部订单</h1>
	</div>
</div>
<div class="xlele-box titleshowhide">
	<div class="xlele-content xl-tab-fixed">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" onclick="onTabTitleFn(this)">中奖订单</a>
			<a class="xl-tab-hitem" datahref="#tabContent2" onclick="onTabTitleFn(this)">全部订单</a>
			<a class="xl-tab-hitem" datahref="#tabContent3" onclick="onTabTitleFn(this)">进行中</a>
			<a class="xl-tab-hitem" datahref="#tabContent4" onclick="onTabTitleFn(this)">已揭晓</a>
		</div>
	</div>
</div>
<div class="titleshowhide" style="height: 3.6em;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent1">
			<ul class="xlwp-ul1 tabBody"></ul>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent2">
			<ul class="xlwp-ul2 tabBody"></ul>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent3">
			<ul class="xlwp-ul2 tabBody"></ul>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent4">
			<ul class="xlwp-ul2 tabBody"></ul>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	globalData.showItem = globalData.pageParam.showItem;
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var datahref = $('#tabTitleBox').find('.active').attr('datahref');
		getPageDataFn(datahref);
	});
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent1';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	onTabTitleFn($('[datahref="' + datahref + '"]')[0]);
}


//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me),
		datahref = $me.attr('datahref'),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	if($me.hasClass('active')){return false;}//本就是选中状态，不能再次点击
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	getPageDataFn(datahref);
}

//获取订单数据列表
function getPageDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('orderListTemplate'),
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来执行的模板
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	var _url;
	switch(datahref){
		case '#tabContent1'://我的中奖
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserLatestLottery/'+
				currentPage + '/10/' + Common.getUserId();
		typenum = 1;
		break;
		case '#tabContent2'://全部订单
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRecord/' +
				currentPage + '/10/0/' + Common.getUserId();
		typenum = 2;
		break;
		case '#tabContent3'://进行中
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRecord/' +
				currentPage + '/10/101/' + Common.getUserId();
		typenum = 2;
		break;
		case '#tabContent4'://已揭晓
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRecord/' +
				currentPage + '/10/102/' + Common.getUserId();
		typenum = 2;
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			if(typenum == 1){
				var str = '', btnStr = '', imgSrc = '';
				$.each(data.recordList, function(index, obj){
					switch(obj.status){
						//填写收货地址
						case 1: btnStr = '<a class="xlwp-btn" href="../address/address.html?comeFrom=wpSelectAddr&spellBuyId=' + obj.spellbuyProductId + '"><img src="../../image/icon/txshdz.png"/></a>';
						break;
						//提醒发货
						case 2: btnStr = '<a class="xlwp-btn" onclick="remindDeliveryFn()"><img src="../../image/icon/txfh.png"/></a>';
						break;
						//确认收货
						case 3: btnStr = 
							'<div class="xlwp-btn" style="height: 7em; margin-top: -3.5em;">' + 
								'<img style="height: 4em; width: 4em;" onclick="onBtnConfirmGet(\'' + obj.spellbuyProductId + '\')" src="../../image/icon/qrsh.png"/>'+
								(
									(obj.deliverNumber === 1)?
									('<a onclick="replaceProFn(\'' + obj.spellbuyProductId + '\')" style="display: block; line-height: 3em;">申请换货</a>'):
									''
								)+
							'</div>';
						break;
						//晒单，微信暂时无法晒单
//						case 4: btnStr = '<a class="xlwp-btn" onclick="unfinishedFn()"><img src="../../image/icon/sdfx.png"/></a>';
//						break;
//						case 5: btnStr = '<a class="xlwp-btn">已晒单</a>';
//						break;
						case 6: btnStr = '<a class="xlwp-btn">弃奖</a>';
						break;
						case 7: btnStr = 
							'<div class="xlwp-btn" style="height: 7em; margin-top: -3.5em;">' + 
								'<a style="line-height: 3em;">审核中</a>'+
								'<a onclick="cancelReplaceFn(\'' + obj.spellbuyProductId + '\')" style="display: block; line-height: 3em;">取消换货</a>'+
							'</div>';
						break;
						case 8: btnStr = '<a class="xlwp-btn">换货中</a>';
						break;
						default: btnStr = '<a class="xlwp-btn">已完成</a>';
					}
					imgSrc = obj.productImage ? Common.getImageUrl(obj.productImage) : '../../image/p200200.png';
					str +=  '<li class="xlwp-li" spellBuyId="' + obj.spellbuyProductId + '">'+
								'<img class="xlwp-li-img" src="' + imgSrc + '"/>'+
								'<div class="xlwp-p1 ellipsis">' + obj.productName + '</div>'+
								'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
								'<div class="ellipsis">总需：' + obj.buyNumberCount + '</div>'+
								'<div class="ellipsis">幸运号码：<span class="xlwp-s1">' + obj.randomNumber + '</span></div>'+
								'<div class="ellipsis">本期参与：<span class="xlwp-s1">' + obj.buyNumberCount + '</span>人次</div>'+
								'<div class="ellipsis">揭晓时间：' + ((obj.announcedTime + '').substr(0, 10)) + '</div>'+
								btnStr+
							'</li>';
				});
				if(currentPage == 1){//说明是这个项目容器第一页
					listContent.html(str);
				}else{
					listContent.html(listContent.html() + str);
				}
			}else if(typenum == 2){
				var str = '', rate, productImage = '../../image/p200200.png', headImage = '../../image/icon/minePortrait.png';
				$.each(data.recordList, function(index, obj){
					if(obj.object.headImage){
						productImage = Common.getImageUrl(obj.object.headImage);
					}
					if(obj.spellbuyStatus == 100){
						rate = parseInt(100*obj.spellbuyCount/obj.spellbuyPrice);
						str +=
								'<li class="xlwp-li">'+
									'<img class="xlwp-li-img" src="' + productImage + '"/>'+
									'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
									'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
									'<div class="ellipsis">进度：' + rate + '%</div>'+
					            	'<div class="xl-progressbar">'+
						        		'<span style="width: ' + rate + '%;"></span>'+
					    	    	'</div>'+
									'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
									'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
									'<div class="xlwp-btn"><a href="../indiana/product_details.html?fromTo=btn&spellbuyId=' + obj.spellbuyProductId + '" class="xl-btn">追加</a></div>'+
								'</li>';
					}else if(obj.spellbuyStatus == 101){
						str +=
								'<li class="xlwp-li">'+
									'<img class="xlwp-li-img" src="' + productImage + '"/>'+
									'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
									'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
									'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
									'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
									'<div class="xlwp-btn">'+
										'<div class="xlpr-p1">即将开奖'+
						                	'<div class="xl-countdown-box xlplCountdown clearfix" timeNum="' + obj.announceEndDate + '">'+
						                		'<span>00</span>'+
						                		'<span>00</span>'+
						                		'<span>00</span>'+
						                	'</div>'+
										'</div>'+
									'</div>'+
								'</li>';
					}else if(obj.spellbuyStatus == 102){
						if(obj.ownerImage){
							headImage = Common.getImageUrl(obj.ownerImage);
						}
						str +=
								'<li class="xlwp-li xlpr-pr0">'+
									'<img class="xlwp-li-img" src="' + productImage + '"/>'+
									'<div class="xlwp-p1 ellipsis">' + obj.object.productTitle + '</div>'+
									'<div class="ellipsis">期号：' + obj.productPeriod + '</div>'+
									'<div class="ellipsis">本期参与：<span class="color-ff5534">' + obj.spellbuyCount + '</span>人次</div>'+
									'<div class="color-ff5534" onclick="showNumberFn(\'' + obj.spellbuyProductId + '\')">查看彩购号码</div>'+
									'<div class="xlpr-p2">'+
										'<img class="xlwp-li-img" src="' + headImage + '">'+
										'<div class="xlwp-p1 ellipsis">获奖者：' + obj.ownerName + '</div>'+
										'<div class="ellipsis">幸运号码：' + obj.luckyNumber + '</div>'+
										'<div class="ellipsis">本期参与：' + obj.ownerCount + '</div>'+
										'<div class="ellipsis">揭晓时间：' + obj.announcedTime + '</div>'+
									'</div>'+
								'</li>';
					}
				});
				if(currentPage == 1){//说明是这个项目容器第一页
					listContent.html(str);
				}else{
					listContent.html(listContent.html() + str);
				}
				countdownFn();//倒计时
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	}, false);
}

//倒计时函数
function countdownFn(){
	var box = $('.xlplCountdown'),
//		timestamp = (new Date()).getTime(),//现在的时间
		timeInter = globalData.interCountdown || [],//记录倒计时的ID
		interTime = 100;//倒计时跳动间隔时间单位：ms
	Common.getServiceTT(function(timestamp){
		$.each(timeInter, function(index, val){
			clearInterval(val);
		});
		timeInter = [];
		box.each(function(index, me){
			var $me = $(me),
				timeNum = $me.attr('timeNum'),
				timeEle = $me.find('span'),
				timeDif = (new Date(timeNum.replace(/-/g, '/'))).getTime() - timestamp;//时间间隔的毫秒数
			if(timeEle.length != 3){
				return false;
			}
			timeInter[timeInter.length] = setInterval(function(){
				if(timeDif > interTime){
				    var i = parseInt((timeDif%3600000)/(60000)),
				    	s = parseInt((timeDif%60000)/1000),
				    	m = parseInt((timeDif%1000)/interTime);
				    i = i < 10 ? ('0' + i) : i;
				    s = s < 10 ? ('0' + s) : s;
				    m = m < 10 ? ('0' + m) : m;
					timeEle[0].innerHTML = i;
					timeEle[1].innerHTML = s;
					timeEle[2].innerHTML = m;
					timeDif = timeDif - interTime;
				}else if(timeDif < -interTime){
					clearInterval(timeInter[index]);
					$me.parents('li').remove();
				}else if(timeDif <= interTime){
					timeEle[0].innerHTML = '00';
					timeEle[1].innerHTML = '00';
					timeEle[2].innerHTML = '00';
					timeDif = timeDif - interTime;
				}else{
					clearInterval(timeInter[index]);
				}
			}, interTime);
		});
		globalData.interCountdown = timeInter;
	});
}


//查看彩购号码
function showNumberFn(spellbuyId) {
	var _url = Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRandomNumber/' + Common.getUserId() + '/' + spellbuyId;
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList){
			var str = '';
			$.each(data.recordList, function(index, name){
				str += '<span>' + name + '</span> ';
			});
			str =   '<div class="xl-purchase-num">'+
					str+
					'</div>';
			Common.confirm('提示', str, null, '确定');
		}
	});
}


//确认收货执行函数
function onBtnConfirmGet(spellbuyId){
	var _url = '/ushop-api-merchant/api/spellbuy/person/express/confirm/' + spellbuyId;
	Common.ajax(_url, 'post', {}, function(data){
		if(data.status == 4){
			Common.toast('操作成功！');
			location.reload();
		}else if(data.error_description){
			Common.toast(data.error_description)
		}else{
			Common.toast('操作失败！');
		}
	});
}

//换货
function replaceProFn(spellbuyId){
	var str = 
		'<div>请输入换货原因：</div>'+
		'<input id="why_replace_ipt" style="display: block; width: 100%; margin-top: 10px; line-height: 1; padding: 6px;" type="text">'
	Common.confirm('提示', str, function(index){
		if(index === 1){
			var _param = {
				spellbuyProductId: spellbuyId,
				reason: document.getElementById('why_replace_ipt').value
			}
			if(!_param.reason){
				Common.toast('请输入换货原因！');
				return false;
			}
			if(!(/^.{1,50}$/.test(_param.reason))){
				Common.toast('换货原因为1-50个字!');
				return false;
			}
			var _url = '/ushop-api-merchant/api/spellbuy/person/replacement/create';
			Common.ajax(_url, 'post', JSON.stringify(_param), function(data){
				if(data.lotteryReplacement){
					Common.toast('申请成功！');
					location.reload();
				}else{
					Common.toast(data.error_description || '操作失败！');
				}
			});
		}
	});
}

//取消换货
function cancelReplaceFn(spellbuyId){
	var _url = '/ushop-api-merchant/api/spellbuy/person/replacement/cancel/' + spellbuyId;
	Common.ajax(_url, 'post', {}, function(data){
		if(data.date == 'SUCCESS'){
			Common.toast('取消成功！');
			location.reload();
		}else if(data.date == 'STATUSISWRONG'){
			Common.toast('换货已受理，无法取消！');
		}else{
			Common.toast(data.error_description || '操作失败！');
		}
	});
}

//去到晒单分享
function goSharePageFn(data){
	Common.storageL('ls_partly_share_order', JSON.parse(decodeURIComponent(data)));
	Common.openPage('../weixinmp/share_form.html?shareType=indiana');
}
</script>
</body>
</html>
