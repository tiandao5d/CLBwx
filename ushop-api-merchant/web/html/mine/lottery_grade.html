<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>彩票成就</title>
<link rel="stylesheet" type="text/css" href="../../css/animate.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xl-li .xl-li-img {
	width: 33px;
	height: 44px;
	margin-top: -22px;
}
.xl-li .xl-li-img img {
	width: 100%;
	height: 100%;
}
.xl-lii .xl-li-txt {
	padding-left: 40px;
}
.xllg-s1 {
	position: absolute;
	left: 0;
	top: 8px;
	width: 100%;
	text-align: center;
	color: #fff;
}
.xllg-status {
	position: absolute;
	right: 15px;
	top: 50%;
	height: 0;
}
.xllg-status .xllg-s2 {
	position: relative;
	top: -24px;
	width: 48px;
	height: 48px;
}
.xllg-status .xl-btn {
	position: relative;
	top: -15px;
	height: 30px;
	min-width: 60px;
	padding: 0 5px;
	text-align: center;
	line-height: 30px;
}
.xllg-s3 {
	background: #ff5534;
}
.xllg-s4 {
	background: #ff8500;
}

/*领取奖励成功弹窗*/
.congratulate-con .congratulate-txt {
	position: absolute;
	left: 0;
	top: 57%;
	bottom: 33%;
	width: 100%;
	color: #fff;
	display: flex;
	font-weight: bold;
	font-size: 24px;
	align-items: center;
	justify-content: center;
}
@media screen and (min-width: 350px) {
	.signin-con .signin-txt {
		font-size: 30px;
	}
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">彩票成就</h1>
	</div>
</div>
<div class="xlbody-box">
	<div id="grade_box">
		<div class="tabBody"></div>
		<div class="xl-refresh-prompt refreshPrompt"></div>
	</div>
</div>
<div class="congratulate-toast xlele-box" id="congratulate_toast" onclick="congratulateToastSH('hide')">
	<div class="congratulate-bg"></div>
	<div class="xlele-content">
		<div class="congratulate-con">
			<div class="congratulate-txt">+10</div>
			<img class="congratulate-img" src="../../image/icon/xllg_003.png"/>
		</div>
	</div>
</div>
<script id="grade_box_tmp"  type="text/template">
	{{~ it:data}}
		<div class="xl-li xl-lii">
			<a>
				<div class="xl-li-img">
					<img src="../../image/icon/xllg_001.png">
					<div class="xllg-s1">{{=data.conditionValue}}</div>
				</div>
				<div class="xl-li-txt">
					<div>累计扫票达到{{=data.conditionValue}}次（{{=(data.object.taskValue + '/' + data.conditionValue)}}）</div>
					<div>奖励：{{=data.rvl.txt}}</div>
				</div>
				<div class="xllg-status">
					<!--已完成-->
					{{?(data.object.status === 100)}}
					<img class="xllg-s2" src="../../image/icon/xllg_002.png">
					<!--完成未领奖-->
					{{??(data.object.status === 102)}}
					<button class="xl-btn xllg-s3" onclick="awardFn('{{=data.id}}', this)">领取</button>
					<!--未完成-->
					{{??}}
					<button onclick="Common.openPage('../weixinmp/home.html?scanQRCode=yes')" class="xl-btn xllg-s4">前往扫票</button>
					{{?}}
				</div>
			</a>
		</div>
	{{~}}
</script>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/doT.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
}
//dom事件绑定
function domEventFn(){
}

//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getGradeList();//获取任务数据
}

//获取任务数据
function getGradeList(){
	var listItem = $('#grade_box'),//列表项目
		listContent = listItem.find('.tabBody'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		template = document.getElementById('grade_box_tmp');//用来确定请求的地址
	var _url = '/ushop-api-merchant/api/sns/achievement/list/' + '10';
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList){//表示数据请求成功
			if(data.recordList.length === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('');
				Common.blankPageFn(listContent);//显示空白界面
				return false;
			}
			Common.blankPageFn(listContent, 'hide');//隐藏空白界面
			
			$.each(data.recordList, function(index, obj){
				if(!obj['object']){
					obj['object'] = {
						taskValue: 0,
						status: 101
					}
				}
				try{
					obj.rewardValue = JSON.parse(obj.rewardValue);
					obj.rvl = obj.rewardValue[0] || {awardType: '1', awardValue: '00'};
				}catch(err){}
				switch(obj.rvl.awardType){
					case '1': obj.rvl.txt = obj.rvl.awardValue + '积分';
					break;
					case '2': obj.rvl.txt = obj.rvl.awardValue + '彩钻';
					break;
					case '3': obj.rvl.txt = obj.rvl.awardValue + '游戏券';
					break;
				}
			});
			
			var dataListTemplate = doT.template(template.innerHTML);
			listContent[0].innerHTML = dataListTemplate(data.recordList);
		}else{
			refreshPrompt.html(data.error_description || '未知错误');
		}
	});
}

//领取奖励
function awardFn(id, me){
	var _url = '/ushop-api-merchant/api/sns/achievement/reward/take/' + id;
	Common.ajax(_url, 'get', {}, function(data){
		if(data.taskId){
			Common.toast('领取成功！');
			$(me).parent().html('<img class="xllg-s2" src="../../image/icon/xllg_002.png">')
		}
	});
}

//奖励弹窗提示
function congratulateToastSH(type, num){
	var $box = $('#congratulate_toast'),
		$p = $box.find('.congratulate-txt');
	if(type === 'show'){
		$p.text(('+' + num)).data('num', num);
		$box.addClass('active').find('.xlele-content')
		.removeClass('bounceIn animated')
	    .addClass('bounceIn animated').one('webkitAnimationEnd animationend', function(){
	    	$(this).removeClass('bounceIn animated');
	    });
	}else if(type === 'hide'){
		$box.find('.xlele-content').removeClass('bounceOut animated')
	    .addClass('bounceOut animated').one('webkitAnimationEnd animationend', function(){
	    	$(this).removeClass('bounceOut animated');
	    	$box.removeClass('active');
	    	if(globalData.intNumAni){
	    		globalData.intNumAni.update((globalData.intNumAni.endVal + $p.data('num')));
	    	}else{
		    	var $n = $('#integralEle'),
		    		n = parseInt($n.text().replace(/\D/g, ''));
		    	$n.text(n + $p.data('num'));
	    	}
	    });
	}
}
</script>
</body>
</html>
