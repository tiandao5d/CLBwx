<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>积分商城</title>
<link rel="stylesheet" type="text/css" href="../../css/owl.carousel.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	white-space:nowrap;
	overflow-x: auto;
	height: 36px;
	line-height: 35px;
	padding-right: 44px;
	border-bottom: solid 1px #eee;
}
.xl-tab-hitem {
	position: relative;
	display: inline-block;
	padding: 0 10px;
	color: #696969;
	background: #fff;
	z-index: 11;
}
.xl-tab-hitem.active {
	color: #ff6f00;
}
.xl-tab-hitem.active:before,
.xl-tab-class:before {
	content: '';
	position: absolute;
	left: 10px;
	right: 10px;
	bottom: 0;
	height: 2px;
	background: #ff6f00;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}
.xl-tab-more {
	position: absolute;
	right: 0;
	top: 0;
	width: 44px;
	padding-left: 12px;
	text-align: center;
	height: 35px;
	line-height: 35px;
	background: #fff url(../../image/icon/shopping_ds001.png);
	background-size: 100% 100%;
	z-index: 12;
}
.xl-tab-more .icon {
	color: #8d8d8d;
	font-size: 14px;
	font-weight: bold;
}
.xl-tab-more .icon:before {
	-webkit-transform: rotate(90deg);
	transform: rotate(90deg);
	-webkit-transition: all .3s;
	transition: all .3s;
}
.xl-tab-more.active .icon:before {
	-webkit-transform: rotate(-90deg);
	transform: rotate(-90deg);
}
.xl-tab-class {
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	background: #fff;
	-webkit-transition: all .3s;
	transition: all .3s;
	-webkit-transform: translateY(-100%);
	transform: translateY(-100%);
}
.xl-tab-class:before {
	background: #fff;
	z-index: 13;
	left: 0;
	right: 0;
	height: 1;
}
.xl-tab-class.active {
	-webkit-transform: translateY(36px);
	transform: translateY(36px);
}
.xl-tab-class .xl-tab-hitem {
	width: 33.33333%;
	text-align: center;
	line-height: 3.25em;
	border-bottom: solid 1px #e5e5e5;
	z-index: 1;
}
.xl-tab-class .xl-tab-hitem.active:before {
	left: 0;
	right: 0;
}

/*首页产品列表*/
.xl-product-list {
	list-style: none;
	margin: 0;
	padding: 0;
}
.xl-product-cell {
	position: relative;
	float: left;
	width: 50%;
	height: 170px;
	padding: 8px 8px 6px;
	border-top: solid 2px #eee;
	background: #fff;
}
.xl-product-cell:before {
	content: '';
	position: absolute;
	left: -1px;
	top: 0;
	width: 2px;
	height: 100%;
	background: #eee;
}
@media (min-width: 500px){
	.xl-product-cell {
		width: 33.33333%;
	}
	.xl-product-cell:nth-child(3n+1):before {
		width: 0;
	}
}
@media (max-width: 500px){
	.xl-product-cell:nth-child(2n+1):before {
		width: 0;
	}
}
.xl-product-pic img {
	display: block;
	width: 100%;
}
.xl-product-pic {
	position: relative;
	width: 86px;
	height: 86px;
	margin: 0 auto;
}
.xl-data-img {
	position: absolute;
	left: 0;
	top: 0;
}
.xl-product-purchase {
	color: #ff412d;
	padding: 15px 31px 0 0;
	font-weight: bold;
	font-size: 15px;
}
.xl-product-p1 {
	color: #4e4e4e;
	line-height: 1;
	height: 24px;
	margin: 8px 0 0;
	text-align: justify;
}
.xl-product-addbtn {
	position: absolute;
	bottom: 0;
	right: 0;
	width: 51px;
	height: 39px;
	padding: 6px 12px;
}
.xl-product-addbtn.disabled,
.xl-product-addbtn:disabled {
    -webkit-filter: grayscale(100%);
    filter: grayscale(100%);
	opacity: .2 !important;
}
.xl-product-addbtn img {
	width: 100%;
	height: 100%;
}

</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">商城彩购</h1>
	</div>
</div>
<div class="xlele-box xl-tab-fixed">
	<div class="xlele-content">
		<div class="xl-tab-title" id="tab_head_box"></div>
		<div class="xl-tab-more" id="tab_more_btn"><i class="icon icon-right"></i></div>
		<div class="xl-tab-class" id="tab_class_box"></div>
	</div>
</div>
<div style="height: 3em;"></div>
<div class="xlbody-box">
	<div class="xlbanner-box">
		<img class="xlbanner-pla-img" src="../../image/p300100.png">
		<div id="bannerBox"></div>
	</div>
	<div style="height: 2px;"></div>
	<div class="xl-tab-content" id="tab_content_box"></div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/owl.carousel.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/order_data_ds.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.gameIdArr = [//用于判断扫描到的彩票属于哪一种，从而进入相应的详情页面
    {gameId: '2', val: 'ssq'},
    {gameId: '4', val: '3d'}
]
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	//初始化定位数据
	$('#user_province').html(Common.localProL().name)
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var typenum = globalData.activeCode.replace('#tab_citem', ''),
			sort = '';
		getProductListFn(typenum, sort);
	});
	$('#tab_more_btn').on('click', function(){
		var $me = $(this),
			box = $('#tab_class_box');
		if($me.hasClass('active')){
			$me.removeClass('active');
			box.removeClass('active');
		}else{
			$me.addClass('active');
			box.addClass('active');
		}
	});
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	getProductClassFn();//获取产品分类
	//刷新数据请求函数
	bannerShowFn();//banner图显示
}
//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//获取产品分类
function getProductClassFn(){
	var _url = Common.domainUrl + '/ushop-api-merchant/api/product/listProductType',
		plPageData = {};//记录产品列表 的翻页数据
	Common.ajax(_url, 'get', {}, function(data){
		if(data.productType && data.productType.length > 0){
			var hstr = '', cstr = '', clstr, imgSrc,
				code = '#tab_citem' + data.productType[0].id;
			$.each(data.productType, function(index, obj){
				plPageData['currentPage' + obj.id] = 0;//当前页
				plPageData['pagePage' + obj.id] = 1;//总页数
				imgSrc = obj.pictureAddress ? Common.getImageUrl(obj.pictureAddress) : '../../image/mine/mine001.png';
				hstr +=
					'<a class="xl-tab-hitem tab_hitem" _href="#tab_citem' + obj.id + '" onclick="tabCutFn(\'#tab_citem' + obj.id + '\')">' + obj.typeName + '</a>';
				cstr +=
					'<div class="xl-tab-citem tab_citem" id="tab_citem' + obj.id + '">'+
						'<ul class="tab_body clearfix xl-product-list"></ul>'+
						'<div class="xl-refresh-prompt refresh_prompt"></div>'+
					'</div>';
				clstr +=
					'<a class="xl-tab-hitem tab_hitem" _href="#tab_citem' + obj.id + '" onclick="tabCutFn(\'#tab_citem' + obj.id + '\')">' + obj.typeName + '</a>';
			});
			globalData.plPageData = plPageData;//记录产品列表 的翻页数据
			$('#tab_head_box').html(hstr);
			$('#tab_content_box').html(cstr);
			$('#tab_class_box').html(hstr);
			tabCutFn(code);
		}
	});
}

//tab切换
function tabCutFn(code){
	var typenum = code.replace('#tab_citem', ''),//获取查询类型ID
		sort = '',
		oldTime = $(code).data('oldTime') || 0,
		newTime = +new Date();
	globalData.activeCode = code;
	$('.tab_citem, .tab_hitem').removeClass('active');
	$(code + ', [_href="' + code + '"]').addClass('active');
	if(newTime - oldTime > 300000){//上次请求的时间大于指定毫秒数则可以重新请求
		globalData.plPageData['currentPage' + typenum] = 0;//当前页
		globalData.plPageData['pagePage' + typenum] = 1;//总页数
		getProductListFn(typenum, sort);//获取商品列表
	}
}

//获取商品列表
function getProductListFn(typenum, sort){
	var listItem = $('#tab_citem' + typenum + sort),//列表项目
		listContent = listItem.find('.tab_body'),//列表容器
		refreshPrompt = listItem.find('.refresh_prompt'),//加载中提示容器
		suffixStr = typenum + '' + sort,
		pagingData = globalData.plPageData,//记录分页数据
		currentPage = pagingData['currentPage' + suffixStr],
		pagePage = pagingData['pagePage' + suffixStr];
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	var _url =  Common.domainUrl + '/ushop-api-merchant/api/mall/product/search/listByType/'+
				typenum + '/' + currentPage;
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (+new Date()));//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			pagingData['currentPage' + suffixStr] = currentPage;
			pagingData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('没有数据');
				return false;
			}
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			var str = '', rate, headImage = '', dis = '', ruleObj;
			$.each(data.recordList, function(index, obj){
				ruleObj = OrderData.formatRule(obj.rule);
				obj.ruleArr = ruleObj.ruleArr;
				obj.checkedRule = ruleObj.checkedRule;
				rate = parseInt(100*obj.spellbuyCount/obj.spellbuyPrice);
				headImage = obj.headImage ? '<img class="xl-data-img" src="' + Common.getImageUrl(obj.headImage) + '">' : '';
				if(obj.stock > 0){
					dis = '';
				}else {
					dis = 'disabled';
				};
				str +=
					'<li class="xl-product-cell">'+
				        '<div class="xl-product-body">'+
			                '<a class="xl-product-img" href="../indiana/product_details_ds.html?productId=' + obj.id + '">'+
			                	'<div class="xl-product-pic">'+
				                	'<img src="../../image/p200200.png">'+
				                	headImage+
			                	'</div>'+
			                	'<div class="xl-product-p1 ellipsis2">' + obj.productName + '</div>'+
			                '</a>'+
				            '<div class="xl-product-purchase ellipsis">'+
				            obj.checkedRule.payTypeText+
				            '</div>'+
//				            '<a class="xl-product-addbtn ' + dis + '" onclick="addShoppingFn(\'' + obj.id + '\', this, event)"><img src="../../image/icon/order_001.png"></a>'+
				        '</div>'+
			        '</li>';
			});
			globalData.plPageData = pagingData;//记录分页数据
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
		}else{
			refreshPrompt.html('加载失败！');
		}
	}, false);
}

//banner图显示
function bannerShowFn(pId){
	pId = pId || Common.localProL().id || '00';
	var _url =  Common.domainUrl + '/ushop-api-merchant/api/sns/notify/banner/list/6/' + pId + '.json';
	Common.ajax(_url, 'get', {}, function(data){
		if(data.recordList && data.recordList.length > 0){
			var str = '',
				img = new Image(),
				bannerBox = $("#bannerBox"),
				hr = 'javascript:;', activityId,
				loop = false;
			img.src = Common.getImageUrl(data.recordList[0].pictureAddress);
			$.each(data.recordList, function(index, obj){
				activityId = obj.relationWebId;
				$.each(globalActivity, function(i, o){
					if(activityId == o.id){
						hr = o.url;
						return false;
					}
				});
				str += '<div class="item"><a onclick="bannerClickFn(\'' + obj.relationWebId + '\', \'' + obj.relationType + '\')"><img src="' + Common.getImageUrl(obj.pictureAddress) + '"></a></div>';
			});
			str = '<div class="owl-carousel owl-theme xlbanner-body">' + str + '</div>';
			if(data.recordList.length > 1){
				loop = true;
			}
			img.onload = function(){
				bannerBox.html(str);
				bannerBox.find('.owl-carousel').owlCarousel({
					autoplay: true,
					autoplayTimeout: 5000,
					items: 1,
					loop: loop
				});
			}
		}
	});
}



//banner图点击事件
function bannerClickFn(relationWebId, relationType){
	if(!(relationWebId && relationType)){
		Common.toast('关联配置错误！');
		return false;
	}
	if(relationType == '1'){//为活动配置
		var relArr = (relationWebId + '').split('|');
		var pageUrl = '', pageName;
		Common.each(globalActivity, function(index, obj){
			if(relArr[0] == obj.id){
				pageUrl = obj.url;
				pageName = obj.pageName;
				return false;
			}
		});
		if(pageUrl){
			Common.openPage(pageUrl, {activeId: (relArr[1] || ''), fundType: (relArr[2] || '')});
		}else{
			Common.toast('关联配置错误！');
		}
	}else if(relationType == '2'){//为游戏配置
		
	}else if(relationType == '3'){//为商品配置
		var relArr = (relationWebId + '').split('|');
		if(relArr[0] && relArr[1]){
			if(relArr[0] == '1'){//表示拼购的ID
				Common.openPage('../indiana/product_details.html?productId=' + relArr[1]);
				return false;
			}else if(relArr[0] == '2'){//表示电商的ID
				Common.openPage('../indiana/product_details_ds.html?productId=' + relArr[1]);
				return false;
			}
		}
		Common.toast('关联配置错误！');
	}else if(relationType == '4'){//为H5页面配置

	}
}

//添加购物车
function addShoppingFn(productId, me, e){
	if(!productId || me.classList.contains('disabled')){return false;};
	OrderData.addOrder(productId, 1, function(status, curList,　curData){
		if(status === 'success'){
			Common.toast('添加成功！');
		}else{
			me.classList.add('disabled');
			Common.toast('添加失败！');
		}
	});
}

</script>
</body>
</html>
