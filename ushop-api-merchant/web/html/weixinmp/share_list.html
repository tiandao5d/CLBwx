<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>晒单</title>
<link rel="stylesheet" type="text/css" href="../../css/photoswipe.css"/>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
/*悬浮抬头样式*/
.xl-tab-fixed {
	top: 0;
}
.xl-tab-title {
	line-height: 3em;
	text-align: center;
	font-size: 1.2em;
	font-weight: 500;
	border-bottom: solid 1px #eee;
}
.xl-tab-title .xl-tab-hitem {
	float: left;
	width: 50%;
	color: #333;
}
.xl-tab-title .xl-tab-hitem.active {
	color: #ff5534;
}
.xl-tab-citem {
	display: none;
}
.xl-tab-citem.active {
	display: block;
}

/*列表样式*/
.xlsh-li {
	position: relative;
	background: #fff;
	padding: .5em .8em;
	margin-bottom: 1px;
}
.xlsh-li .xlsh-p1 {
	line-height: 2.2em;
	color: #666;
}
.xlsh-li .xlsh-p1 img,
.xlsh-li .xlsh-p1 span {
	float: left;
}
.xlsh-li .xlsh-p1 img {
	width: 2.2em;
	height: 2.2em;
	margin-right: .5em;
}
.xlsh-li .xlsh-p2 {
	color: #888;
	text-align: justify;
}
.xlsh-li .xlsh-p3 {
	padding: .3em 0;
}
.xlsh-li .xlsh-p3 img {
	float: left;
	width: 4em;
	height: 4em;
	margin-left: 1em;
}
.xlsh-li .xlsh-p3 img:first-child {
	margin-left: 0;
}
.xlsh-li .xlsh-p5 {
	text-align: right;
}
.xlsh-li .xlsh-p5 a {
	position: relative;
	color: #169ada;
	padding-right: 1em;
}
.xlsh-li .xlsh-p5 a:before {
    content: "\e775";
	position: absolute;
    font-family: 'iconfont';
	top: 50%;
	right: 0;
	line-height: 1;
	margin-top: -.5em;
}
</style>
</head>
<body>
<div class="xlnav-box xlele-box">
	<div class="xlnav-content xlele-content">
		<img src="../../image/icon/titleBG.jpg">
		<h1 class="xlnav-title">晒单</h1>
	</div>
</div>
<div class="xlele-box titleshowhide">
	<div class="xlele-content xl-tab-fixed">
		<div class="xl-tab-title clearfix" id="tabTitleBox">
			<a class="xl-tab-hitem" datahref="#tabContent1" onclick="onTabTitleFn(this)">抽奖晒单</a>
			<a class="xl-tab-hitem" datahref="#tabContent2" onclick="onTabTitleFn(this)">抽奖晒单</a>
			<a class="xl-tab-hitem" datahref="#tabContent3" onclick="onTabTitleFn(this)">抽奖晒单</a>
			<a class="xl-tab-hitem" datahref="#tabContent4" onclick="onTabTitleFn(this)">商城晒单</a>
			<a class="xl-tab-hitem" datahref="#tabContent5" onclick="onTabTitleFn(this)">商城晒单</a>
			<a class="xl-tab-hitem" datahref="#tabContent6" onclick="onTabTitleFn(this)">商城晒单</a>
		</div>
	</div>
</div>
<div class="titleshowhide" style="height: 3.6em;"></div>
<div class="xlbody-box">
	<div class="xl-tab-content" id="tabContentBox">
		<div class="xl-tab-citem" id="tabContent1">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent2">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent3">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent4">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent5">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
		<div class="xl-tab-citem" id="tabContent6">
			<div class="xlsh-ul"></div>
			<div class="xl-refresh-prompt refreshPrompt"></div>
		</div>
	</div>
</div>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="pswp__bg"></div>
	<div class="pswp__scroll-wrap">
		<div class="pswp__container">
			<div class="pswp__item"></div>
			<div class="pswp__item"></div>
			<div class="pswp__item"></div>
		</div>
		<div class="pswp__ui pswp__ui--hidden">
			<div class="pswp__top-bar">
				<div class="pswp__counter"></div>
				<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
				<button class="pswp__button pswp__button--share" title="Share"></button>
				<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
				<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
				<div class="pswp__preloader">
					<div class="pswp__preloader__icn">
						<div class="pswp__preloader__cut">
							<div class="pswp__preloader__donut"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
				<div class="pswp__share-tooltip"></div>
			</div>
			<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
			<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
			<div class="pswp__caption">
				<div class="pswp__caption__center"></div>
			</div>
		</div>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/photoswipe.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
globalData.isProgress = false;
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});

//页面启动时，数据初始化
function pageDataInit(){
	globalData.showItem = globalData.pageParam.showItem;
	globalData.productId = globalData.pageParam.productId;
}
//dom事件绑定
function domEventFn(){
	//到底部加载
	Common.scrollBottom(function(){
		var datahref = $('#tabTitleBox').find('.active').attr('datahref');
		shareListDataFn(datahref);
	});
}


//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//数据初始化
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		suffixStr = '';//后缀字符串
	hitem.each(function(index, item){
		suffixStr = $(item).attr('datahref').substr(1);
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	});
	
	//界面显示
	var datahref = '#tabContent6';
	if(globalData.showItem){
		datahref = '#' + globalData.showItem;
	}
	onTabTitleFn($('[datahref="' + datahref + '"]')[0]);
}

//刷新之后执行函数
function refreshAfterFn(){
	if(globalData.refreshComplete >= globalData.requestNum){
		globalData.refreshComplete = 0;//用来记录请求完成次数
		globalData.requestNum = 0;//用来记录有多少次用户请求
		if(globalData.isRefresh == true){
			globalData.isRefresh = false;
			Common.toast('刷新成功');
		}
	}
}


//tab抬头点击事件切换项目
function onTabTitleFn(me){
	var hitem = $('#tabTitleBox').find('.xl-tab-hitem'),
		citem = $('#tabContentBox').find('.xl-tab-citem'),
		$me = $(me),
		datahref = $me.attr('datahref'),
		suffixStr = datahref.substr(1),
		$item = $(datahref),
		nowTime = (new Date()).getTime(),//当前的时间
		oldTime = $item.data('oldTime');//上一次请求的时间
	if($me.hasClass('active')){return false;}//本就是选中状态，不能再次点击
	hitem.removeClass('active');
	citem.removeClass('active');
	$me.addClass('active');
	$item.addClass('active');
	
	$('.titleshowhide').hide();
	if((datahref == '#tabContent2') || (datahref == '#tabContent5')){
		$('.titleshowhide').show();
		$('[datahref]').hide();
		$('[datahref="#tabContent2"]').show();
		$('[datahref="#tabContent5"]').show();
	}
	if(oldTime && (nowTime - oldTime < 300000)){//时间间隔超过5分钟才允许重新请求
		return false;
	}else{
		globalData['currentPage' + suffixStr] = 0;//当前页
		globalData['pagePage' + suffixStr] = 1;//总页数
	}
	shareListDataFn(datahref);
}


//获取订单数据列表
function shareListDataFn(datahref){
	var suffixStr = datahref.substr(1),
		listItem = $(datahref),//列表项目
		listContent = listItem.find('.xlsh-ul'),//列表容器
		refreshPrompt = listItem.find('.refreshPrompt'),//加载中提示容器
		currentPage = globalData['currentPage' + suffixStr],
		pagePage = globalData['pagePage' + suffixStr],
		typenum;//用来确定是电商还是拼购
	if(refreshPrompt.find('.isLoadingTrue').length > 0){//说明正在加载中……
		return false;
	}
	currentPage++;
	if(currentPage > pagePage){//说明已经是最后一页了
		return false;
	}
	var _url;
	switch(datahref){
		case '#tabContent1': //拼购的所有晒单数据
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/share/public/listShare/'+
				currentPage + '/10';
		typenum = 1;
		break;
		case '#tabContent2': //指定用户的所有拼购晒单数据
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/share/public/listUserShare/'+
				currentPage + '/10/' + Common.getUserId();
		typenum = 1;
		break;
		case '#tabContent3': //指定拼购商品的所有晒单数据
		_url =  Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/share/public/listShareByProductId/'+
				globalData.productId + '/' + currentPage + '/10';
		typenum = 1;
		break;
		case '#tabContent4': //商城的所有晒单数
		_url =  Common.domainUrl + '/ushop-api-merchant/api/mall/person/share/public/listShare/'+
				currentPage + '/10';
		typenum = 2;
		break;
		case '#tabContent5': //指定用户的所有商城晒单数据
		_url =  Common.domainUrl + '/ushop-api-merchant/api/mall/person/share/public/listUserShare/'+
				currentPage + '/10/' + Common.getUserId();
		typenum = 2;
		break;
		case '#tabContent6': //指定商城商品的所有晒单数据
		_url =  Common.domainUrl + '/ushop-api-merchant/api/mall/person/share/public/listShareByProductId/'+
				globalData.productId + '/' + currentPage + '/10';
		typenum = 2;
		break;
	}
	refreshPrompt.html(Common.listLoadingHTML());
	Common.ajax(_url, 'get', {}, function(data){
		listItem.data('oldTime', (new Date()).getTime());//记录此次请求的时间，用来做延时用的
		if(data.totalCount >= 0){//表示数据请求成功
			currentPage = data.currentPage;
			pagePage = data.pagePage;
			globalData['currentPage' + suffixStr] = currentPage;
			globalData['pagePage' + suffixStr] = pagePage;
			if(data.totalCount === 0){//表示请求到的数据为0
				listContent.html('');
				refreshPrompt.html('');
				Common.blankPageFn(listContent);//显示空白界面
				return false;
			}
			Common.blankPageFn(listContent, 'hide');//隐藏空白界面
			if(currentPage < pagePage){
				refreshPrompt.html('上拉加载');
			}else{
				refreshPrompt.html('没有更多了');
			}
			
			
			var str = '', btnStr = '', imgSrc = '', img1, img2, img3, aStr;
			$.each(data.recordList, function(index, obj){
				imgSrc = obj.object.userImage ? Common.getImageUrl(obj.object.userImage) : '../../image/icon/minePortrait.png';
				img1 = obj.image1 ? ('<img onclick="previewPicFn(this)" src="' + Common.getImageUrl(obj.image1) + '">') : '';
				img2 = obj.image2 ? ('<img onclick="previewPicFn(this)" src="' + Common.getImageUrl(obj.image2) + '">') : '';
				img3 = obj.image3 ? ('<img onclick="previewPicFn(this)" src="' + Common.getImageUrl(obj.image3) + '">') : '';
				if(typenum == 1){
					aStr = '<a href="../indiana/product_details.html?productId=' + obj.productId + '">试试手气</a>';
				}else if(typenum == 2){
					aStr = '<a href="../indiana/product_details_ds.html?productId=' + obj.id + '">给我来一份</a>';
				}
				str +=  '<div class="xlsh-li">'+
							'<div class="xlsh-p1 clearfix">'+
								'<img src="' + imgSrc + '">'+
								'<span>' + obj.date + '</span>'+
							'</div>'+
							'<div class="xlsh-p2">' + obj.content + '</div>'+
							'<div class="xlsh-p3 clearfix">' + img1 + img2 + img3 + '</div>'+
							'<div class="xlsh-p4">获奖商品：<span class="color-ff5534">' + obj.object.productName + '</span></div>'+
							'<div class="xlsh-p5">' + aStr + '</div>'+
						'</div>';
			});
			if(currentPage == 1){//说明是这个项目容器第一页
				listContent.html(str);
			}else{
				listContent.html(listContent.html() + str);
			}
			listContent.find('img').each(function(){
				var $img = $(this);
				if(!$img.attr('data-size')){
					var newImg = new Image();
					newImg.src = $img.attr('src');
					newImg.onload = function(){
						$img.attr('data-size', (this.width + '|,|' + this.height));
					}
				}
			});
		}else{
			refreshPrompt.html(data.error_description || '未知错误');
		}
	});
};

//图片预览显示
function openPhotoSwipe(items, index){
	if(!(items.length > 0)){return false;};
	index = index || 0;
	var pswpElement = document.querySelector('.pswp');
	var options = {
		shareEl: false,
		index: index
	};
	var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
	gallery.init();
}
//图片预览初始化
function previewPicFn(me){
	var $me = $(me),
		imgs = $me.parent().find('img');
	var items = [], winW = $(window).width(),
		w, h, wh, i, $img, size;
	imgs.each(function(index, img){
		if(img == me){i = index;};
		$img = $(img);
		size = ($img.attr('data-size') || '').split('|,|');
		w = size[0] || winW;
		h = size[1] || winW;
		wh = w/h; 
		w = w > winW ? winW : w;
		h = w/wh;
		items.push({
			src: $img.attr('src'),
			w: w,
			h: h
		});
	});
	openPhotoSwipe(items, i);
}
</script>
</body>
</html>
