<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>我的</title>
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<style>
.xlm-head {
	position: relative;
	background: #ff8208;
}
.xlm-head-body {
	position: relative;
	z-index: 10;
	text-align: center;
	padding: .8em 0;
}
.xlm-head-photo img {
	width: 5em;
	height: 5em;
	border: solid 2px #fcd055;
	border-radius: 50%;
}
.xlm-head-text {
	color: #fff;
	font-size: 1.2em;
	width: 60%;
	margin: 0 auto;
	white-space: nowrap;
	text-overflow: ellipsis;
	overflow: hidden;
}
.xlm-signin-btn {
	position: absolute;
	bottom: 1em;
	right: 1em;
	z-index: 10;
}
.xlm-signin-btn:active {
	opacity: 0.8;
}
.xlm-signin-btn.disabled {
	background: #888;
	color: #ccc;
}


.xlmf-box2 {
	background: #fff;
	padding: 15px 0;
	text-align: center;
}
.xlmf-box2 a {
	position: relative;
	float: left;
	width: 50%;
	color: #fe5632;
}
.xlmf-fa-body {
	position: relative;
	width: 90%;
	line-height: 1.2;
}
.xlmf-fa-body:after {
	position:absolute;
	top: 50%;
	right: 0;
    font-family: 'iconfont';
    margin-top: -.5em;
    content: "\e775";
	font-size: 1.4em;
	line-height: 1;
}
.xlmf-fs2 {
	font-size: 1.2em;
	font-weight: bold;
}
.xlmf-fa2:before {
    content: "";
	position:absolute;
	top: 3px;
	bottom: 3px;
	left: 0;
	width: 1px;
	background: #feab9b;
}

.xlm-list-box .xlli-menu-right:before {
	font-size: 1.4em;
	color: #888;
}
.xlm-box1 {
	padding: 0 1em;
	display: table;
	width: 100%;
}
.xlm-box1 .xlmenu-item {
	width: auto;
	float: none;
	display: table-cell;
}
.xlm-box1 .xlmenu-item .xl9g-img {
	margin: 3px 0;
	width: 2.2em;
}
.xl-badge-box {
	display: inline-block;
	position: relative;
	vertical-align: top;
}
.xl-badge-box .xlbadge {
	position: absolute;
	right: -5px;
	top: 0;
	width: 20px;
	height: 20px;
	border-radius: 50px;
	background: #ff5534;
	color: #fff;
	line-height: 20px;
	font-size: 12px;
}
.xlmf-lrtitle {
	background: #fff;
	padding: 0 .8em;
	border-bottom: solid 1px #ccc;
	font-size: 1.2em;
	line-height: 2.4em;
}
.xlmf-lrtitle .xllr-box .xllr-r {
	font-size: .8em;
	color: #888;
}
.xlmf-lrtitle .icon-right {
	font-size: 1em;
	color: #888;
}

.xl-li-right {
	position: absolute;
	top: 50%;
	right: 15px;
	margin-top: -.5em;
	line-height: 1;
	color: #888;
}
.xlli-menu-right .xl-li-right {
	display: none;
}

.xl-li > a {
	padding: .8em;
}


.xlmf-box3 {
	position: relative;
}
.xlmf-box3 > a {
	display: block;
	padding: 10px 15px;
	background: #fff;
	color: #fe5632;
}
.xlmf-box3:before {
	color: #fe5632;
	font-size: 16px;
}
.xlmf-box3 .xllr-r {
	font-size: 1.2em;
	font-weight: bold;
	right: 20px;
}
</style>
</head>
<body>
<div class="xlbody-box">
	<div class="xlm-head">
		<div class="xlm-head-bg1"></div>
		<div class="xlm-head-body" id="userInfoBox">
			<a href="../weixinmp/user_info.html" class="xlm-head-photo">
				<img src="../../image/icon/minePortrait.png">
			</a>
			<div class="xlm-head-text">　<small>（　）</small></div>
		</div>
	</div>
	<div class="xlmf-box3 xlli-menu-right">
		<a href="../mine/integral_detail.html">
			<div class="xllr-box">
				<div>彩豆 / 明细</div>
				<div class="xllr-r integralEle">00</div>
			</div>
		</a>
	</div>
	<div class="xlmf-box2 hide clearfix">
		<a class="xlmf-fa1" href="../mine/integral_detail.html">
			<div class="xlmf-fa-body">
				<div class="xlmf-fs1">彩豆 / 明细</div>
				<div class="xlmf-fs2 integralEle">00</div>
			</div>
		</a>
		<a class="xlmf-fa2" href="../order/recharge.html">
			<div class="xlmf-fa-body">
				<div class="xlmf-fs1">余额 / 购买</div>
				<div class="xlmf-fs2" id="currencyEle">00</div>
			</div>
		</a>
	</div>
	<div style="height: 5px;"></div>
	<div class="xlmf-lrtitle">
		<div class="xllr-box">
			<div>商城订单</div>
			<a class="xllr-r" href="../order/user_order_ds.html?showItem=tabContent100">查看更多订单<i class="icon icon-right"></i></a>
		</div>
	</div>
	<div class="xlmenu-box clearfix xlm-box1">
		<div class="xlmenu-item" id="orderEleDFK">
			<a href="../order/user_order_ds.html?showItem=tabContent1">
				<div class="xl-badge-box">
					<img  class="xl9g-img" src="../../image/mine/mine008.png">
					<i class="xlbadge hidden"></i>
				</div>
				<span class="xl9g-text">待付款</span>
			</a>
		</div>
		<div class="xlmenu-item" id="orderEleDFH">
			<a href="../order/user_order_ds.html?showItem=tabContent2">
				<div class="xl-badge-box">
					<img  class="xl9g-img" src="../../image/mine/mine009.png">
					<i class="xlbadge hidden"></i>
				</div>
				<span class="xl9g-text">待发货</span>
			</a>
		</div>
		<div class="xlmenu-item" id="orderEleDSH">
			<a href="../order/user_order_ds.html?showItem=tabContent3">
				<div class="xl-badge-box">
					<img  class="xl9g-img" src="../../image/mine/mine010.png">
					<i class="xlbadge hidden"></i>
				</div>
				<span class="xl9g-text">待收货</span>
			</a>
		</div>
		<!--<div class="xlmenu-item" id="orderEleDSD">
			<a href="../order/user_order_ds.html?showItem=tabContent4">
				<div class="xl-badge-box">
					<img  class="xl9g-img" src="../../image/mine/mine011.png">
					<i class="xlbadge hidden"></i>
				</div>
				<span class="xl9g-text">待晒单</span>
			</a>
		</div>-->
		<div class="xlmenu-item" id="orderEleTH">
			<a href="../order/user_order_ds.html?showItem=tabContent5">
				<div class="xl-badge-box">
					<img  class="xl9g-img" src="../../image/mine/mine012.png">
					<i class="xlbadge hidden"></i>
				</div>
				<span class="xl9g-text">退　货</span>
			</a>
		</div>
	</div>
	<div style="height: 5px;"></div>
	<div class="xlm-list-box">
		<ul class="xl-ul">
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../message/message_class.html">
					<img class="xl-li-img" src="../../image/mine/mine017.png">
					<div class="xl-li-txt">我的消息</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../mine/my_lottery_list.html?showItem=tabContent1">
					<img class="xl-li-img" src="../../image/mine/mine003.png">
					<div class="xl-li-txt">我的彩票</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii hide" id="prize_to">
				<a href="../mine/my_prize_order.html?showItem=tabContent1">
					<img class="xl-li-img" src="../../image/mine/mine001.png">
					<div class="xl-li-txt">我的抽奖</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../card_bag/card_list.html">
					<img class="xl-li-img" src="../../image/mine/mine015.png">
					<div class="xl-li-txt">我的卡包</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../mine/lottery_grade.html">
					<img class="xl-li-img" src="../../image/mine/mine016.png">
					<div class="xl-li-txt">扫票成就</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii hide" id="bill_runwater">
				<a href="../fiction/change_bill.html">
					<img class="xl-li-img" src="../../image/mine/mine014.png">
					<div class="xl-li-txt">兑换账单</div>
				</a>
			</li>
			<li class="xl-li xlli-menu-right xl-lii">
				<a onclick="applyForGeneral()">
					<img class="xl-li-img" src="../../image/mine/mine013.png">
					<div class="xl-li-txt">推广员</div>
				</a>
			</li>
			<!--<li class="xl-li xlli-menu-right xl-lii">
				<a>
					<img class="xl-li-img" src="../../image/mine/mine002.png">
					<div class="xl-li-txt">我的游戏</div>
				</a>
			</li>-->
			<!--<li class="xl-li xlli-menu-right xl-lii">
				<a href="share_list.html?showItem=tabContent2">
					<img class="xl-li-img" src="../../image/mine/mine004.png">
					<div class="xl-li-txt">我的晒单</div>
					<div class="xl-li-right"></div>
				</a>
			</li>-->
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../address/address.html">
					<img class="xl-li-img" src="../../image/mine/mine005.png">
					<div class="xl-li-txt">我的地址</div>
				</a>
			</li>
			<!--<li class="xl-li xlli-menu-right xl-lii">
				<a href="../mine/pay_record.html">
					<img class="xl-li-img" src="../../image/mine/mine006.png">
					<div class="xl-li-txt">余额明细</div>
				</a>
			</li>-->
			<li class="xl-li xlli-menu-right xl-lii">
				<a href="../instruction/common_problems.html">
					<img class="xl-li-img" src="../../image/mine/mine007.png">
					<div class="xl-li-txt">常见问题</div>
				</a>
			</li>
		</ul>
	</div>
</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script src="../../script/defaultxl.js?v=20180131"></script>
<script>
"use strict";
$(function() {
	globalData.loadReady();//页面加载完成执行
	pageDataInit();//页面数据初始化
	domEventFn();//dom初始化事件绑定
	reloadDataFn();//所有需要从服务器加载的数据请求
});
//页面启动时，数据初始化
function pageDataInit(){
	if(globalData.pageParam.goGeneral === 'yes'){
		applyForGeneral();
	}
}
//dom事件绑定
function domEventFn(){
}
//所有需要从服务器加载的数据请求
function reloadDataFn(){
	//ajax并发请求
	Common.ajaxAll([
		balanceFn(),//彩豆获取，显示
		getNoDealFn(),//用户各个订单的数量
		getPrizeData(),//获取用户抽奖数据，用于显示我的抽奖的列表点击
		
		userInfoFn,//余额数量获取，显示
		getDromoter//推广员数据，用于确实是否显示兑换账单
	],function(){
		balanceFn(arguments[0]);
		getNoDealFn(arguments[1]);
		getPrizeData(arguments[2]);
	});
}


//彩豆获取，显示
function balanceFn(data){
	if(!data){
		return {url: (Common.domainUrl + '/ushop-api-merchant/api/user/account/point/listBy/' + Common.getUserId())}
	}
	if(data.recordList){
		var balance = 0;
		$.each(data.recordList, function(index, obj){
			balance += parseInt(obj.balance);
		});
		$('.integralEle').text(balance);
	}
}

//余额数量获取，显示
function userInfoFn(callback){
	callback = callback || function(){};
	Common.userInfoL(function(data){
		callback(data);
    	if(data.userNo){
			var nickName     = data.nickName || '',//用户名，string
				address      = data.address || '暂无',//籍贯，string
				headImage    = data.headImage ? Common.getImageUrl(data.headImage) : '../../image/icon/minePortrait.png',//头像地址，string
				diamond      = data.diamond || 0,//余额数量，number
				sex          = data.sex || '',//性别，string
				loginName    = data.loginName || '',//登录名，string
				userNo       = data.userNo || '',//用户id
				age          = data.age || '',//年龄，number
				realName     = data.realName || '',//真实姓名，string
				cardNo       = data.cardNo || '',//身份证号，string
				telNo        = data.telNo || '';//电话号码，string
			$('#currencyEle').html(diamond);
			var str = 
				'<a href="../weixinmp/user_info.html" class="xlm-head-photo">'+
					'<img src="' + headImage + '">'+
				'</a>'+
				'<div class="xlm-head-text">' + Common.phoneEncryption(nickName) + '<small>（' + address + '）</small>' + '</div>';
			$('#userInfoBox').html(str);
    	}
	}, false);
}


//未处理订单数据
function getNoDealFn(data){
	if(!data){
		return {url: '/ushop-api-merchant/api/mall/person/order/getCount'};
	}
	var noPayCount = parseInt(data.noPayCount),//待付款
		noExperssCount = parseInt(data.noExperssCount),//待发货
		noReceiveCount = parseInt(data.noReceiveCount),//待收货
		noShareCount = parseInt(data.noShareCount),//带晒单
		backCount = parseInt(data.backCount);//退货
	var dfkBad = document.querySelector('#orderEleDFK .xlbadge'),
		dfhBad = document.querySelector('#orderEleDFH .xlbadge'),
		dshBad = document.querySelector('#orderEleDSH .xlbadge'),
		dsdBad = document.querySelector('#orderEleDSD .xlbadge'),
		thBad = document.querySelector('#orderEleTH .xlbadge');
	if(noPayCount > 0){
		dfkBad.innerHTML = noPayCount;
		dfkBad.classList.remove('hidden');
	}else{
		dfkBad.classList.add('hidden');
	}
	if(noExperssCount > 0){
		dfhBad.innerHTML = noExperssCount;
		dfhBad.classList.remove('hidden');
	}else{
		dfhBad.classList.add('hidden');
	}
	if(noReceiveCount > 0){
		dshBad.innerHTML = noReceiveCount;
		dshBad.classList.remove('hidden');
	}else{
		dshBad.classList.add('hidden');
	}
//	if(noShareCount > 0){
//		dsdBad.innerHTML = noShareCount;
//		dsdBad.classList.remove('hidden');
//	}else{
//		dsdBad.classList.add('hidden');
//	}
	if(backCount > 0){
		thBad.innerHTML = backCount;
		thBad.classList.remove('hidden');
	}else{
		thBad.classList.add('hidden');
	}
}

//申请并进入推广员界面
function applyForGeneral(){
	Common.userInfoL(function(data){
		if(data.userNo){
			if(data.promoter == 100){//审核中
				Common.toast('推广员审核中……');
			}else if(data.promoter == 101){//审核通过
				Common.openPage('../weixinmp/general_c.html');
			}else if((data.promoter == 102) || (!data.promoter)){//审核不通过或未申请
				personalRegisFn();
			}
		}
	});
}

//获取推广员数据
function getDromoter(callback){
	callback = callback || function(){};
	Common.generalL(function(data){
		callback(data);
		if(data.id){
			var type = data.type;
			if(type === 1){
				$('#bill_runwater').removeClass('hide');
			}else{
				$('#bill_runwater').addClass('hide');
			}
		}
	}, false);
}


//个人注册推广员提交事件执行函数
function personalRegisFn(){
	var _url = '/ushop-api-merchant/api/user/promotion/promoter/register',
		fo = {
			name: '',
			cardNo: '',
			bankNo: '',
			bankName: '',
			bankProvince: '',
			bankCity: '',
			bankArea: '',
			stationId: '',
			type: 2
		};
	Common.ajax(_url, 'post', JSON.stringify(fo), function(data){
    	if(data.succeed){
			Common.userInfoL({promoter: 101});
			Common.openPage('../weixinmp/general_c.html');
    	}else if(data.error_description){
    		Common.toast(data.error_description);
    	}else{
    		Common.toast('未知错误，请稍后重试');
    	}
    });
}

//获取用户抽奖数据
function getPrizeData(data){
	if(!data){
		return {
			url: (Common.domainUrl + '/ushop-api-merchant/api/spellbuy/person/record/public/listUserSpellBuyRecord/' +
				'1/10/0/' + Common.getUserId())
		}
	}
	if(data.totalCount > 0){
		$('#prize_to').removeClass('hide');
	}else{
		$('#prize_to').addClass('hide');
	}
}
</script>
</body>
</html>
