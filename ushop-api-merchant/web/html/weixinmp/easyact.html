<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>关注领红包</title>
    <link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180817"/>
    <style>
        .ea-box {
            top: 0;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .page-bgimg {
            width: 100%;
            height: 100%;
        }

        .h0000 {
            height: 100% !important;
        }

        .a0000 {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;

        }

        .ea_btn:active {
            opacity: .9;
        }

        .ea-num,
        .ea-money {
            font-size: 20px;
            line-height: 2;
            text-align: center;
            color: #0f0;
        }

        .btn-get-for-free {
            margin: auto;
            position: absolute;
            left: 0;
            right: 0;
            width: 130px;
            height: 40px;
            bottom: 7px;
        }

        .div-activity-time {
            width: 100%;
            text-align: center;
            font-size: 15px;
            color: white;
            bottom: 74px;
            position: absolute;
        }

        .div-start-end {
            font-size: 15px;
            color: white;
            position: absolute;
            width: 100%;
            text-align: center;
            bottom: 54px;
        }

        .div-cover {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            background-color: #000;
            opacity: 0.7;
            visibility: hidden;
        }

        .div-prized-dialog {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            visibility: hidden;
        }

        .img-prized-bg {
            width: 80%;
            position: absolute;
            margin: 0 auto;
            top: 17%;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .img-prized-bg2 {
            width: 80%;
            position: absolute;
            margin: 0 auto;
            top: 17%;
            left: 10%;
            right: 0;
            bottom: 0;
        }

        .img-btn-continue {
            width: 60px;
            position: absolute;
            margin: 0 auto;
            top: 55%;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .img-prize-amount {
            width: 30%;
            position: absolute;
            margin: 0 auto;
            top: 42%;
            left: 6%;
            right: 0;
            bottom: 0;
        }

        .div-notice {
            width: 60%;
            margin: 0 auto;
            left: 0;
            right: 0;
            text-align: center;
            position: absolute;
            top: 75.5%;
            font-size: 8px;
            color: white;
        }

        .img-anim {
            width: 70%;
            height: 70%;
            position: absolute;
            margin: 0 auto;
            top: 40%;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .canvas-danmu {
            width: 100%;
            height: 100px;
            background-color: black;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0.7;
        }

        * {
            box-sizing: border-box;
        }

        #box,
        #pox {
            width: 100%;
            height: 70px;
            background-color: black;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0.7;
        }

        .tibarrager-box,
        .anibarrager-box {
            position: absolute;
            left: 120%;
            font-size: 14px;
        }

        .tibarrager-txt,
        .anibarrager-txt {
            max-width: 350px;
            line-height: 2;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 1.5em 0 2.5em;
            font-size: 15px;
        }

        .tibarrager-img,
        .anibarrager-img {
            position: absolute;
            left: -2em;
            top: -1em;
            width: 4em;
            height: 4em;
            line-height: 1;
            vertical-align: top;
            border-radius: 50%;
        }

        @keyframes anirTol {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-750px);
            }
        }

        .anibarrager-box.tomove1 {
            animation: 5s linear both anirTol;
        }

        .anibarrager-box.tomove2 {
            animation: 6s linear both anirTol;
        }

        .anibarrager-box.tomove3 {
            animation: 7s linear both anirTol;
        }

    </style>
</head>

<body>
<div class="xlele-box ea-box ea_box">
    <div class="xlele-content ea_content">
        <!-- 背景图片 -->
        <img class="page-bgimg" src="../../image/red/bg_red.png"/>
        <!-- 用于遮屏，用户不能直接点击图片 -->
        <div class="a0000"></div>

        <div class="a0000" style="padding-top: 200px;">
            <img id="img-anim" class="img-anim" src="../../image/red/ic_y_0.png"/>
            <div id="div-notice" class="div-notice"></div>
            <div class="div-activity-time">活动时间</div>
            <div class="div-start-end div-start-end"></div>
            <img id="btn-get-for-free" src="../../image/red/btn_get_for_free.png" class="btn-get-for-free"
                 onclick="userClickDraw()"/>
        </div>

        <div id="div-cover" class="div-cover"></div>
        <div id="prized-dialog" class="div-prized-dialog">
            <img class="img-prized-bg" src="../../image/red/bg_prize_open.png"/>
            <img class="img-prized-bg2" src="../../image/red/bg_prized.png"/>
            <img class="img-prize-amount" src="../../image/red/ic_prize_amount.png"/>
            <img class="img-btn-continue" src="../../image/red/btn_continue.png" onclick="gotoAct()"/>
        </div>
    </div>

    <!-- <canvas class="canvas-danmu">你的浏览器不支持canvas</canvas> -->
    <div id="pox"></div>

</div>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script src="../../script/md5.js"></script>
<script src="../../script/common.js?v=20180817"></script>
<script src="../../script/defaultxl.js?v=20180817"></script>
<script>
    "use strict";
    $(function () {
        globalData.loadReady(); //页面加载完成执行
        pageDataInit(); //页面数据初始化
        domEventFn(); //dom初始化事件绑定
        reloadDataFn(); //所有需要从服务器加载的数据请求
    });

    //页面启动时，数据初始化
    function pageDataInit() {
        playAnim();
    }

    //dom事件绑定
    function domEventFn() {
        eacBgwh(0.6, 0.7);
        $(window).on('resize', function () {
            eacBgwh(0.6, 0.7);
        });
    }

    //所有需要从服务器加载的数据请求
    function reloadDataFn() {
        var id3 = globalData.pageParam.id3; // 简单活动的ID
        // globalData.pageParam.id3 = 30;
        // globalData.pageParam.id = 32;
        // var id3 = 30;
        // var id = 32;

        var id = globalData.pageParam.id; // 红包或转盘活动的ID
        if (!(id && id3)) {
            Common.toast('活动ID不存在');
            return false;
        }
        var urls = [
            {url: ('/ushop-api-merchant/api/sns/task/detail/get/' + id3)}, // 获取任务活动详情
            {url: ('/ushop-api-merchant/api/sns/task/wishing/done/get/' + id3)}, // 活动剩余可以参与的次数
            {
                url: '/ushop-api-merchant/api/sns/task/wishing/winner/listBy',
                data: {id: id3, page: 1, rows: 50},
                method: 'get'
            } // 获奖信息
        ]
        // 如果是微信，需要微信授权
        if (Common.isWeixin()) {
            // urls.push(wxAuthoriseFn);
            wxAuthoriseFn();
        }
        Common.ajaxAll(urls, function () {
            var data = arguments[0];
            var count = parseInt(arguments[1].count); // 活动剩余可以参与的次数
            var winArr = arguments[2].recordList || [] // 中奖列表，用于弹幕

            paraFormat(winArr)

            if (data.id) {
                count = ((count > 0) ? count : 0);
                data.numNum = count;
                data.rewardPool = parseFloat(data.rewardPool);
                globalData.actDetails = data; // 记录全局变量
                setNM(data);
            }
        });
    }

    function BarragerAni(ele, para) {
        this.box = ele
        this.para = para
        this.height = this.box.offsetHeight // 容器高度
        this.itemh = 56 // 元素最大高度
        this.pushMsg = function (obj) {
            let div = this.getDiv(obj)
            this.box.appendChild(div)
            div.addEventListener('animationend', () => {
                this.box.removeChild(div)
            })
            div.classList.add(('tomove' + (parseInt(Math.random() * (3 - 1) + 1))))
        }
        this.getDiv = function (obj) {
            let div = document.createElement('div'),
                str = `<div class="anibarrager-txt">${obj.txt}<\/div>`
            div.className = 'anibarrager-box'
            div.style.top = (parseInt(Math.random() * (this.height - this.itemh)) + 10 + 'px') // 容器范围内出现
            div.innerHTML = str
            return div
        }
        this.init = function () {
            this.pushMsg(this.para[parseInt(Math.random() * this.para.length)])
            setInterval(() => {
                this.pushMsg(this.para[parseInt(Math.random() * this.para.length)])
            }, 3000)
        }
    }

    // 弹幕数据格式化
    function paraFormat(winArr) {
        var arr = [];

        for (var i = 0; i < winArr.length; i++) {
            var txt = "恭喜" + winArr[i].userName + "领到红包1.08元...";

            arr[i] = {txt: txt}
        }

        var ani = new BarragerAni(document.querySelector('#pox'), arr)
        ani.init()
    }

    function compareDate(endTime) {
        var today = new Date();

        var year = today.getFullYear();
        var month = today.getMonth() + 1;
        var day = today.getDate();

        var a = endTime.toString().split("-");

        var y = a[0];
        var m = a[1];
        var d = a[2];

        month = month.toString().length == 1 ? "0" + month : month;
        day = day.toString().length == 1 ? "0" + day : day;

        var m = year + month + day;
        var n = y + m + d;

        return parseInt(m) > parseInt(n) ? true : false;
    }

    var flag = true;
    var animTag = 0; // 0 播待薅动画  1 播薅动画

    // 页面数据更新
    function setNM(data) {
        var $num = $('.ea_num');
        var $money = $('.ea_money');
        var $time = $('.div-start-end');

        var b = compareDate(data.endDate.split(" ", 1));

        if (b) { // 活动过期了
            flag = false;
            $("#div-notice").text("活动已过期，请点击下方按钮前往下一个活动");

        } else if (data.numNum == 0) {
            flag = false;
            $("#div-notice").text("您已参与过此活动，请点击下方按钮前往下一个活动");

        } else if (data.rewardPool == 0) {
            flag = false;
            $("#div-notice").text("手太慢，红包已经被抢完了，请点击下方按钮前往下一个活动");
        }

        // $num.text('可用次数为：' + data.numNum);
        // $money.text('奖池金额为：' + data.rewardPool);

        if (!flag) {
            $('#btn-get-for-free').attr('src', '../../image/red/btn_zhufu.png');
        }

        $time.text(data.startDate.split(" ", 1) + ' -- ' + data.endDate.split(" ", 1));

//        if (!(data.rewardPool > 0)) {
//            Common.confirm('提示', '奖池没有金额，是否去到活动界面', function () {
//                if (index === 1) {
//                    gotoAct();
//                }
//            });
//        }
    }

    // 更新背景的size
    // 最小宽高比，最大宽高比
    function eacBgwh(minwh, maxwh) {
        var $eab = $('.ea_box');
        var w_h = $eab.innerWidth() / $eab.innerHeight();
        minwh = parseFloat(minwh) || 0.6;
        maxwh = parseFloat(maxwh) || 0.7;
        if (w_h > minwh && w_h < maxwh) {
            $('.ea_content').addClass('h0000');
        } else {
            $('.ea_content').removeClass('h0000');
        }
    }

    // 获取任务活动详情
    function getTaskDetail(id, callback) {
        callback = callback || function () {
        };
        var _url = '/ushop-api-merchant/api/sns/task/detail/get/' + id;
        Common.ajax(_url, 'get', {}, function (data) {
            callback(data);
        })
    }

    // 获取任务活动详情
    function getTaskNum(id, callback) {
        callback = callback || function () {
        };
        var _url = '/ushop-api-merchant/api/sns/task/wishing/done/get/' + id;
        Common.ajax(_url, 'get', {}, function (data) {
            var count = parseInt(data.count); // 活动剩余可以参与的次数
            count = ((count > 0) ? count : 0);
            callback(count);
        })
    }

    function playAnim() {
        var animImg = 0;
        var cnt = (animTag == 0 ? 8 : 15);

        setInterval(function () {
            if (animImg > cnt) {
                animImg = 0;
            }

            if (animTag == 0) {
                $('#img-anim').attr('src', '../../image/red/ic_y_' + animImg + '.png');

            } else {
                $('#img-anim').attr('src', '../../image/red/ic_h_' + animImg + '.png');
            }

            animImg++;

        }, 150);
    }

    // 用户点击抽奖
    function userClickDraw() {
        if (flag) {
            animTag = 1;

            var numNum = globalData.actDetails.numNum; // 可抽奖次数
            var rewardPool = globalData.actDetails.rewardPool; // 奖池金额
            if (numNum > 0 && rewardPool > 0) {
                getUserDraw(globalData.pageParam.id3);
                Common.loadingShow();
            } else {
                Common.toast('奖池金额或抽奖次数没有了');
            }

        } else {
            gotoAct();
        }
    }

    // 用户抽奖，获取抽奖流水号
    function getUserDraw(id3) {
        var _url = '/ushop-api-merchant/api/sns/task/wishing/draw/' + id3;
        Common.ajax(_url, 'post', {}, function (data) {
            if (data.requestNo) {
                getDrawRe(data.requestNo);
            } else {
                Common.loadingHide();
                Common.toast('错误：抽奖失败1');
            }
        }, false)
    }

    // 抽奖结果查询
    function getDrawRe(rno) {
        var _url = '/ushop-api-merchant/api/sns/task/wishing/result/get/' + rno;
        var baset = 2000; // 重复请求的基数
        var maxt = 60000; // 判断超时的最大值
        var acttt = 0;
        ronFn();

        function ronFn() {
            // 如果超过规定时间还未请求到结果，改变重复请求的基数
            if (acttt > 5000) {
                baset = 5000
            } else if (acttt > 30000) {
                baset = 10000
            }
            Common.ajax(_url, 'get', {}, function (data) {
                if (data.status === 102) { // 未中奖
                    handResult();
                } else if (data.status === 103) {
                    if (data.result) { // 中奖
                        handResult(data);
                    } else { // 未中奖
                        handResult();
                    }
                } else if (acttt > maxt) { // 请求超时当做未中奖
                    handResult();
                } else { // 继续递归查询
                    setTimeout(function () {
                        acttt += baset;
                        ronFn();
                    }, baset);
                }
            }, false)
        }
    }

    // 抽奖结果处理
    function handResult(obj) {
        Common.loadingHide(); // 隐藏加载中
        if (obj) { // 中奖了
            var p = obj.result || {}
            // 奖等金额
            var cunwp = parseInt(p.awardValue)
            // index = 1 表示一等奖，2表示二等奖以此类推
            var award = p.index;
            var str = '恭喜，您中了' + award + '等级，金额为' + cunwp;
//            Common.confirm('恭喜', str, function (index) {
//                if (index === 1) {
//                    gotoAct();
//                }
//            });

            setTimeout(function () {
                animTag = 0;

                $("#div-cover").css("visibility", "visible");
                $("#prized-dialog").css("visibility", "visible");
            }, 3000);

        } else { // 未中奖
//            Common.confirm('提示', '很遗憾，您未中奖', function (index) {
//                if (index === 1) {
//                    gotoAct();
//                }
//            });
        }
    }

    // 去到其他活动界面，红包雨或者转轮盘
    function gotoAct() {
        var _url = 'drawred/index.html#/?id=' + globalData.pageParam.id;
        Common.openPage(_url, null, null, true); // 不留历史跳转
    }


    //微信授权接口
    function wxAuthoriseFn(callback) {
        callback = callback || function () {
        };
        var _url = Common.domainUrl + '/ushop-api-merchant/api/weixin/client/ticket/get?' +
            'type=jsapi&url=' + document.URL;
        Common.ajax(_url, 'get', {}, function (data) {
            if (data.sign) {
                configFn(data.timestamp, data.noncestr, data.sign);
                callback();
            }
        }, false);
    }

    //微信配置接口
    //configFn(1495764791, 'Kmifefp2whjxfbst', '7ebdce4d83faadb22e3d0d277bcaefe0cd08514e');
    function configFn(timestamp, nonceStr, signature) {
        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: Common.getAppId(), // 必填，公众号的唯一标识
            timestamp: timestamp, // 必填，生成签名的时间戳
            nonceStr: nonceStr, // 必填，生成签名的随机串
            signature: signature,// 必填，签名，见附录1
            jsApiList: [// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                'onMenuShareTimeline',//获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
                'onMenuShareAppMessage'//获取“分享给朋友”按钮点击状态及自定义分享内容接口
            ]
        });
    }

    //微信初始化完成执行
    // wx.ready(function () {
    //     globalData.isTicketLottery = true; // 用于判断微信jssdk授权完成
    //     //获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
    //     var id3 = globalData.pageParam.id3; // 简单活动的ID
    //     var id = globalData.pageParam.id; // 红包或转盘活动的ID
    //     var slink = (Common.domainUrl + '/ushop-api-merchant/html/weixinmp/index.html?wxbtnGoto=' + Common.engoto('weixinmp/easyact.html?id=' + id + '&id3=' + id3) + '&promoter=' + Common.getUserId());
    //     var ilink = (Common.domainUrl + '/ushop-api-merchant/image/icon/logoicon.png');
    //     var title = '注册彩乐宝 领彩豆好礼';
    //     var desc = '好友邀请您注册彩乐宝，双赢好礼一起抢，10彩豆即可中Iphone7哦~！';
    //     wxShareFn(slink, ilink, title, desc);
    // });

    //微信初始化完成执行
    wx.ready(function(){
        //获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
        wx.onMenuShareTimeline({
            title: '注册彩乐宝 领彩豆好礼', // 分享标题
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            link: (Common.domainUrl + '/ushop-api-merchant/html/weixinmp/index.html?promoter=' + Common.getUserId()),
            imgUrl: (Common.domainUrl + '/ushop-api-merchant/image/icon/logoicon.png'), // 分享图标
            success: function () {
                Common.toast('分享成功！');
            },
            cancel: function () {
                Common.toast('用户取消！');
            }
        });

        //获取“分享给朋友”按钮点击状态及自定义分享内容接口
        wx.onMenuShareAppMessage({
            title: '注册彩乐宝 领彩豆好礼', // 分享标题
            desc: '好友邀请您注册彩乐宝，双赢好礼一起抢，10彩豆即可中Iphone7哦~！', // 分享描述
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            link: (Common.domainUrl + '/ushop-api-merchant/html/weixinmp/index.html?promoter=' + Common.getUserId()),
            imgUrl: (Common.domainUrl + '/ushop-api-merchant/image/icon/logoicon.png'), // 分享图标
            type: 'link', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                Common.toast('分享成功！');
            },
            cancel: function () {
                Common.toast('用户取消！');
            }
        });
    });

    // 微信分享事件监听初始化
    function wxShareFn(slink, ilink, title, desc) {
        // http://clb.lotplay.cn/ushop-api-merchant/html/weixinmp/index.html?wxbtnGoto=indiana_xlw_product_details_xlp_arr_xld_1015_xl_1
        //获取“分享到朋友圈”按钮点击状态及自定义分享内容接口
        window.wx.onMenuShareTimeline({
            title: title, // 分享标题
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            link: slink,
            imgUrl: ilink, // 分享图标
            success: function () {
                Common.toast('分享成功！');
            },
            cancel: function () {
                Common.toast('用户取消！');
            }
        });

        //获取“分享给朋友”按钮点击状态及自定义分享内容接口
        window.wx.onMenuShareAppMessage({
            title: title, // 分享标题
            desc: desc, // 分享描述
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            link: slink,
            imgUrl: ilink, // 分享图标
            type: 'link', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function () {
                Common.toast('分享成功！');
            },
            cancel: function () {
                Common.toast('用户取消！');
            }
        });
    }
</script>
</body>

</html>