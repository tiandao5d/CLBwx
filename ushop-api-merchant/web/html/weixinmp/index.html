<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="stylesheet" type="text/css" href="../../css/style.css?v=20180131"/>
<title>彩乐宝</title>
</head>
<body>
<script src="../../script/jquery-1.12.4.min.js"></script>
<script src="../../script/common.js?v=20180131"></script>
<script>
"use strict";
$(function(){
	Common.loadingShow('加载中，请稍后……');
	var a = deCodeUrlFn();
	if(Common.isWeixin()){
		if((Common.domainUrl === 'http://clb.lotplay.cn') || (Common.domainUrl === 'http://clbtest.lotplay.cn')){
			indexInitFn();//微信首页认证初始化
		}else{
			Common.toast('参数错误！')
		}
	}else{//跳转到网页版账号注册界面
		var _url = Common.domainUrl + '/ushop-api-merchant/register/index.html'+
				   (a.promoter ? ('?promoter=' + a.promoter) : '');
		window.open(_url, '_self');
	}
});


//微信首页认证初始化
function indexInitFn(){
	var a = deCodeUrlFn();
	if(a.loginOverdue == 'yes'){//说明是登录失效过来
		Common.toast('登录失效！正在重新登录！');
	}
	//说明是已经登录完成，开始解析地址数据
	if(a.userId){
		var gotoPage = 'home.html',
			index,
			pageView,
			d, b, c = '';
		if(a.view){
			//'http://clb.lotplay.cn/ushop-api-merchant/html/weixinmp/index.html?wxbtnGoto=indiana_xlw_product_details_xlp_productId_xld_33'
			gotoPage = '../' + degoto(a.view + '');
		}
		if(a.phone){
			Common.storageL(Common.bindPhone, a.phone);
		}else{
			Common.storageL(Common.bindPhone, '');
		}
		Common.storageL(Common.userId, a.userId);
		Common.storageL(Common.token, a.token);
//		window.open(gotoPage, '_self');
		history.replaceState(null, '主页中转', gotoPage);
		location.reload();
	}else{//未授权，执行授权
		var p1 = a.wxbtnGoto || engoto('weixinmp/home.html'),
			p2 = a.promoter || '0';
		var rediect_uri = Common.domainUrl + '/ushop-api-merchant/api/weixin/user/login/auth/' + p1 + '/' + p2,
			gotourl = 
		 	'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + Common.getAppId() +
			'&redirect_uri=' + decodeURIComponent(rediect_uri) +
			'&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';
		window.open(gotourl, '_self');
	}
}

//解析URL
function deCodeUrlFn(dataStr){
	var str = dataStr || (document.URL + '').split('?')[1];
	if(str){
		var a = {},
			b = str.split('&'),
			i = 0, s;
		while(s = b[i++]){
			s = (s + '').split('=');
			a[s[0]] = s[1];
		}
		return a;
	}
	return {};
}
// 解析拼接goto页面，解析为可用的url地址
function degoto ( str ) {
	str = 	str.replace(/_xlw_/g, '/')
			.replace(/_xlp_/g, '.html?')
			.replace(/_xlj_/g, '.html#')
			.replace(/_xlht_/g, '.html')
			.replace(/_xlhw_/g, '?')
			.replace(/_xlhj_/g, '#')
			.replace(/_xld_/g, '=')
			.replace(/_xll_/g, '&');
	return str;
}
// 编码拼接goto页面，编译为发送到后台的数据字符串
function engoto ( str ) {
str = 	str.replace(/\//g, '_xlw_')
		.replace(/\.html\?/g, '_xlp_')
		.replace(/\.html\#/g, '_xlj_')
		.replace(/\.html/g, '_xlht_')
		.replace(/\?/g, '_xlhw_')
		.replace(/\#/g, '_xlhj_')
		.replace(/\=/g, '_xld_')
		.replace(/\&/g, '_xll_');
	return str;
}
</script>
</body>
</html>
