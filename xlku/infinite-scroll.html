<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      box-sizing: border-box;
    }
    .box {
      width: 300px;
      height: 300px;
      overflow: hidden auto;
      margin: 100px auto;
    }
    .item {
      height: 50px;
      padding: 15px;
    }
  </style>
</head>
<body>
  <div class="box"></div>
  <script>
    let box = document.querySelector('.box');
    class Byy {
      constructor ( box ) {
        this.box = box; // 容器元素
        this.ele = document.createElement('div'); // 放项目的元素
        this.box.appendChild(this.ele);
        this.items = []; // 所有的数据存储位置
        this.ajaxType = 0; // 内部定义，用于确定异步数据请求返回，0表示可以继续下一次请求，1表示正在请求中
        this.itemHeight = 50; // 里面每条项目的高度，暂时无法做到不一致的情况
        this.pageHeight = 300; // 容器的高度
        this.aPageNum = Math.ceil(this.pageHeight/this.itemHeight)*2; // 一页多少条数据，最好是可以沾满两个容器的高度，默认是两个容器的高度
        this.showPage = 3; // 默认显示三页数据最好是不要改动
        this.start = 0; // 显示数据的角标，开始角标
        this.end = this.start + (this.aPageNum*this.showPage); // 显示数据的角标，结束角标

        this.bindScroll();
        if ( this.end > this.items ) {
          this.getItem(this.end).then(items => {
            if ( items && items.length ) {
              this.items = this.items.concat(items);
              this.ele.style.height = (this.items.length*this.itemHeight) + 'px';
              this.render();
            }
          });
        } else {
          this.render();
        }
      }
      bindScroll () {
        let box = this.box;
        let oldTop = box.scrollTop;
        let newTop = oldTop;
        let num21 = 0;
        box.addEventListener('scroll', (e) => {
          newTop = box.scrollTop;
          num21 = (this.end + this.start)*this.itemHeight/2;
          if ( newTop > oldTop ) { // 向下滚动
            if ( newTop > num21 ) {
              if ( this.end + this.aPageNum > this.items.length ) { // 数据不够需要加载
                this.getItem().then(items => {
                  if ( items && items.length ) {
                    this.items = this.items.concat(items);
                    this.ele.style.height = (this.items.length*this.itemHeight) + 'px';
                    this.start += this.aPageNum;
                    this.end = this.start + (this.aPageNum*this.showPage);
                    this.render();
                  }
                });
              } else { // 有足够的数据，无需加载
                this.start += this.aPageNum;
                this.end = this.start + (this.aPageNum*this.showPage);
                this.render();
              }
            }
          } else if ( newTop < oldTop ) { // 向上滚动
            if ( newTop < num21 ) {
              if ( this.start > 0 ) {
                this.start -= this.aPageNum;
                this.start = this.start > 0 ? this.start : 0; // 避免误差
                this.end = this.start + (this.aPageNum*this.showPage);
                this.render();
              }
            }
          }
          oldTop = newTop;
        })
      }
      render () {
        let items = this.items.slice(this.start, this.end);
        let str = items.map(o => `<div class="item">${o.txt}</div>`).join('');
        this.ele.style.paddingTop = (this.start*this.itemHeight) + 'px';
        this.ele.innerHTML = str;
      }
      getItem ( num = this.aPageNum ) {
        if ( this.ajaxType === 0 ) { // 可以执行请求
          this.ajaxType = 1;
          let items = [];
          let lgn = this.items.length;
          for ( let i = 0; i < num; i++ ) {
            items.push({
              id: (lgn + i),
              txt: (lgn + i + 1)
            })
          }
          return new Promise(resolve => {
            setTimeout(() => {
              resolve(items);
              this.ajaxType = 0;
            }, 1000);
          })
        } else if ( this.ajaxType === 1 ) { // 请求中
          return Promise.resolve(1);
        }
      }
    }
    let byy = new Byy(box);
  </script>
</body>
</html>